# è„±å›´æœºåˆ¶

æœ‰äº›ç»„ä»¶å¯èƒ½éœ€è¦æ§åˆ¶å’ŒåŒæ­¥ React ä¹‹å¤–çš„ç³»ç»Ÿã€‚ä¾‹å¦‚ï¼Œä½ å¯èƒ½éœ€è¦ä½¿ç”¨æµè§ˆå™¨ API èšç„¦è¾“å…¥æ¡†ï¼Œæˆ–è€…åœ¨æ²¡æœ‰ React çš„æƒ…å†µä¸‹å®ç°è§†é¢‘æ’­æ”¾å™¨ï¼Œæˆ–è€…è¿æ¥å¹¶ç›‘å¬è¿œç¨‹æœåŠ¡å™¨çš„æ¶ˆæ¯ã€‚åœ¨æœ¬ç« ä¸­ï¼Œä½ å°†å­¦ä¹ åˆ°ä¸€äº›è„±å›´æœºåˆ¶ï¼Œè®©ä½ å¯ä»¥â€œèµ°å‡ºâ€ React å¹¶è¿æ¥åˆ°å¤–éƒ¨ç³»ç»Ÿã€‚å¤§å¤šæ•°åº”ç”¨é€»è¾‘å’Œæ•°æ®æµä¸åº”è¯¥ä¾èµ–è¿™äº›åŠŸèƒ½ã€‚



## ä½¿ç”¨refå¼•ç”¨å€¼

### æ¦‚è¿°

å¦‚æœä½ å¸Œæœ›ç»„ä»¶"è®°ä½"æŸäº›ä¿¡æ¯ï¼Œä½†æ˜¯åˆä¸æƒ³è®©è¿™äº›ä¿¡æ¯ä¿®æ”¹æ—¶è§¦å‘æ¸²æŸ“ï¼Œä½ å¯ä»¥ä½¿ç”¨`ref`ï¼š

ä½¿ç”¨Hook `useRef`è¿›è¡Œå£°æ˜å˜é‡å³å¯

```jsx
import {useRef} from 'react'

// å‚æ•°æ˜¯å”¯ä¸€çš„ï¼Œä»£è¡¨ä½ æƒ³è¦çš„å˜é‡åˆå§‹å€¼
const ref = useRef(0);

// useRefè¿”å›è¿™æ ·ä¸€ä¸ªå¯¹è±¡
{ 
  current: 0 // ä½ å‘ useRef ä¼ å…¥çš„å€¼
}
```

ä¸ state ä¸€æ ·ï¼Œref åœ¨é‡æ–°æ¸²æŸ“ä¹‹é—´ç”± React ä¿ç•™ã€‚ä½†æ˜¯ï¼Œ**è®¾ç½® state ä¼šé‡æ–°æ¸²æŸ“ç»„ä»¶ï¼Œè€Œæ›´æ”¹ ref ä¸ä¼š**ï¼ä½ å¯ä»¥é€šè¿‡ `ref.current` å±æ€§è®¿é—®è¯¥ ref çš„å½“å‰å€¼ï¼ˆ**å¯è¯»å¯æ”¹**ï¼‰ã€‚

å¦‚ä¸‹ä¾‹å­ï¼š

```jsx
import { useRef } from 'react';

export default function Counter() {
  let ref = useRef(0);
  console.log('æ¸²æŸ“äº†')
  function handleClick() {
    ref.current = ref.current + 1;
    alert('ä½ ç‚¹å‡»äº† ' + ref.current + ' æ¬¡!');
  }

  return (
    <button onClick={handleClick}>
      ç‚¹æˆ‘ï¼
    </button>
  );
}
```

è¿è¡Œä»£ç å¯ä»¥å‘ç°åœ¨ç‚¹å‡»äº†æŒ‰é’®ä¹‹åå¹¶ä¸ä¼šæ‰“å° æ¸²æŸ“äº†

è¿™é‡Œçš„ ref æŒ‡å‘ä¸€ä¸ªæ•°å­—ï¼Œä½†æ˜¯ï¼Œåƒ [state](https://zh-hans.react.dev/learn/state-a-components-memory) ä¸€æ ·ï¼Œä½ å¯ä»¥è®©å®ƒ**æŒ‡å‘ä»»ä½•ä¸œè¥¿**ï¼šå­—ç¬¦ä¸²ã€å¯¹è±¡ï¼Œç”šè‡³æ˜¯å‡½æ•°ã€‚ä¸ state ä¸åŒçš„æ˜¯ï¼Œ**ref æ˜¯ä¸€ä¸ªæ™®é€šçš„ JavaScript å¯¹è±¡**ï¼Œå…·æœ‰å¯ä»¥è¢«è¯»å–å’Œä¿®æ”¹çš„ `current` å±æ€§ã€‚

åœ¨å®˜ç½‘ä¸­æœ‰ä¸€ä¸ªç§’è¡¨ä¾‹å­ï¼Œå¯å…·ä½“å‚è€ƒï¼š[ä½¿ç”¨ ref å¼•ç”¨å€¼ â€“ React ä¸­æ–‡æ–‡æ¡£](https://zh-hans.react.dev/learn/referencing-values-with-refs)



###ref VS state

æˆ‘ä»¬å»ºè®®ä½ ä½¿ç”¨ stateã€‚ref æ˜¯ä¸€ç§â€œè„±å›´æœºåˆ¶â€ï¼Œä½ å¹¶ä¸ä¼šç»å¸¸ç”¨åˆ°å®ƒã€‚ ä»¥ä¸‹æ˜¯ state å’Œ ref çš„å¯¹æ¯”ï¼š

| ref                                                         | state                                                        |
| ----------------------------------------------------------- | ------------------------------------------------------------ |
| `useRef(initialValue)`è¿”å› `{ current: initialValue }`      | `useState(initialValue)` è¿”å› state å˜é‡çš„å½“å‰å€¼å’Œä¸€ä¸ª state è®¾ç½®å‡½æ•° ( `[value, setValue]`) |
| æ›´æ”¹æ—¶**ä¸ä¼š**è§¦å‘é‡æ–°æ¸²æŸ“                                  | æ›´æ”¹æ—¶**è§¦å‘**é‡æ–°æ¸²æŸ“ã€‚                                     |
| **å¯å˜** â€”â€” ä½ å¯ä»¥åœ¨æ¸²æŸ“è¿‡ç¨‹ä¹‹å¤–ä¿®æ”¹å’Œæ›´æ–° `current` çš„å€¼ã€‚ | â€œä¸å¯å˜â€ â€”â€” **ä½ å¿…é¡»ä½¿ç”¨ state è®¾ç½®å‡½æ•°**æ¥ä¿®æ”¹ state å˜é‡ï¼Œä»è€Œæ’é˜Ÿé‡æ–°æ¸²æŸ“ã€‚ |
| ä½ **ä¸åº”åœ¨æ¸²æŸ“æœŸé—´è¯»å–ï¼ˆæˆ–å†™å…¥ï¼‰** `current` å€¼ã€‚           | ä½ å¯ä»¥**éšæ—¶è¯»å–** stateã€‚ä½†æ˜¯ï¼Œæ¯æ¬¡æ¸²æŸ“éƒ½æœ‰è‡ªå·±ä¸å˜çš„ state [å¿«ç…§](https://zh-hans.react.dev/learn/state-as-a-snapshot)ã€‚ |

ä¸‹é¢è¿™ä¸ªä¾‹å­å¯ä»¥çœ‹åˆ°ï¼š

```jsx
import { useState } from 'react';

export default function Counter() {
  const [count, setCount] = useState(0);

  function handleClick() {
    setCount(count + 1);
  }

  console.log('æ¸²æŸ“äº†')
  
  return (
    <button onClick={handleClick}>
      ä½ ç‚¹å‡»äº† {count} æ¬¡
    </button>
  );
}

```

```jsx
import { useRef } from 'react';

export default function Counter() {
  let countRef = useRef(0);

  function handleClick() {
    // è¿™æ ·å¹¶æœªé‡æ–°æ¸²æŸ“ç»„ä»¶ï¼
    countRef.current = countRef.current + 1;
  }

  return (
    <button onClick={handleClick}>
      ä½ ç‚¹å‡»äº† {countRef.current} æ¬¡
    </button>
  );
}

```

å¯ä»¥çœ‹åˆ°ä¸¤ä¸ªä¾‹å­åˆ†åˆ«ä½¿ç”¨äº†`state`å’Œ`ref`å­˜å‚¨æˆ‘ä»¬éœ€è¦ç”¨äºæ¸²æŸ“çš„å˜é‡countï¼Œä½†æ˜¯è¿è¡Œä»£ç å‘ç°ä½¿ç”¨`ref`çš„ä¾‹å­ä¸­ï¼Œå¹¶ä¸èƒ½æ­£å¸¸è¿è¡Œï¼Œå› ä¸ºå®ƒå®Œå…¨æ²¡æœ‰è§¦å‘ç»„ä»¶çš„é‡æ–°æ¸²æŸ“

è¿™å°±æ˜¯ä¸ºä»€ä¹ˆåœ¨æ¸²æŸ“æœŸé—´è¯»å– `ref.current` ä¼šå¯¼è‡´ä»£ç ä¸å¯é çš„åŸå› ã€‚å¦‚æœéœ€è¦ï¼Œè¯·æ”¹ç”¨ state

éœ€è¦å¼ºè°ƒçš„æ˜¯ï¼š

React state çš„é™åˆ¶ä¸é€‚ç”¨äº refã€‚ä¾‹å¦‚ï¼Œstate å°±åƒ [æ¯æ¬¡æ¸²æŸ“çš„å¿«ç…§](https://zh-hans.react.dev/learn/state-as-a-snapshot)ï¼Œå¹¶ä¸” [ä¸ä¼šåŒæ­¥æ›´æ–°](https://zh-hans.react.dev/learn/queueing-a-series-of-state-updates)/"ç«‹å³æ›´æ–°"ã€‚ä½†æ˜¯å½“ä½ æ”¹å˜ **ref çš„ current å€¼**æ—¶ï¼Œå®ƒä¼š**ç«‹å³æ”¹å˜**ï¼š

```jsx
ref.current = 5;
console.log(ref.current); // 5
```

è¿™æ˜¯å› ä¸º`ref`æœ¬èº«å°±æ˜¯ä¸€ä¸ªæ™®é€šçš„JavaScriptå¯¹è±¡

> refåŸç†ï¼š
>
> å®é™…ä¸Šï¼Œæˆ‘ä»¬å¯ä»¥æƒ³è±¡`useRef`æ˜¯ç”±`useState`å®ç°çš„
>
> ```jsx
> // React å†…éƒ¨
> function useRef(initialValue) {
>   const [ref, unused] = useState({ current: initialValue });
>   return ref;
> }
> ```
>
> åœ¨è§¦å‘åˆæ¬¡æ¸²æŸ“åï¼ŒuseRefç›´æ¥è¿”å›`{ current: initialValue }`ï¼Œå¹¶ä¸”æ²¡æœ‰ä½¿ç”¨å’Œè¿”å›stateè®¾ç½®å‡½æ•°ï¼Œå› ä¸ºæˆ‘ä»¬çš„refä¸éœ€è¦è§¦å‘æ¸²æŸ“ï¼Œè€Œstateè®¾ç½®å‡½æ•°çš„ä½œç”¨å°±æ˜¯ä¸ºäº†è§¦å‘æ¸²æŸ“



### åº”ç”¨

- å¸¸è§åº”ç”¨ï¼š
  - å­˜å‚¨å®šæ—¶å™¨id
  - å­˜å‚¨DOMå…ƒç´ 
  - æœ‰æ—¶å€™ï¼Œåœ¨ä¸€äº›å¼‚æ­¥æ“ä½œä¸­ï¼Œstateå­˜å‚¨çš„å¿«ç…§ä¸èƒ½æ»¡è¶³æˆ‘ä»¬å®æ—¶çš„éœ€æ±‚ï¼Œrefå¯èƒ½æ˜¯ä¸€ç§é€‰æ‹©
  - ä»¥åŠå…¶ä»–ä¸å½±å“ç»„ä»¶æ¸²æŸ“è¾“å‡ºçš„å¯¹è±¡
- åŸåˆ™ï¼š
  - **å°†refè§†ä¸ºè„±å›´æœºåˆ¶**ï¼šå½“æˆ‘ä»¬ä½¿ç”¨åˆ°å¤–éƒ¨ç³»ç»Ÿæˆ–æµè§ˆå™¨APIæ—¶ï¼Œrefæ˜¯æœ‰ç”¨çš„
  - **ä¸è¦åœ¨æ¸²æŸ“è¿‡ç¨‹ä¸­å¯¹`ref.current`è¿›è¡Œè¯»å†™**ï¼å¦‚æœæ¸²æŸ“è¿‡ç¨‹ä¸­éœ€è¦æŸäº›ä¿¡æ¯ï¼Œè¯·ä½¿ç”¨ [state](https://zh-hans.react.dev/learn/state-a-components-memory) ä»£æ›¿ã€‚ç”±äº React ä¸çŸ¥é“ `ref.current` ä½•æ—¶å‘ç”Ÿå˜åŒ–ï¼Œå³ä½¿åœ¨æ¸²æŸ“æ—¶è¯»å–å®ƒä¹Ÿä¼šä½¿ç»„ä»¶çš„è¡Œä¸ºéš¾ä»¥é¢„æµ‹ã€‚ï¼ˆå”¯ä¸€çš„ä¾‹å¤–æ˜¯åƒ `if (!ref.current) ref.current = new Thing()` è¿™æ ·çš„ä»£ç ï¼Œå®ƒåªåœ¨ç¬¬ä¸€æ¬¡æ¸²æŸ“æœŸé—´è®¾ç½®ä¸€æ¬¡ refã€‚ï¼‰





### refå’ŒDOM

refå¸¸è§çš„ç”¨æ³•æ˜¯è®¿é—®DOMå…ƒç´ ï¼ˆç”¨æ³•ç±»ä¼¼`vue`çš„refæ¨¡æ¿å¼•ç”¨ï¼‰

å½“ä½ å°† ref ä¼ é€’ç»™ JSX ä¸­çš„ `ref` å±æ€§æ—¶ï¼Œæ¯”å¦‚ `<div ref={myRef}>`ï¼ŒReact ä¼šå°†ç›¸åº”çš„ DOM å…ƒç´ æ”¾å…¥ `myRef.current` ä¸­ã€‚å½“å…ƒç´ ä» DOM ä¸­åˆ é™¤æ—¶ï¼ŒReact ä¼šå°† `myRef.current` æ›´æ–°ä¸º `null`ã€‚ä½ å¯ä»¥åœ¨ [ä½¿ç”¨ ref æ“ä½œ DOM](https://zh-hans.react.dev/learn/manipulating-the-dom-with-refs) ä¸­é˜…è¯»æ›´å¤šç›¸å…³ä¿¡æ¯ã€‚







### æ€è€ƒrefå˜é‡ä¸ç»„ä»¶é‡Œçš„æ™®é€šå˜é‡çš„åŒºåˆ«

çœ‹è¿™ä¸ªä¾‹å­ï¼š

```jsx
import { useState } from 'react';

export default function Chat() {
  const [text, setText] = useState('');
  const [isSending, setIsSending] = useState(false);
  let timeoutID = null;

  function handleSend() {
    setIsSending(true);
    timeoutID = setTimeout(() => {
      alert('å·²å‘é€ï¼');
      setIsSending(false);
    }, 3000);
  }

  function handleUndo() {
    setIsSending(false);
    clearTimeout(timeoutID);
  }

  return (
    <>
      <input
        disabled={isSending}
        value={text}
        onChange={e => setText(e.target.value)}
      />
      <button
        disabled={isSending}
        onClick={handleSend}>
        {isSending ? 'å‘é€ä¸­â€¦â€¦' : 'å‘é€'}
      </button>
      {isSending &&
        <button onClick={handleUndo}>
          æ’¤é”€
        </button>
      }
    </>
  );
}

```

è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬å¸Œæœ›çš„åŠŸèƒ½æ˜¯åœ¨ç”¨æˆ·ç‚¹å‡»å‘é€ä¹‹ååœ¨å»¶è¿Ÿ3såalertå‡º å·²å‘é€ ï¼ŒåŒæ—¶åœ¨3så†…ä¼šæ˜¾ç¤ºä¸€ä¸ª æ’¤é”€ æŒ‰é’®ï¼Œå¦‚æœç”¨æˆ·ç‚¹å‡»æ’¤é”€ï¼Œé‚£ä¹ˆå³å¯å–æ¶ˆå®šæ—¶å™¨

åœ¨è¿™ä¸ªéœ€æ±‚ä¸­ï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨ä¸€ä¸ªå˜é‡æ¥å­˜å‚¨å®šæ—¶å™¨IDï¼Œä»¥ä¾¿è¿›è¡Œå­˜å‚¨

å¦‚ä¸Šä»£ç çš„åšæ³•æ˜¯ä½¿ç”¨äº†ä¸€ä¸ªæ™®é€šå˜é‡è¿›è¡Œå­˜å‚¨ï¼Œå®é™…æ•ˆæœå¹¶æ²¡æœ‰å¦‚é¢„æœŸ

è€Œæ˜¯åœ¨ç”¨æˆ·ç‚¹å‡»äº†æ’¤é”€æŒ‰é’®åï¼Œä»ç„¶alert å·²å‘é€

åŸå› ï¼š

- æ™®é€šå˜é‡å¹¶ä¸ä¼šåœ¨æ¯ä¸€æ¬¡Reactç»„ä»¶çš„æ¸²æŸ“ä¸­å­˜æ´»
- åœ¨ä»£ç ä¸­ï¼Œå½“æˆ‘ä»¬ç‚¹å‡»äº†æ’¤é”€æŒ‰é’®ï¼Œä½¿ç”¨äº†stateçš„è®¾ç½®å‡½æ•°ï¼Œè§¦å‘äº†Reactçš„æ¸²æŸ“ï¼Œå› æ­¤æ™®é€šå˜é‡çš„å€¼ä¹Ÿå°±ä¸å­˜åœ¨äº†/æ²¡æœ‰å­˜å‚¨åˆ°æƒ³è¦çš„å†…å®¹äº†

æ­£ç¡®åšæ³•è¿˜æ˜¯é€‰æ‹©ä½¿ç”¨refï¼Œå› ä¸º**refä¹Ÿæ˜¯ä¸€ä¸ªç‰¹æ®Šçš„stateå¯ä»¥åœ¨æ¸²æŸ“ä¸­å­˜æ´»ä¸‹æ¥ï¼Œå´ä¸ä¼šè§¦å‘æ¸²æŸ“**



## ä½¿ç”¨refæ“ä½œDOM

 React ä¼šè‡ªåŠ¨å¤„ç†æ›´æ–° [DOM](https://developer.mozilla.org/docs/Web/API/Document_Object_Model/Introduction) ä»¥åŒ¹é…ä½ çš„æ¸²æŸ“è¾“å‡ºï¼Œå› æ­¤ä½ åœ¨ç»„ä»¶ä¸­é€šå¸¸ä¸éœ€è¦æ“ä½œ DOMã€‚ä½†æ˜¯ï¼Œæœ‰æ—¶ä½ å¯èƒ½éœ€è¦è®¿é—®ç”± React ç®¡ç†çš„ DOM å…ƒç´  â€”â€” ä¾‹å¦‚ï¼Œè®©ä¸€ä¸ªèŠ‚ç‚¹è·å¾—ç„¦ç‚¹ã€æ»šåŠ¨åˆ°å®ƒæˆ–æµ‹é‡å®ƒçš„å°ºå¯¸å’Œä½ç½®ã€‚åœ¨ React ä¸­æ²¡æœ‰å†…ç½®çš„æ–¹æ³•æ¥åšè¿™äº›äº‹æƒ…ï¼Œæ‰€ä»¥ä½ éœ€è¦ä¸€ä¸ªæŒ‡å‘ DOM èŠ‚ç‚¹çš„ **ref** æ¥å®ç°



### è·å–æŒ‡å®šèŠ‚ç‚¹çš„ref

ç”¨æ³•ä¸Šä¸vueçš„refæ¨¡æ¿å¼•ç”¨ç±»ä¼¼çš„

è¦è®¿é—®ç”± React ç®¡ç†çš„ DOM èŠ‚ç‚¹ï¼Œé¦–å…ˆï¼Œå¼•å…¥ `useRef` Hookï¼š

```jsx
import { useRef } from 'react';
```

ç„¶åï¼Œåœ¨ä½ çš„ç»„ä»¶ä¸­ä½¿ç”¨å®ƒå£°æ˜ä¸€ä¸ª refï¼š

```jsx
const myRef = useRef(null);
```

æœ€åï¼Œå°† ref ä½œä¸º `ref` å±æ€§å€¼ä¼ é€’ç»™æƒ³è¦è·å–çš„ DOM èŠ‚ç‚¹çš„ JSX æ ‡ç­¾ï¼š

```jsx
<div ref={myRef}>
```

è¿™æ ·æˆ‘ä»¬çš„`myRef.current`ä¸­å°±å­˜å‚¨äº†è¯¥èŠ‚ç‚¹çš„å¼•ç”¨äº†

```jsx
// ä½ å¯ä»¥ä½¿ç”¨ä»»æ„æµè§ˆå™¨ APIï¼Œä¾‹å¦‚ï¼š
myRef.current.scrollIntoView();
```

å…·ä½“DOMæ“ä½œä¾‹å­å¯ä»¥æŸ¥çœ‹[ä½¿ç”¨ ref æ“ä½œ DOM â€“ React ä¸­æ–‡æ–‡æ¡£](https://zh-hans.react.dev/learn/manipulating-the-dom-with-refs)





### åˆ—è¡¨æ•°æ®ç»‘å®šref

æœ‰æ—¶å€™ï¼Œåœ¨ä¸€ä¸ªåˆ—è¡¨æ•°æ®ä¸­ï¼Œæˆ‘ä»¬éœ€è¦ä¸ºå…¶æ¯ä¸€é¡¹éƒ½ç»‘å®šrefï¼Œåƒè¿™ä¹ˆåšæ˜¯ä¸è¡Œçš„

```jsx
<ul>
  {items.map((item) => {
    // è¡Œä¸é€šï¼
    const ref = useRef(null);
    return <li ref={ref} />;
  })}
</ul>
```

è¿™æ˜¯å› ä¸º **Hook åªèƒ½åœ¨ç»„ä»¶çš„é¡¶å±‚è¢«è°ƒç”¨**ã€‚ä¸èƒ½åœ¨å¾ªç¯è¯­å¥ã€æ¡ä»¶è¯­å¥æˆ– `map()` å‡½æ•°ä¸­è°ƒç”¨ `useRef` ã€‚

- è§£å†³æ–¹æ¡ˆï¼š
  - ä½¿ç”¨refå¼•ç”¨å…¶çˆ¶å…ƒç´ ï¼Œå†ä½¿ç”¨DOMæ–¹æ³•`querySelectorAll`æ¥å¯»æ‰¾å…¶å­èŠ‚ç‚¹ï¼Œä½†æ˜¯å¦‚æœDOMç»“æ„å˜åŒ–ï¼Œå¯èƒ½ä¼šå¤±æ•ˆæˆ–æŠ¥é”™ã€‚
  - å°†å‡½æ•°ä¼ é€’ç»™refå±æ€§ï¼Œè¿™å«`refå›è°ƒ`ï¼Œå½“éœ€è¦è®¾ç½® ref æ—¶ï¼ŒReact å°†ä¼ å…¥ DOM èŠ‚ç‚¹æ¥è°ƒç”¨ä½ çš„ ref å›è°ƒï¼Œå¹¶åœ¨éœ€è¦æ¸…é™¤å®ƒæ—¶ä¼ å…¥ `null` ã€‚è¿™ä½¿ä½ å¯ä»¥ç»´æŠ¤è‡ªå·±çš„æ•°ç»„æˆ– [Map](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Map)ï¼Œå¹¶é€šè¿‡å…¶ç´¢å¼•æˆ–æŸç§ç±»å‹çš„ ID è®¿é—®ä»»ä½• refã€‚

ç¤ºä¾‹ï¼š

```jsx
import { useRef } from 'react';

export default function CatFriends() {
  const itemsRef = useRef(null);

  function scrollToId(itemId) {
    const map = getMap();
    const node = map.get(itemId);
    node.scrollIntoView({
      behavior: 'smooth',
      block: 'nearest',
      inline: 'center'
    });
  }

  function getMap() {
    if (!itemsRef.current) {
      // é¦–æ¬¡è¿è¡Œæ—¶åˆå§‹åŒ– Mapã€‚
      itemsRef.current = new Map();
    }
    return itemsRef.current;
  }

  return (
    <>
      <nav>
        <button onClick={() => scrollToId(0)}>
          Tom
        </button>
        <button onClick={() => scrollToId(5)}>
          Maru
        </button>
        <button onClick={() => scrollToId(9)}>
          Jellylorum
        </button>
      </nav>
      <div>
        <ul>
          {catList.map(cat => (
            <li
              key={cat.id}
              ref={(node) => {
                const map = getMap();
                if (node) {
                  map.set(cat.id, node);
                } else {
                  map.delete(cat.id);
                }
              }}
            >
              <img
                src={cat.imageUrl}
                alt={'Cat #' + cat.id}
              />
            </li>
          ))}
        </ul>
      </div>
    </>
  );
}

const catList = [];
for (let i = 0; i < 10; i++) {
  catList.push({
    id: i,
    imageUrl: 'https://placekitten.com/250/200?image=' + i
  });
}

```

åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œ`itemsRef`ä¿å­˜çš„ä¸æ˜¯å•ä¸ªDOMèŠ‚ç‚¹ï¼Œè€Œæ˜¯åŒ…å«åˆ—è¡¨é¡¹IDå’ŒDOMèŠ‚ç‚¹çš„Mapï¼Œæ¯ä¸ªåˆ—è¡¨é¡¹ä¸Šçš„refå›è°ƒä¼šæ›´æ–°Mapï¼Œè¿™ä½¿ä½ å¯ä»¥ä¹‹åä» Map è¯»å–å•ä¸ª DOM èŠ‚ç‚¹ã€‚





### è®¿é—®ç»„ä»¶çš„DOMèŠ‚ç‚¹

å½“æˆ‘ä»¬å°†refæ”¾åœ¨ä¸€ä¸ªç»„ä»¶ä¸Šæ—¶ï¼Œæ­¤æ—¶ç»‘å®šå¾—åˆ°çš„refå˜é‡å€¼ä¸º`null`ï¼ï¼ï¼

å‘ç”Ÿè¿™ç§æƒ…å†µæ˜¯å› ä¸ºé»˜è®¤æƒ…å†µä¸‹ï¼ŒR**eact ä¸å…è®¸ç»„ä»¶è®¿é—®å…¶ä»–ç»„ä»¶çš„ DOM èŠ‚ç‚¹**ã€‚ç”šè‡³è‡ªå·±çš„å­ç»„ä»¶ä¹Ÿä¸è¡Œï¼è¿™æ˜¯æ•…æ„çš„ã€‚Refs æ˜¯ä¸€ç§è„±å›´æœºåˆ¶ï¼Œåº”è¯¥è°¨æ…ä½¿ç”¨ã€‚æ‰‹åŠ¨æ“ä½œ **å¦ä¸€ä¸ª** ç»„ä»¶çš„ DOM èŠ‚ç‚¹ä¼šä½¿ä½ çš„ä»£ç æ›´åŠ è„†å¼±ã€‚

å¦‚æœæƒ³è¦è¿™ä¹ˆåšï¼Œéœ€è¦éµå¾ªå¦‚ä¸‹æ­¥éª¤ï¼š

1. ç»„ä»¶å…è®¸è‡ªå·±çš„refè¢«è®¿é—®ï¼ˆä½¿ç”¨`forwardRef`APIï¼‰

   ```jsx
   const MyInput = forwardRef((props, ref) => {
     return <input {...props} ref={ref} />;
   });
   ```

2. å¤–éƒ¨ç»„ä»¶ä½¿ç”¨refå±æ€§ç»‘å®šrefå˜é‡

å®ƒæ˜¯è¿™æ ·å·¥ä½œçš„:

1. `<MyInput ref={inputRef} />` å‘Šè¯‰ React å°†å¯¹åº”çš„ DOM èŠ‚ç‚¹æ”¾å…¥ `inputRef.current` ä¸­ã€‚ä½†æ˜¯ï¼Œè¿™å–å†³äº `MyInput` ç»„ä»¶æ˜¯å¦å…è®¸è¿™ç§è¡Œä¸ºï¼Œ é»˜è®¤æƒ…å†µä¸‹æ˜¯ä¸å…è®¸çš„ã€‚
2. `MyInput` ç»„ä»¶æ˜¯ä½¿ç”¨ `forwardRef` å£°æ˜çš„ã€‚ **è¿™è®©ä»ä¸Šé¢æ¥æ”¶çš„ inputRef ä½œä¸ºç¬¬äºŒä¸ªå‚æ•° ref ä¼ å…¥ç»„ä»¶**ï¼Œç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ `props` ã€‚
3. `MyInput` ç»„ä»¶å°†è‡ªå·±æ¥æ”¶åˆ°çš„ `ref` ä¼ é€’ç»™å®ƒå†…éƒ¨çš„ `<input>`ã€‚

```jsx
import { forwardRef, useRef } from 'react';

const MyInput = forwardRef((props, ref) => {
  return <input {...props} ref={ref} />;
});

export default function Form() {
  const inputRef = useRef(null);

  function handleClick() {
    inputRef.current.focus();
  }

  return (
    <>
      <MyInput ref={inputRef} />
      <button onClick={handleClick}>
        èšç„¦è¾“å…¥æ¡†
      </button>
    </>
  );
}

```

åœ¨è®¾è®¡ç³»ç»Ÿä¸­ï¼Œå°†ä½çº§ç»„ä»¶ï¼ˆå¦‚æŒ‰é’®ã€è¾“å…¥æ¡†ç­‰ï¼‰çš„ ref è½¬å‘åˆ°å®ƒä»¬çš„ DOM èŠ‚ç‚¹æ˜¯ä¸€ç§å¸¸è§æ¨¡å¼ã€‚å¦ä¸€æ–¹é¢ï¼Œåƒè¡¨å•ã€åˆ—è¡¨æˆ–é¡µé¢æ®µè½è¿™æ ·çš„é«˜çº§ç»„ä»¶é€šå¸¸ä¸ä¼šæš´éœ²å®ƒä»¬çš„ DOM èŠ‚ç‚¹ï¼Œä»¥é¿å…å¯¹ DOM ç»“æ„çš„æ„å¤–ä¾èµ–ã€‚

> é™åˆ¶ç»„ä»¶æš´éœ²çš„å†…å®¹ï¼š
>
> åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œ`MyInput` æš´éœ²äº†åŸå§‹çš„ DOM å…ƒç´  inputã€‚è¿™è®©çˆ¶ç»„ä»¶å¯ä»¥å¯¹å…¶è°ƒç”¨`focus()`ã€‚ç„¶è€Œï¼Œè¿™ä¹Ÿè®©çˆ¶ç»„ä»¶èƒ½å¤Ÿåšå…¶ä»–äº‹æƒ… â€”â€” ä¾‹å¦‚ï¼Œæ”¹å˜å…¶ CSS æ ·å¼
>
> åœ¨ä¸€äº›ä¸å¸¸è§çš„æƒ…å†µä¸‹ï¼Œä½ å¯èƒ½å¸Œæœ›é™åˆ¶æš´éœ²çš„åŠŸèƒ½ã€‚ä½ å¯ä»¥ç”¨ `useImperativeHandle` åšåˆ°è¿™ä¸€ç‚¹ï¼š
>
> ```jsx
> import {
>   forwardRef, 
>   useRef, 
>   useImperativeHandle
> } from 'react';
>
> const MyInput = forwardRef((props, ref) => {
>   const realInputRef = useRef(null);
>   useImperativeHandle(ref, () => ({
>     // åªæš´éœ² focusï¼Œæ²¡æœ‰åˆ«çš„
>     focus() {
>       realInputRef.current.focus();
>     },
>   }));
>   return <input {...props} ref={realInputRef} />;
> });
>
> export default function Form() {
>   const inputRef = useRef(null);
>
>   function handleClick() {
>     inputRef.current.focus();
>   }
>
>   return (
>     <>
>       <MyInput ref={inputRef} />
>       <button onClick={handleClick}>
>         èšç„¦è¾“å…¥æ¡†
>       </button>
>     </>
>   );
> }
>
> ```
>
> è¿™é‡Œï¼Œ`MyInput` ä¸­çš„ `realInputRef` ä¿å­˜äº†å®é™…çš„ input DOM èŠ‚ç‚¹ã€‚ ä½†æ˜¯ï¼Œ`useImperativeHandle` æŒ‡ç¤º React å°†ä½ è‡ªå·±æŒ‡å®šçš„å¯¹è±¡ä½œä¸ºçˆ¶ç»„ä»¶çš„ ref å€¼ã€‚ æ‰€ä»¥ `Form` ç»„ä»¶å†…çš„ `inputRef.current` å°†åªæœ‰ `focus` æ–¹æ³•









##  ä½¿ç”¨EffectåŒæ­¥

æœ‰äº›ç»„ä»¶éœ€è¦ä¸å¤–éƒ¨ç³»ç»ŸåŒæ­¥ã€‚ä¾‹å¦‚ï¼Œä½ å¯èƒ½å¸Œæœ›æ ¹æ® React state æ§åˆ¶é React ç»„ä»¶ã€è®¾ç½®æœåŠ¡å™¨è¿æ¥æˆ–åœ¨ç»„ä»¶å‡ºç°åœ¨å±å¹•ä¸Šæ—¶å‘é€åˆ†ææ—¥å¿—ã€‚**Effects ä¼šåœ¨æ¸²æŸ“åè¿è¡Œä¸€äº›ä»£ç **ï¼Œä»¥ä¾¿å¯ä»¥å°†ç»„ä»¶ä¸ React ä¹‹å¤–çš„æŸäº›ç³»ç»ŸåŒæ­¥ã€‚



### ä»€ä¹ˆæ˜¯Effectï¼Œå®ƒä¸äº‹ä»¶ï¼ˆeventï¼‰æœ‰ä½•ä¸åŒ

åœ¨è°ˆåˆ° Effect ä¹‹å‰ï¼Œä½ éœ€è¦ç†Ÿæ‚‰ React ç»„ä»¶ä¸­çš„ä¸¤ç§é€»è¾‘ç±»å‹ï¼š

- **æ¸²æŸ“é€»è¾‘ä»£ç **ï¼ˆåœ¨ [æè¿° UI](https://zh-hans.react.dev/learn/describing-the-ui) ä¸­æœ‰ä»‹ç»ï¼‰ä½äºç»„ä»¶çš„é¡¶å±‚ã€‚ä½ å°†åœ¨è¿™é‡Œæ¥æ”¶ props å’Œ stateï¼Œå¹¶å¯¹å®ƒä»¬è¿›è¡Œè½¬æ¢ï¼Œæœ€ç»ˆè¿”å›ä½ æƒ³åœ¨å±å¹•ä¸Šçœ‹åˆ°çš„ JSXã€‚[æ¸²æŸ“çš„ä»£ç å¿…é¡»æ˜¯çº¯ç²¹çš„](https://zh-hans.react.dev/learn/keeping-components-pure)â€”â€”å°±åƒæ•°å­¦å…¬å¼ä¸€æ ·ï¼Œå®ƒåªåº”è¯¥â€œè®¡ç®—â€ç»“æœï¼Œè€Œä¸åšå…¶ä»–ä»»ä½•äº‹æƒ…ã€‚
- **äº‹ä»¶å¤„ç†ç¨‹åº**ï¼ˆåœ¨ [æ·»åŠ äº¤äº’æ€§](https://zh-hans.react.dev/learn/adding-interactivity) ä¸­ä»‹ç»ï¼‰æ˜¯åµŒå¥—åœ¨ç»„ä»¶å†…éƒ¨çš„å‡½æ•°ï¼Œè€Œä¸ä»…ä»…æ˜¯è®¡ç®—å‡½æ•°ã€‚äº‹ä»¶å¤„ç†ç¨‹åºå¯èƒ½ä¼šæ›´æ–°è¾“å…¥å­—æ®µã€æäº¤ HTTP POST è¯·æ±‚ä»¥è´­ä¹°äº§å“ï¼Œæˆ–è€…å°†ç”¨æˆ·å¯¼èˆªåˆ°å¦ä¸€ä¸ªå±å¹•ã€‚äº‹ä»¶å¤„ç†ç¨‹åºåŒ…å«ç”±ç‰¹å®šç”¨æˆ·æ“ä½œï¼ˆä¾‹å¦‚æŒ‰é’®ç‚¹å‡»æˆ–é”®å…¥ï¼‰å¼•èµ·çš„â€œå‰¯ä½œç”¨â€ï¼ˆå®ƒä»¬æ”¹å˜äº†ç¨‹åºçš„çŠ¶æ€ï¼‰ï¼ˆäº‹ä»¶å¤„ç†å‡½æ•°ä¸ä¼šåœ¨æ¸²æŸ“æ—¶æ‰§è¡Œå› æ­¤åŒ…å«å‰¯ä½œç”¨ä¹Ÿæ— å¦¨ï¼‰ã€‚

æœ‰æ—¶è¿™è¿˜ä¸å¤Ÿã€‚è€ƒè™‘ä¸€ä¸ª `ChatRoom` ç»„ä»¶ï¼Œå®ƒåœ¨å±å¹•ä¸Šå¯è§æ—¶å¿…é¡»è¿æ¥åˆ°èŠå¤©æœåŠ¡å™¨ã€‚è¿æ¥åˆ°æœåŠ¡å™¨ä¸æ˜¯ä¸€ä¸ªçº¯è®¡ç®—ï¼ˆå®ƒåŒ…å«å‰¯ä½œç”¨ï¼‰ï¼Œå› æ­¤å®ƒä¸èƒ½åœ¨æ¸²æŸ“è¿‡ç¨‹ä¸­å‘ç”Ÿã€‚ç„¶è€Œï¼Œå¹¶æ²¡æœ‰ä¸€ä¸ªç‰¹å®šçš„äº‹ä»¶ï¼ˆæ¯”å¦‚ç‚¹å‡»ï¼‰å¯¼è‡´ `ChatRoom` è¢«æ˜¾ç¤ºã€‚

**Effect å…è®¸ä½ æŒ‡å®šç”±æ¸²æŸ“æœ¬èº«ï¼Œè€Œä¸æ˜¯ç‰¹å®šäº‹ä»¶å¼•èµ·çš„å‰¯ä½œç”¨**ã€‚åœ¨èŠå¤©ä¸­å‘é€æ¶ˆæ¯æ˜¯ä¸€ä¸ªâ€œäº‹ä»¶â€ï¼Œå› ä¸ºå®ƒç›´æ¥ç”±ç”¨æˆ·ç‚¹å‡»ç‰¹å®šæŒ‰é’®å¼•èµ·ã€‚ç„¶è€Œï¼Œå»ºç«‹æœåŠ¡å™¨è¿æ¥æ˜¯ Effectï¼Œå› ä¸ºå®ƒåº”è¯¥å‘ç”Ÿæ— è®ºå“ªç§äº¤äº’å¯¼è‡´ç»„ä»¶å‡ºç°ã€‚Effect åœ¨å±å¹•æ›´æ–°åçš„ [æäº¤é˜¶æ®µ](https://zh-hans.react.dev/learn/render-and-commit) è¿è¡Œã€‚è¿™æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„æ—¶æœºï¼Œå¯ä»¥å°† React ç»„ä»¶ä¸æŸä¸ªå¤–éƒ¨ç³»ç»Ÿï¼ˆå¦‚ç½‘ç»œæˆ–ç¬¬ä¸‰æ–¹åº“ï¼‰åŒæ­¥ã€‚

> æ³¨æ„ï¼š
>
> åœ¨æœ¬æ–‡å’Œåç»­æ–‡æœ¬ä¸­ï¼Œ`Effect` åœ¨ React ä¸­æ˜¯ä¸“æœ‰å®šä¹‰â€”â€”ç”±æ¸²æŸ“å¼•èµ·çš„å‰¯ä½œç”¨ã€‚ä¸ºäº†æŒ‡ä»£æ›´å¹¿æ³›çš„ç¼–ç¨‹æ¦‚å¿µï¼Œä¹Ÿå¯ä»¥å°†å…¶ç§°ä¸ºâ€œå‰¯ä½œç”¨ï¼ˆside effectï¼‰â€ã€‚
>
> ä½ å¯èƒ½ä¸éœ€è¦Effectï¼š
>
> **ä¸è¦éšæ„åœ¨ä½ çš„ç»„ä»¶ä¸­ä½¿ç”¨ Effect**ã€‚è®°ä½ï¼ŒEffect é€šå¸¸ç”¨äºæš‚æ—¶â€œè·³å‡ºâ€ React ä»£ç å¹¶ä¸ä¸€äº› **å¤–éƒ¨** ç³»ç»Ÿè¿›è¡ŒåŒæ­¥ã€‚è¿™åŒ…æ‹¬æµè§ˆå™¨ APIã€ç¬¬ä¸‰æ–¹å°éƒ¨ä»¶ï¼Œä»¥åŠç½‘ç»œç­‰ç­‰ã€‚å¦‚æœä½ æƒ³ç”¨ Effect ä»…æ ¹æ®å…¶ä»–çŠ¶æ€è°ƒæ•´æŸäº›çŠ¶æ€ï¼Œé‚£ä¹ˆ [ä½ å¯èƒ½ä¸éœ€è¦ Effect](https://zh-hans.react.dev/learn/you-might-not-need-an-effect)ã€‚



### å¦‚ä½•ç¼–å†™Effect

ç¼–å†™ Effect éœ€è¦éµå¾ªä»¥ä¸‹ä¸‰ä¸ªè§„åˆ™ï¼š

1. **å£°æ˜ Effect**ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼ŒEffect ä¼šåœ¨æ¯æ¬¡ [commit](https://zh-hans.react.dev/learn/render-and-commit) ï¼ˆ**æ¸²æŸ“**ï¼‰åéƒ½ä¼šæ‰§è¡Œã€‚
2. **æŒ‡å®š Effect ä¾èµ–**ã€‚å¤§å¤šæ•° Effect åº”è¯¥æŒ‰éœ€æ‰§è¡Œï¼Œè€Œä¸æ˜¯åœ¨æ¯æ¬¡æ¸²æŸ“åéƒ½æ‰§è¡Œã€‚ä¾‹å¦‚ï¼Œæ·¡å…¥åŠ¨ç”»åº”è¯¥åªåœ¨ç»„ä»¶å‡ºç°æ—¶è§¦å‘ã€‚è¿æ¥å’Œæ–­å¼€æœåŠ¡å™¨çš„æ“ä½œåªåº”åœ¨ç»„ä»¶å‡ºç°å’Œæ¶ˆå¤±æ—¶ï¼Œæˆ–è€…åˆ‡æ¢èŠå¤©å®¤æ—¶æ‰§è¡Œã€‚æ–‡ç« å°†ä»‹ç»å¦‚ä½•é€šè¿‡æŒ‡å®šä¾èµ–æ¥æ§åˆ¶å¦‚ä½•æŒ‰éœ€æ‰§è¡Œã€‚
3. **å¿…è¦æ—¶æ·»åŠ æ¸…ç†ï¼ˆcleanupï¼‰å‡½æ•°**ã€‚æœ‰æ—¶ Effect éœ€è¦æŒ‡å®šå¦‚ä½•åœæ­¢ã€æ’¤é”€ï¼Œæˆ–è€…æ¸…é™¤å®ƒçš„æ•ˆæœã€‚ä¾‹å¦‚ï¼Œâ€œè¿æ¥â€æ“ä½œéœ€è¦â€œæ–­è¿â€ï¼Œâ€œè®¢é˜…â€éœ€è¦â€œé€€è®¢â€ï¼Œâ€œè·å–â€æ—¢éœ€è¦â€œå–æ¶ˆâ€ä¹Ÿéœ€è¦â€œå¿½ç•¥â€ã€‚ä½ å°†å­¦ä¹ å¦‚ä½•ä½¿ç”¨ **æ¸…ç†å‡½æ•°** æ¥åšåˆ°è¿™ä¸€åˆ‡ã€‚

ä»¥ä¸‹æ˜¯å…·ä½“æ­¥éª¤ï¼š



#### å£°æ˜Effect

é¦–å…ˆåœ¨ React ä¸­å¼•å…¥ [`useEffect` Hook](https://zh-hans.react.dev/reference/react/useEffect)ï¼š

```js
import { useEffect } from 'react';
```

ç„¶åï¼Œåœ¨ç»„ä»¶é¡¶éƒ¨è°ƒç”¨å®ƒï¼Œå¹¶ä¼ å…¥åœ¨æ¯æ¬¡æ¸²æŸ“æ—¶éƒ½éœ€è¦æ‰§è¡Œçš„ä»£ç ï¼š

```js
function MyComponent() {

  useEffect(() => {

    // æ¯æ¬¡æ¸²æŸ“åéƒ½ä¼šæ‰§è¡Œæ­¤å¤„çš„ä»£ç 

  });

  return <div />;

}
```

æ¯å½“ä½ çš„ç»„ä»¶æ¸²æŸ“æ—¶ï¼ŒReact å°†æ›´æ–°å±å¹•ï¼Œç„¶åè¿è¡Œ `useEffect` ä¸­çš„ä»£ç ã€‚æ¢å¥è¯è¯´ï¼Œ**useEffect ä¼šæŠŠè¿™æ®µä»£ç æ”¾åˆ°å±å¹•æ›´æ–°æ¸²æŸ“ä¹‹åæ‰§è¡Œ**ã€‚

è®©æˆ‘ä»¬çœ‹çœ‹å¦‚ä½•ä½¿ç”¨ Effect ä¸å¤–éƒ¨ç³»ç»ŸåŒæ­¥ã€‚è€ƒè™‘ä¸€ä¸ª `<VideoPlayer>` React ç»„ä»¶ã€‚é€šè¿‡ä¼ é€’å¸ƒå°”ç±»å‹çš„ `isPlaying` prop ä»¥æ§åˆ¶æ˜¯æ’­æ”¾è¿˜æ˜¯æš‚åœï¼š

```js
<VideoPlayer isPlaying={isPlaying} />;
```

è‡ªå®šä¹‰çš„ `VideoPlayer` ç»„ä»¶æ¸²æŸ“äº†å†…ç½®çš„ [`video`](https://developer.mozilla.org/zh-CN/docs/Web/HTML/Element/video) æ ‡ç­¾ï¼š

```js
function VideoPlayer({ src, isPlaying }) {

  // TODOï¼šä½¿ç”¨ isPlaying åšä¸€äº›äº‹æƒ…

  return <video src={src} />;

}
```

ä½†æ˜¯ï¼Œæµè§ˆå™¨çš„ `<video>` æ ‡ç­¾æ²¡æœ‰ `isPlaying` å±æ€§ã€‚æ§åˆ¶å®ƒçš„å”¯ä¸€æ–¹å¼æ˜¯åœ¨ DOM å…ƒç´ ä¸Šè°ƒç”¨ [`play()`](https://developer.mozilla.org/zh-CN/docs/Web/API/HTMLMediaElement/play) å’Œ [`pause()`](https://developer.mozilla.org/zh-CN/docs/Web/API/HTMLMediaElement/pause) æ–¹æ³•ã€‚å› æ­¤ï¼Œ**ä½ éœ€è¦å°† isPlaying prop çš„å€¼ä¸ play() å’Œ pause() ç­‰å‡½æ•°çš„è°ƒç”¨è¿›è¡ŒåŒæ­¥ï¼Œè¯¥å±æ€§ç”¨äºå‘ŠçŸ¥å½“å‰è§†é¢‘æ˜¯å¦åº”è¯¥æ’­æ”¾**ã€‚

é¦–å…ˆè¦è·å– `<video>`  DOM èŠ‚ç‚¹çš„ [å¯¹è±¡å¼•ç”¨](https://zh-hans.react.dev/learn/manipulating-the-dom-with-refs)ã€‚

ä½ å¯èƒ½ä¼šå°è¯•åœ¨æ¸²æŸ“æœŸé—´è°ƒç”¨ `play()` æˆ– `pause()`ï¼Œä½†è¿™ç§åšæ³•æ˜¯é”™çš„ï¼š

```jsx
import { useState, useRef, useEffect } from 'react';

function VideoPlayer({ src, isPlaying }) {
  const ref = useRef(null);

  if (isPlaying) {
    ref.current.play();  // æ¸²æŸ“æœŸé—´ä¸èƒ½è°ƒç”¨ `play()`ã€‚ 
  } else {
    ref.current.pause(); // åŒæ ·ï¼Œè°ƒç”¨ `pause()` ä¹Ÿä¸è¡Œã€‚
  }

  return <video ref={ref} src={src} loop playsInline />;
}

export default function App() {
  const [isPlaying, setIsPlaying] = useState(false);
  return (
    <>
      <button onClick={() => setIsPlaying(!isPlaying)}>
        {isPlaying ? 'æš‚åœ' : 'æ’­æ”¾'}
      </button>
      <VideoPlayer
        isPlaying={isPlaying}
        src="https://interactive-examples.mdn.mozilla.net/media/cc0-videos/flower.mp4"
      />
    </>
  );
}
```

è¿™æ®µä»£ç ä¹‹æ‰€ä»¥ä¸æ­£ç¡®ï¼Œæ˜¯å› ä¸ºå®ƒè¯•å›¾åœ¨æ¸²æŸ“æœŸé—´å¯¹ DOM èŠ‚ç‚¹è¿›è¡Œæ“ä½œã€‚åœ¨ React ä¸­ï¼Œ[JSX çš„æ¸²æŸ“å¿…é¡»æ˜¯çº¯ç²¹æ“ä½œ](https://zh-hans.react.dev/learn/keeping-components-pure)ï¼Œä¸åº”è¯¥åŒ…å«ä»»ä½•åƒä¿®æ”¹ DOM çš„å‰¯ä½œç”¨ã€‚

è€Œä¸”ï¼Œå½“ç¬¬ä¸€æ¬¡è°ƒç”¨ `VideoPlayer` æ—¶ï¼Œå¯¹åº”çš„ DOM èŠ‚ç‚¹ç”šè‡³è¿˜ä¸å­˜åœ¨ï¼å¦‚æœè¿ DOM èŠ‚ç‚¹éƒ½æ²¡æœ‰ï¼Œé‚£ä¹ˆå¦‚ä½•è°ƒç”¨ `play()` æˆ– `pause()` æ–¹æ³•å‘¢ï¼åœ¨è¿”å› JSX ä¹‹å‰ï¼ŒReact ä¸çŸ¥é“è¦åˆ›å»ºä»€ä¹ˆ DOMã€‚

è§£å†³åŠæ³•æ˜¯ **ä½¿ç”¨ useEffect åŒ…è£¹å‰¯ä½œç”¨ï¼ŒæŠŠå®ƒåˆ†ç¦»åˆ°æ¸²æŸ“é€»è¾‘çš„è®¡ç®—è¿‡ç¨‹ä¹‹å¤–**ï¼š

```jsx
import { useEffect, useRef } from 'react';

function VideoPlayer({ src, isPlaying }) {
  const ref = useRef(null);

  useEffect(() => {
    if (isPlaying) {
      ref.current.play();
    } else {
      ref.current.pause();
    }
  });

  return <video ref={ref} src={src} loop playsInline />;
}
```

å½“ `VideoPlayer` ç»„ä»¶æ¸²æŸ“æ—¶ï¼ˆæ— è®ºæ˜¯å¦ä¸ºé¦–æ¬¡æ¸²æŸ“ï¼‰ï¼Œéƒ½ä¼šå‘ç”Ÿä»¥ä¸‹äº‹æƒ…ã€‚é¦–å…ˆï¼ŒReact ä¼šåˆ·æ–°å±å¹•ï¼Œç¡®ä¿ `<video>` å…ƒç´ å·²ç»æ­£ç¡®åœ°å‡ºç°åœ¨ DOM ä¸­ï¼›ç„¶åï¼ŒReact å°†è¿è¡Œ Effectï¼›æœ€åï¼ŒEffect å°†æ ¹æ® `isPlaying` çš„å€¼è°ƒç”¨ `play()` æˆ– `pause()`ã€‚

> é™·é˜±ï¼š
>
> > 
>
> ä¸€èˆ¬æ¥è¯´ï¼ŒEffect ä¼šåœ¨  **æ¯æ¬¡** æ¸²æŸ“åæ‰§è¡Œï¼Œ**è€Œä»¥ä¸‹ä»£ç ä¼šé™·å…¥æ­»å¾ªç¯ä¸­**ï¼š
>
> ```js
> const [count, setCount] = useState(0);
>
> useEffect(() => {
>
>   setCount(count + 1);
>
> });
> ```
>
> æ¯æ¬¡æ¸²æŸ“ç»“æŸéƒ½ä¼šæ‰§è¡Œ Effectï¼›è€Œæ›´æ–° state ä¼šè§¦å‘é‡æ–°æ¸²æŸ“ã€‚ä½†æ˜¯æ–°ä¸€è½®æ¸²æŸ“æ—¶åˆä¼šå†æ¬¡æ‰§è¡Œ Effectï¼Œç„¶å Effect å†æ¬¡æ›´æ–° stateâ€¦â€¦å¦‚æ­¤å‘¨è€Œå¤å§‹ï¼Œä»è€Œé™·å…¥æ­»å¾ªç¯ã€‚
>
> Effect é€šå¸¸åº”è¯¥ä½¿ç»„ä»¶ä¸ **å¤–éƒ¨** ç³»ç»Ÿä¿æŒåŒæ­¥ã€‚å¦‚æœæ²¡æœ‰å¤–éƒ¨ç³»ç»Ÿï¼Œä½ åªæƒ³æ ¹æ®å…¶ä»–çŠ¶æ€è°ƒæ•´ä¸€äº›çŠ¶æ€ï¼Œé‚£ä¹ˆ [ä½ ä¹Ÿè®¸ä¸éœ€è¦ Effect](https://zh-hans.react.dev/learn/you-might-not-need-an-effect)ã€‚



#### æŒ‡å®šEffectä¾èµ–

ä¸€èˆ¬æ¥è¯´ï¼ŒEffect ä¼šåœ¨ **æ¯æ¬¡** æ¸²æŸ“æ—¶æ‰§è¡Œã€‚**ä½†æ›´å¤šæ—¶å€™ï¼Œå¹¶ä¸éœ€è¦æ¯æ¬¡æ¸²æŸ“çš„æ—¶å€™éƒ½æ‰§è¡Œ Effect**ã€‚

- æœ‰æ—¶è¿™ä¼šæ‹–æ…¢è¿è¡Œé€Ÿåº¦ã€‚å› ä¸ºä¸å¤–éƒ¨ç³»ç»Ÿçš„åŒæ­¥æ“ä½œæ€»æ˜¯æœ‰ä¸€å®šæ—¶è€—ï¼Œåœ¨éå¿…è¦æ—¶å¯èƒ½å¸Œæœ›è·³è¿‡å®ƒã€‚ä¾‹å¦‚ï¼Œæ²¡æœ‰äººä¼šå¸Œæœ›æ¯æ¬¡ç”¨é”®ç›˜æ‰“å­—æ—¶éƒ½é‡æ–°è¿æ¥èŠå¤©æœåŠ¡å™¨ã€‚
- æœ‰æ—¶è¿™ä¼šå¯¼è‡´ç¨‹åºé€»è¾‘é”™è¯¯ã€‚ä¾‹å¦‚ï¼Œç»„ä»¶çš„æ·¡å…¥åŠ¨ç”»åªéœ€è¦åœ¨ç¬¬ä¸€è½®æ¸²æŸ“å‡ºç°æ—¶æ’­æ”¾ä¸€æ¬¡ï¼Œè€Œä¸æ˜¯æ¯æ¬¡è§¦å‘æ–°ä¸€è½®æ¸²æŸ“åéƒ½æ’­æ”¾ã€‚

ä¾‹å¦‚ä¸Šé¢çš„æ’­æ”¾å™¨ä¾‹å­ï¼Œæˆ‘ä»¬å¹¶ä¸éœ€è¦åœ¨æ¯æ¬¡æ¸²æŸ“éƒ½æ‰§è¡ŒEffect

å‡è®¾é¡µé¢ä¸­è¿˜å­˜åœ¨ä¸€ä¸ªinputçš„stateï¼Œé‚£ä¹ˆè¿™æ ·ä¼šå¯¼è‡´æˆ‘ä»¬åœ¨è¾“å…¥ä¸€ä¸ªå­—ç¬¦å°±ä¼šæ‰§è¡Œä¸€æ¬¡Effect

å› æ­¤ï¼Œæˆ‘ä»¬éœ€è¦æŒ‡å®šåœ¨ä»€ä¹ˆstateå¯¼è‡´æ¸²æŸ“æ—¶æ‰æ‰§è¡ŒEffect

```jsx
  useEffect(() => {
    if (isPlaying) { // isPlaying åœ¨æ­¤å¤„ä½¿ç”¨â€¦â€¦
      // ...
    } else {
      // ...
    }
  }, [isPlaying]); // â€¦â€¦æ‰€ä»¥å®ƒå¿…é¡»åœ¨æ­¤å¤„å£°æ˜ï¼
```

ä¾èµ–æ•°ç»„å¯ä»¥åŒ…å«å¤šä¸ªä¾èµ–é¡¹ã€‚**å½“æŒ‡å®šçš„æ‰€æœ‰ä¾èµ–é¡¹åœ¨ä¸Šä¸€æ¬¡æ¸²æŸ“æœŸé—´çš„å€¼ä¸å½“å‰å€¼å®Œå…¨ç›¸åŒæ—¶ï¼ŒReact ä¼šè·³è¿‡é‡æ–°è¿è¡Œè¯¥ Effect**ã€‚React ä½¿ç”¨ [`Object.is`](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Object/is) æ¯”è¾ƒä¾èµ–é¡¹çš„å€¼ã€‚

> ==æ³¨æ„ï¼š==
>
> æ²¡æœ‰ä¾èµ–æ•°ç»„ä½œä¸ºç¬¬äºŒä¸ªå‚æ•°ï¼Œä¸ä¾èµ–æ•°ç»„ä½ç©ºæ•°ç»„ `[]` çš„è¡Œä¸ºæ˜¯ä¸ä¸€è‡´çš„ï¼š
>
> ```jsx
> useEffect(() => {
>   // è¿™é‡Œçš„ä»£ç ä¼šåœ¨æ¯æ¬¡æ¸²æŸ“åæ‰§è¡Œ
> });
>
> useEffect(() => {
>   // è¿™é‡Œçš„ä»£ç åªä¼šåœ¨ç»„ä»¶æŒ‚è½½åæ‰§è¡Œ
> }, []);
>
> useEffect(() => {
>   //è¿™é‡Œçš„ä»£ç åªä¼šåœ¨æ¯æ¬¡æ¸²æŸ“åï¼Œå¹¶ä¸” a æˆ– b çš„å€¼ä¸ä¸Šæ¬¡æ¸²æŸ“ä¸ä¸€è‡´æ—¶æ‰§è¡Œ
> }, [a, b]);
> ```
>
> 



> ä¸ºä»€ä¹ˆä¾èµ–æ•°ç»„ä¸­å¯ä»¥çœç•¥refï¼Ÿ
>
> ä¸‹é¢çš„ Effect åŒæ—¶ä½¿ç”¨äº† `ref` ä¸ `isPlaying` propï¼Œä½†æ˜¯åªæœ‰ `isPlaying` è¢«å£°æ˜ä¸ºäº†ä¾èµ–é¡¹ï¼š
>
> ```js
> function VideoPlayer({ src, isPlaying }) {
>
>   const ref = useRef(null);
>
>   useEffect(() => {
>
>     if (isPlaying) {
>
>       ref.current.play();
>
>     } else {
>
>       ref.current.pause();
>
>     }
>
>   }, [isPlaying]);
> ```
>
> è¿™æ˜¯å› ä¸º `ref` å…·æœ‰ **ç¨³å®š** çš„æ ‡è¯†ï¼šReact ä¿è¯ [æ¯è½®æ¸²æŸ“ä¸­è°ƒç”¨ `useRef` æ‰€äº§ç”Ÿçš„å¼•ç”¨å¯¹è±¡æ—¶ï¼Œè·å–åˆ°çš„å¯¹è±¡å¼•ç”¨æ€»æ˜¯ç›¸åŒçš„](https://zh-hans.react.dev/reference/react/useRef#returns)ï¼Œ**å³è·å–åˆ°çš„å¯¹è±¡å¼•ç”¨æ°¸è¿œä¸ä¼šæ”¹å˜ï¼Œæ‰€ä»¥å®ƒä¸ä¼šå¯¼è‡´é‡æ–°è¿è¡Œ Effec**tã€‚å› æ­¤ï¼Œä¾èµ–æ•°ç»„ä¸­æ˜¯å¦åŒ…å«å®ƒå¹¶ä¸é‡è¦ã€‚å½“ç„¶ä¹Ÿå¯ä»¥åŒ…æ‹¬å®ƒï¼Œè¿™æ ·ä¹Ÿå¯ä»¥ï¼š
>
> ```js
> function VideoPlayer({ src, isPlaying }) {
>
>   const ref = useRef(null);
>
>   useEffect(() => {
>
>     if (isPlaying) {
>
>       ref.current.play();
>
>     } else {
>
>       ref.current.pause();
>
>     }
>
>   }, [isPlaying, ref]);
> ```
>
> `useState` è¿”å›çš„ [`set` å‡½æ•°](https://zh-hans.react.dev/reference/react/useState#setstate) ä¹Ÿæœ‰ç¨³å®šçš„æ ‡è¯†ç¬¦ï¼Œæ‰€ä»¥ä¹Ÿå¯ä»¥æŠŠå®ƒä»ä¾èµ–æ•°ç»„ä¸­å¿½ç•¥æ‰ã€‚å¦‚æœåœ¨å¿½ç•¥æŸä¸ªä¾èµ–é¡¹æ—¶ linter ä¸ä¼šæŠ¥é”™ï¼Œé‚£ä¹ˆè¿™ä¹ˆåšå°±æ˜¯å®‰å…¨çš„ã€‚
>
> ä½†æ˜¯ï¼Œä»…åœ¨ linter å¯ä»¥â€œçœ‹åˆ°â€å¯¹è±¡ç¨³å®šæ—¶ï¼Œå¿½ç•¥ç¨³å®šä¾èµ–é¡¹çš„è§„åˆ™æ‰ä¼šèµ·ä½œç”¨ã€‚ä¾‹å¦‚ï¼Œå¦‚æœ `ref` æ˜¯ä»çˆ¶ç»„ä»¶ä¼ é€’çš„ï¼Œåˆ™å¿…é¡»åœ¨ä¾èµ–é¡¹æ•°ç»„ä¸­æŒ‡å®šå®ƒã€‚è¿™æ ·åšæ˜¯åˆé€‚çš„ï¼Œå› ä¸ºæ— æ³•ç¡®å®šçˆ¶ç»„ä»¶æ˜¯å¦å§‹ç»ˆæ˜¯ä¼ é€’ç›¸åŒçš„ refï¼Œæˆ–è€…å¯èƒ½æ˜¯æœ‰æ¡ä»¶åœ°ä¼ é€’å‡ ä¸ª ref ä¹‹ä¸€ã€‚å› æ­¤ï¼Œä½ çš„ Effect å°†å–å†³äºä¼ é€’çš„æ˜¯å“ªä¸ª refã€‚





#### æŒ‰éœ€æ·»åŠ cleanå‡½æ•°

è€ƒè™‘ä¸€ä¸ªä¸åŒçš„ä¾‹å­ã€‚ä½ æ­£åœ¨ç¼–å†™ä¸€ä¸ª `ChatRoom` ç»„ä»¶ï¼Œè¯¥ç»„ä»¶å‡ºç°æ—¶éœ€è¦è¿æ¥åˆ°èŠå¤©æœåŠ¡å™¨ã€‚ç°åœ¨ä¸ºä½ æä¾›äº† `createConnection()` APIï¼Œè¯¥ API è¿”å›ä¸€ä¸ªåŒ…å« `connect()` ä¸ `disconnection()` æ–¹æ³•çš„å¯¹è±¡ã€‚è€ƒè™‘å½“ç»„ä»¶å±•ç¤ºç»™ç”¨æˆ·æ—¶ï¼Œåº”è¯¥å¦‚ä½•ä¿æŒè¿æ¥ï¼Ÿ

ä»ç¼–å†™ Effect é€»è¾‘å¼€å§‹ï¼š

```js
useEffect(() => {

  const connection = createConnection();

  connection.connect();

});
```

æ¯æ¬¡é‡æ–°æ¸²æŸ“åè¿æ¥åˆ°èŠå¤©å®¤ä¼šå¾ˆæ…¢ï¼Œå› æ­¤å¯ä»¥æ·»åŠ ä¾èµ–æ•°ç»„ï¼š

```js
useEffect(() => {

  const connection = createConnection();

  connection.connect();

}, []);
```

**åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼ŒEffect ä¸­çš„ä»£ç æ²¡æœ‰ä½¿ç”¨ä»»ä½• props æˆ– stateï¼Œæ­¤æ—¶æŒ‡å®šä¾èµ–æ•°ç»„ä¸ºç©ºæ•°ç»„ []ã€‚è¿™å‘Šè¯‰ React ä»…åœ¨ç»„ä»¶â€œæŒ‚è½½â€æ—¶è¿è¡Œæ­¤ä»£ç ï¼Œå³é¦–æ¬¡å‡ºç°åœ¨å±å¹•ä¸Šè¿™ä¸€é˜¶æ®µ**ã€‚

![71731533390](Reacté«˜çº§.assets/1717315333903.png)

å®é™…è¿è¡Œä¼šå‘ç°ï¼Œå®é™…è¿æ¥ä¼šè¿›è¡Œä¸¤æ¬¡ï¼Œè¿™æ˜¯ç”±äºReactçš„ä¸¥æ ¼æ¨¡å¼çš„åŸå› ï¼Œå› æ­¤æˆ‘ä»¬ä¹Ÿèƒ½å¤ŸçŸ¥é“è¿™æ®µä»£ç æ˜¯å­˜åœ¨é—®é¢˜çš„ï¼š

æƒ³è±¡ `ChatRoom` ç»„ä»¶æ˜¯ä¸€ä¸ªå¤§è§„æ¨¡çš„ App ä¸­è®¸å¤šç•Œé¢ä¸­çš„ä¸€éƒ¨åˆ†ã€‚ç”¨æˆ·åˆ‡æ¢åˆ°å«æœ‰ `ChatRoom` ç»„ä»¶çš„é¡µé¢ä¸Šæ—¶ï¼Œè¯¥ç»„ä»¶è¢«æŒ‚è½½ï¼Œå¹¶è°ƒç”¨ `connection.connect()` æ–¹æ³•è¿æ¥æœåŠ¡å™¨ã€‚ç„¶åæƒ³è±¡ç”¨æˆ·æ­¤æ—¶çªç„¶å¯¼èˆªåˆ°å¦ä¸€ä¸ªé¡µé¢ï¼Œæ¯”å¦‚åˆ‡æ¢åˆ°â€œè®¾ç½®â€é¡µé¢ã€‚è¿™æ—¶ï¼Œ`ChatRoom` ç»„ä»¶å°±è¢«å¸è½½äº†ã€‚æ¥ä¸‹æ¥ï¼Œç”¨æˆ·åœ¨â€œè®¾ç½®â€é¡µé¢å¿™å®Œåï¼Œå•å‡»â€œè¿”å›â€ï¼Œå›åˆ°ä¸Šä¸€ä¸ªé¡µé¢ï¼Œå¹¶å†æ¬¡æŒ‚è½½ `ChatRoom`ã€‚è¿™å°†å»ºç«‹ç¬¬äºŒæ¬¡è¿æ¥ï¼Œä½†æ˜¯ï¼Œç¬¬ä¸€æ¬¡æ—¶åˆ›å»ºçš„è¿æ¥ä»æœªè¢«é”€æ¯ï¼å½“ç”¨æˆ·åœ¨åº”ç”¨ç¨‹åºä¸­ä¸æ–­åˆ‡æ¢ç•Œé¢å†è¿”å›æ—¶ï¼Œä¸æœåŠ¡å™¨çš„è¿æ¥ä¼šä¸æ–­å †ç§¯ã€‚

ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå¯ä»¥åœ¨ Effect ä¸­è¿”å›ä¸€ä¸ª **æ¸…ç†ï¼ˆcleanupï¼‰** å‡½æ•°ã€‚

```js
  useEffect(() => {

    const connection = createConnection();

    connection.connect();

    return () => {

      connection.disconnect();

    };

  }, []);
```

**æ¯æ¬¡é‡æ–°æ‰§è¡Œ Effect ä¹‹å‰ï¼ŒReact éƒ½ä¼šè°ƒç”¨æ¸…ç†å‡½æ•°ï¼›ç»„ä»¶è¢«å¸è½½æ—¶ï¼Œä¹Ÿä¼šè°ƒç”¨æ¸…ç†å‡½æ•°**ã€‚è®©æˆ‘ä»¬çœ‹çœ‹æ‰§è¡Œæ¸…ç†å‡½æ•°ä¼šåšäº›ä»€ä¹ˆï¼š

![71731543265](Reacté«˜çº§.assets/1717315432654.png)

æ­¤æ—¶çš„è¿è¡Œç»“æœæ‰æ˜¯æ­£ç¡®çš„

**åœ¨ç”Ÿäº§ç¯å¢ƒä¸‹ï¼Œ"âœ… è¿æ¥ä¸­â€¦â€¦" åªä¼šè¢«æ‰“å°ä¸€æ¬¡**ã€‚ä¹Ÿå°±æ˜¯è¯´ä»…åœ¨å¼€å‘ç¯å¢ƒä¸‹æ‰ä¼šé‡å¤æŒ‚è½½ç»„ä»¶ï¼Œä»¥å¸®åŠ©ä½ æ‰¾åˆ°éœ€è¦æ¸…ç†çš„ Effectã€‚ä½ å¯ä»¥é€‰æ‹©å…³é—­ [ä¸¥æ ¼æ¨¡å¼](https://zh-hans.react.dev/reference/react/StrictMode) æ¥å…³é—­å¼€å‘ç¯å¢ƒä¸‹ç‰¹æœ‰çš„è¡Œä¸ºï¼Œä½†æˆ‘ä»¬å»ºè®®ä¿ç•™å®ƒã€‚è¿™å¯ä»¥å¸®åŠ©å‘ç°è®¸å¤šä¸Šé¢è¿™æ ·çš„é”™è¯¯ã€‚





### æ§åˆ¶éReactç»„ä»¶

æœ‰æ—¶éœ€è¦æ·»åŠ ä¸æ˜¯ä½¿ç”¨ React ç¼–å†™çš„ UI å°éƒ¨ä»¶ã€‚ä¾‹å¦‚ï¼Œå‡è®¾ä½ è¦å‘é¡µé¢æ·»åŠ åœ°å›¾ç»„ä»¶ï¼Œå¹¶ä¸”å®ƒæœ‰ä¸€ä¸ª `setZoomLevel()` æ–¹æ³•ï¼Œä½ å¸Œæœ›è°ƒæ•´ç¼©æ”¾çº§åˆ«ï¼ˆzoom levelï¼‰å¹¶ä¸ React ä»£ç ä¸­çš„ `zoomLevel` state å˜é‡ä¿æŒåŒæ­¥ã€‚Effect çœ‹èµ·æ¥åº”è¯¥ä¸ä¸‹é¢ç±»ä¼¼ï¼š

```js
useEffect(() => {

  const map = mapRef.current;

  map.setZoomLevel(zoomLevel);

}, [zoomLevel]);
```

è¯·æ³¨æ„ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ä¸éœ€è¦æ¸…ç†ã€‚åœ¨å¼€å‘ç¯å¢ƒä¸­ï¼ŒReact ä¼šè°ƒç”¨ Effect ä¸¤æ¬¡ï¼Œä½†è¿™ä¸¤æ¬¡æŒ‚è½½æ—¶ä¾èµ–é¡¹ `zoomLevel` éƒ½æ˜¯ç›¸åŒçš„ï¼Œæ‰€ä»¥ä¼šè·³è¿‡æ‰§è¡Œç¬¬äºŒæ¬¡æŒ‚è½½æ—¶çš„ Effectã€‚å¼€å‘ç¯å¢ƒä¸­å®ƒå¯èƒ½ä¼šç¨å¾®æ…¢ä¸€äº›ï¼Œä½†è¿™é—®é¢˜ä¸å¤§ï¼Œå› ä¸ºå®ƒåœ¨ç”Ÿäº§ä¸­ä¸ä¼šè¿›è¡Œä¸å¿…è¦çš„é‡å¤æŒ‚è½½ã€‚

æŸäº› API å¯èƒ½ä¸å…è®¸è¿ç»­è°ƒç”¨ä¸¤æ¬¡ã€‚ä¾‹å¦‚ï¼Œå†…ç½®çš„ [``](https://developer.mozilla.org/zh-CN/docs/Web/API/HTMLDialogElement) å…ƒç´ çš„ [`showModal`](https://developer.mozilla.org/zh-CN/docs/Web/API/HTMLDialogElement/showModal) æ–¹æ³•åœ¨è¿ç»­è°ƒç”¨ä¸¤æ¬¡æ—¶ä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œæ­¤æ—¶å®ç°æ¸…ç†å‡½æ•°å¹¶ä½¿å…¶å…³é—­å¯¹è¯æ¡†ï¼š

```js
useEffect(() => {

  const dialog = dialogRef.current;

  dialog.showModal();

  return () => dialog.close();

}, []);
```

åœ¨å¼€å‘ç¯å¢ƒä¸­ï¼ŒEffect å°†è°ƒç”¨ `showModal()`ï¼Œç„¶åç«‹å³è°ƒç”¨ `close()`ï¼Œç„¶åå†æ¬¡è°ƒç”¨ `showModal()`ã€‚è¿™ä¸è°ƒç”¨åªä¸€æ¬¡ `showModal()` çš„æ•ˆæœç›¸åŒã€‚ä¹Ÿæ­£å¦‚åœ¨ç”Ÿäº§ç¯å¢ƒä¸­çœ‹åˆ°çš„é‚£æ ·ã€‚



### è®¢é˜…äº‹ä»¶

å¦‚æœ Effect è®¢é˜…äº†æŸäº›äº‹ä»¶ï¼Œæ¸…ç†å‡½æ•°åº”è¯¥é€€è®¢è¿™äº›äº‹ä»¶ï¼š

```js
useEffect(() => {

  function handleScroll(e) {

    console.log(window.scrollX, window.scrollY);

  }

  window.addEventListener('scroll', handleScroll);

  return () => window.removeEventListener('scroll', handleScroll);

}, []);
```

åœ¨å¼€å‘ç¯å¢ƒä¸­ï¼ŒEffect ä¼šè°ƒç”¨ `addEventListener()`ï¼Œç„¶åç«‹å³è°ƒç”¨ `removeEventListener()`ï¼Œç„¶åå†è°ƒç”¨ç›¸åŒçš„ `addEventListener()`ï¼Œè¿™ä¸åªè®¢é˜…ä¸€æ¬¡äº‹ä»¶çš„ Effect ç­‰æ•ˆï¼›è¿™ä¹Ÿä¸ç”¨æˆ·åœ¨ç”Ÿäº§ç¯å¢ƒä¸­åªè°ƒç”¨ä¸€æ¬¡ `addEventListener()` å…·æœ‰ç›¸åŒçš„æ„ŸçŸ¥æ•ˆæœã€‚



### è§¦å‘åŠ¨ç”»

å¦‚æœ Effect å¯¹æŸäº›å†…å®¹åŠ å…¥äº†åŠ¨ç”»ï¼Œæ¸…ç†å‡½æ•°åº”å°†åŠ¨ç”»é‡ç½®ï¼š

```js
useEffect(() => {

  const node = ref.current;

  node.style.opacity = 1; // è§¦å‘åŠ¨ç”»

  return () => {

    node.style.opacity = 0; // é‡ç½®ä¸ºåˆå§‹å€¼

  };

}, []);
```

åœ¨å¼€å‘ç¯å¢ƒä¸­ï¼Œé€æ˜åº¦ç”± `1` å˜ä¸º `0`ï¼Œå†å˜ä¸º `1`ã€‚è¿™ä¸åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œç›´æ¥å°†å…¶è®¾ç½®ä¸º `1` å…·æœ‰ç›¸åŒçš„æ„ŸçŸ¥æ•ˆæœï¼Œå¦‚æœä½ ä½¿ç”¨æ”¯æŒè¿‡æ¸¡çš„ç¬¬ä¸‰æ–¹åŠ¨ç”»åº“ï¼Œä½ çš„æ¸…ç†å‡½æ•°åº”å°†æ—¶é—´è½´é‡ç½®ä¸ºå…¶åˆå§‹çŠ¶æ€ã€‚





### è¯·æ±‚æ•°æ®

å¦‚æœ Effect å°†ä¼šè·å–æ•°æ®ï¼Œæ¸…ç†å‡½æ•°åº”è¯¥è¦ä¹ˆ [ä¸­æ­¢è¯¥æ•°æ®è·å–æ“ä½œ](https://developer.mozilla.org/zh-CN/docs/Web/API/AbortController)ï¼Œè¦ä¹ˆå¿½ç•¥å…¶ç»“æœï¼š

```js
useEffect(() => {

  let ignore = false;

  async function startFetching() {

    const json = await fetchTodos(userId);

    if (!ignore) {

      setTodos(json);

    }

  }

  startFetching();

  return () => {

    ignore = true;

  };

}, [userId]);
```

æˆ‘ä»¬æ— æ³•æ’¤æ¶ˆå·²ç»å‘ç”Ÿçš„ç½‘ç»œè¯·æ±‚ï¼Œä½†æ˜¯æ¸…ç†å‡½æ•°åº”å½“ç¡®ä¿è·å–æ•°æ®çš„è¿‡ç¨‹ä»¥åŠè·å–åˆ°çš„ç»“æœä¸ä¼šç»§ç»­å½±å“ç¨‹åºè¿è¡Œã€‚å¦‚æœ `userId` ä» `'Alice'` å˜ä¸º `'Bob'`ï¼Œé‚£ä¹ˆè¯·ç¡®ä¿ `'Alice'` å“åº”æ•°æ®è¢«å¿½ç•¥ï¼Œå³ä½¿å®ƒåœ¨ `'Bob'` ä¹‹ååˆ°è¾¾ã€‚

**åœ¨å¼€å‘ç¯å¢ƒä¸­ï¼Œæµè§ˆå™¨è°ƒè¯•å·¥å…·çš„â€œç½‘ç»œâ€é€‰é¡¹å¡ä¸­ä¼šå‡ºç°ä¸¤ä¸ª fetch è¯·æ±‚**ã€‚è¿™æ˜¯æ­£å¸¸çš„ã€‚ä½¿ç”¨ä¸Šè¿°æ–¹æ³•ï¼Œç¬¬ä¸€ä¸ª Effect å°†ç«‹å³è¢«æ¸…ç†ï¼Œè€Œ `ignore` å°†è¢«è®¾ç½®ä¸º `true`ã€‚å› æ­¤ï¼Œå³ä½¿æœ‰é¢å¤–çš„è¯·æ±‚ï¼Œç”±äºæœ‰ `if (!ignore)` åˆ¤æ–­æ£€æŸ¥ï¼Œä¹Ÿä¸ä¼šå½±å“ç¨‹åºçŠ¶æ€ã€‚



### å‘é€åˆ†ææŠ¥å‘Š

è€ƒè™‘åœ¨è®¿é—®é¡µé¢æ—¶å‘é€æ—¥å¿—åˆ†æï¼š

```js
useEffect(() => {

  logVisit(url); // å‘é€ POST è¯·æ±‚

}, [url]);
```

åœ¨å¼€å‘ç¯å¢ƒä¸­ï¼Œ`logVisit` ä¼šä¸ºæ¯ä¸ª URL å‘é€ä¸¤æ¬¡è¯·æ±‚ï¼Œæ‰€ä»¥ä½ å¯èƒ½ä¼šæƒ³å°è¯•è§£å†³è¿™ä¸ªé—®é¢˜ã€‚**ä¸è¿‡æˆ‘ä»¬å»ºè®®ä¸å¿…ä¿®æ”¹æ­¤å¤„ä»£ç **ï¼Œä¸å‰é¢çš„ç¤ºä¾‹ä¸€æ ·ï¼Œä»ç”¨æˆ·çš„è§’åº¦æ¥çœ‹ï¼Œè¿è¡Œä¸€æ¬¡å’Œè¿è¡Œä¸¤æ¬¡ä¹‹é—´ä¸ä¼š **æ„ŸçŸ¥** åˆ°è¡Œä¸ºå·®å¼‚ã€‚ä»å®é™…çš„è§’åº¦æ¥çœ‹ï¼Œ`logVisit` ä¸åº”è¯¥åœ¨å¼€å‘ç¯å¢ƒä¸­åšä»»ä½•å½±å“ç”Ÿäº§äº‹æƒ…ã€‚ç”±äºæ¯æ¬¡ä¿å­˜ä»£ç æ–‡ä»¶æ—¶éƒ½ä¼šé‡æ–°æŒ‚è½½ç»„ä»¶ï¼Œå› æ­¤åœ¨å¼€å‘ç¯å¢ƒä¸­ä¼šé¢å¤–è®°å½•è®¿é—®æ¬¡æ•°ã€‚

**åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œä¸ä¼šäº§ç”Ÿæœ‰é‡å¤çš„è®¿é—®æ—¥å¿—**ã€‚

ä¸ºäº†è°ƒè¯•å‘é€çš„åˆ†æäº‹ä»¶ï¼Œå¯ä»¥å°†åº”ç”¨éƒ¨ç½²åˆ°ä¸€ä¸ªè¿è¡Œåœ¨ç”Ÿäº§æ¨¡å¼ä¸‹çš„æš‚å­˜ç¯å¢ƒï¼Œæˆ–è€…æš‚æ—¶å–æ¶ˆ [ä¸¥æ ¼æ¨¡å¼](https://zh-hans.react.dev/reference/react/StrictMode) åŠå…¶ä»…åœ¨å¼€å‘ç¯å¢ƒä¸­é‡æ–°åŠ è½½æ£€æŸ¥ï¼›è¿˜å¯ä»¥ä»è·¯ç”±å˜æ›´äº‹ä»¶å¤„ç†ç¨‹åºä¸­å‘é€åˆ†ææ•°æ®ï¼Œè€Œä¸æ˜¯ä» Effect ä¸­å‘é€ã€‚ä¸ºäº†æ›´ç²¾ç¡®çš„åˆ†æï¼Œå¯ä»¥ä½¿ç”¨ [Intersection Observer](https://developer.mozilla.org/zh-CN/docs/Web/API/Intersection_Observer_API) æ¥è·Ÿè¸ªå“ªäº›ç»„ä»¶ä½äºè§†å£ä¸­ä»¥åŠå®ƒä»¬ä¿æŒå¯è§çš„æ—¶é—´ã€‚



### åˆå§‹åŒ–åº”ç”¨æ— éœ€Effectçš„æƒ…å½¢

æŸäº›é€»è¾‘åº”è¯¥åªåœ¨åº”ç”¨ç¨‹åºå¯åŠ¨æ—¶è¿è¡Œä¸€æ¬¡ã€‚æ¯”å¦‚ï¼ŒéªŒè¯ç™»é™†çŠ¶æ€å’ŒåŠ è½½æœ¬åœ°ç¨‹åºæ•°æ®ã€‚ä½ å¯ä»¥å°†å…¶æ”¾åœ¨ç»„ä»¶ä¹‹å¤–ï¼š

```js
if (typeof window !== 'undefined') { // æ£€æŸ¥æ˜¯å¦åœ¨æµè§ˆå™¨ä¸­è¿è¡Œ

  checkAuthToken();

  loadDataFromLocalStorage();

}



function App() {

  // â€¦â€¦

}
```

è¿™ä¿è¯äº†è¿™ç§é€»è¾‘åœ¨æµè§ˆå™¨åŠ è½½é¡µé¢ååªè¿è¡Œä¸€æ¬¡ã€‚



### ä¸è¦åœ¨Effectä¸­æ‰§è¡Œè´­ä¹°å•†å“ä¸€ç±»æ“ä½œ

æœ‰æ—¶ï¼Œå³ä½¿ç¼–å†™äº†ä¸€ä¸ªæ¸…ç†å‡½æ•°ï¼Œä¹Ÿä¸èƒ½é¿å…æ‰§è¡Œä¸¤æ¬¡ Effectã€‚ä¾‹å¦‚ï¼ŒEffect åŒ…å«ä¼šå‘é€ POST è¯·æ±‚ä»¥æ‰§è¡Œè´­ä¹°æ“ä½œï¼š

```js
useEffect(() => {

  // ğŸ”´ é”™è¯¯ï¼šæ­¤å¤„çš„ Effect ä¼šåœ¨å¼€å‘ç¯å¢ƒä¸­æ‰§è¡Œä¸¤æ¬¡ï¼Œè¿™åœ¨ä»£ç ä¸­æ˜¯æœ‰é—®é¢˜çš„ã€‚

  fetch('/api/buy', { method: 'POST' });

}, []);
```

ä¸€æ–¹é¢ï¼Œå¼€å‘ç¯å¢ƒä¸‹ï¼ŒEffect ä¼šæ‰§è¡Œä¸¤æ¬¡ï¼Œè¿™æ„å‘³ç€è´­ä¹°æ“ä½œæ‰§è¡Œäº†ä¸¤æ¬¡ï¼Œä½†æ˜¯è¿™å¹¶éæ˜¯é¢„æœŸçš„ç»“æœï¼Œæ‰€ä»¥ä¸åº”è¯¥æŠŠè¿™ä¸ªä¸šåŠ¡é€»è¾‘æ”¾åœ¨ Effect ä¸­ã€‚å¦ä¸€æ–¹é¢ï¼Œå¦‚æœç”¨æˆ·è½¬åˆ°å¦ä¸€ä¸ªé¡µé¢ï¼Œç„¶åæŒ‰â€œåé€€â€æŒ‰é’®å›åˆ°äº†è¿™ä¸ªç•Œé¢ï¼Œè¯¥æ€ä¹ˆåŠï¼ŸEffect ä¼šéšç€ç»„ä»¶å†æ¬¡æŒ‚è½½è€Œå†æ¬¡æ‰§è¡Œã€‚æ‰€ä»¥ï¼Œå½“ç”¨æˆ·é‡æ–°è®¿é—®æŸä¸ªé¡µé¢æ—¶ï¼Œä¸åº”å½“æ‰§è¡Œè´­ä¹°æ“ä½œï¼›å½“åªæœ‰ç”¨æˆ·ç‚¹å‡»â€œè´­ä¹°â€æŒ‰é’®æ—¶ï¼Œæ‰æ‰§è¡Œè´­ä¹°æ“ä½œã€‚

å› æ­¤ï¼Œâ€œè´­ä¹°â€çš„æ“ä½œä¸åº”ç”±ç»„ä»¶çš„æŒ‚è½½ã€æ¸²æŸ“å¼•èµ·çš„ï¼›å®ƒæ˜¯ç”±ç‰¹å®šçš„äº¤äº’ä½œç”¨å¼•èµ·çš„ï¼Œå®ƒåº”è¯¥åªåœ¨ç”¨æˆ·æŒ‰ä¸‹æŒ‰é’®æ—¶è¿è¡Œã€‚å› æ­¤ï¼Œ**å®ƒä¸åº”è¯¥å†™åœ¨ Effect ä¸­ï¼Œåº”å½“æŠŠ /api/buy è¯·æ±‚æ“ä½œç§»åŠ¨åˆ°è´­ä¹°æŒ‰é’®äº‹ä»¶å¤„ç†ç¨‹åºä¸­**ï¼š

```js
  function handleClick() {

    // âœ… è´­ä¹°å•†å“åº”å½“åœ¨äº‹ä»¶ä¸­æ‰§è¡Œï¼Œå› ä¸ºè¿™æ˜¯ç”±ç‰¹å®šçš„æ“ä½œå¼•èµ·çš„ã€‚

    fetch('/api/buy', { method: 'POST' });

  }
```

**è¿™ä¸ªä¾‹å­è¯´æ˜å¦‚æœé‡æ–°æŒ‚è½½ç ´åäº†åº”ç”¨ç¨‹åºçš„é€»è¾‘ï¼Œåˆ™é€šå¸¸å«æœ‰æœªè¢«å‘ç°çš„é”™è¯¯**ã€‚ä»ç”¨æˆ·çš„è§’åº¦æ¥çœ‹ï¼Œè®¿é—®ä¸€ä¸ªé¡µé¢ä¸åº”è¯¥ä¸è®¿é—®å®ƒã€ç‚¹å‡»é“¾æ¥ç„¶åæŒ‰ä¸‹è¿”å›é”®å†æ¬¡æŸ¥çœ‹é¡µé¢æœ‰ä»€ä¹ˆä¸åŒã€‚React é€šè¿‡åœ¨å¼€å‘ç¯å¢ƒä¸­é‡å¤æŒ‚è½½ç»„ä»¶ä»¥éªŒè¯ç»„ä»¶æ˜¯å¦éµå®ˆæ­¤åŸåˆ™ã€‚



> ==æ¯ä¸€è½®æ¸²æŸ“éƒ½æœ‰è‡ªå·±çš„Effect==
>
> ä½ å¯ä»¥å°† `useEffect` è®¤ä¸ºå…¶å°†ä¸€æ®µè¡Œä¸ºâ€œé™„åŠ â€åˆ°æ¸²æŸ“è¾“å‡ºã€‚è€ƒè™‘è¿™ç§æƒ…å†µï¼š
>
> ```js
> export default function ChatRoom({ roomId }) {
>
>   useEffect(() => {
>
>     const connection = createConnection(roomId);
>
>     connection.connect();
>
>     return () => connection.disconnect();
>
>   }, [roomId]);
>
>
>
>   return <h1>æ¬¢è¿æ¥åˆ° {roomId}ï¼</h1>;
>
> }
> ```
>
> è®©æˆ‘ä»¬çœ‹çœ‹å½“ç”¨æˆ·åœ¨åº”ç”¨ç¨‹åºä¸­åˆ‡æ¢é¡µé¢æ—¶åˆ°åº•å‘ç”Ÿäº†ä»€ä¹ˆã€‚
>
> - åˆå§‹æ¸²æŸ“ 
>
> ç”¨æˆ·è®¿é—® `<ChatRoom roomId="general" />`ï¼Œåœ¨è¿™é‡Œè®©æˆ‘ä»¬ [å‡è®¾](https://zh-hans.react.dev/learn/state-as-a-snapshot#rendering-takes-a-snapshot-in-time) `roomId` çš„å€¼ä¸º `'general'` ï¼š
>
> ```js
>   // é¦–æ¬¡æ¸²æŸ“æ—¶çš„ JSXï¼ˆroomId ä¸º "general"ï¼‰
>
>   return <h1>æ¬¢è¿æ¥åˆ° generalï¼</h1>;
> ```
>
> **Effect ä¹Ÿæ˜¯æ¸²æŸ“è¾“å‡ºçš„ä¸€éƒ¨åˆ†**ã€‚é¦–æ¬¡æ¸²æŸ“çš„ Effect å˜ä¸ºï¼š
>
> ```js
>   //é¦–å…ˆæ¸²æŸ“æ—¶çš„ Effectï¼ˆroomId ä¸º "general"ï¼‰
>
>   () => {
>
>     const connection = createConnection('general');
>
>     connection.connect();
>
>     return () => connection.disconnect();
>
>   },
>
>   // é¦–æ¬¡æ¸²æŸ“æ—¶çš„ä¾èµ–é¡¹ï¼ˆroomId ä¸º "general"ï¼‰
>
>   ['general']
> ```
>
> React å°†ä¼šæ‰§è¡Œç”¨äºè¿æ¥åˆ° `'general'` èŠå¤©å®¤çš„ Effectã€‚
>
> - ä¾èµ–é¡¹ç›¸åŒæ—¶çš„é‡æ–°æ¸²æŸ“ 
>
> è®©æˆ‘ä»¬æ¢è®¨ä¸‹ `<ChatRoom roomId="general" />` çš„é‡å¤æ¸²æŸ“ã€‚JSX çš„è¾“å‡ºç»“æœä»ç„¶ç›¸åŒï¼š
>
> ```js
>   // ç¬¬äºŒæ¬¡æ¸²æŸ“æ—¶çš„ JSXï¼ˆroomId ä¸º "general"ï¼‰
>
>   return <h1>Welcome to general!</h1>;
> ```
>
> React çœ‹åˆ°æ¸²æŸ“è¾“å‡ºæ²¡æœ‰æ”¹å˜ï¼Œæ‰€ä»¥å®ƒä¸ä¼šæ›´æ–° DOM ã€‚
>
> ç¬¬äºŒæ¬¡æ¸²æŸ“çš„ Effect å¦‚ä¸‹æ‰€ç¤ºï¼š
>
> ```js
>   // ç¬¬äºŒæ¬¡æ¸²æŸ“æ—¶çš„ Effectï¼ˆroomId ä¸º "general"ï¼‰
>
>   () => {
>
>     const connection = createConnection('general');
>
>     connection.connect();
>
>     return () => connection.disconnect();
>
>   },
>
>   // ç¬¬äºŒæ¬¡æ¸²æŸ“æ—¶çš„ä¾èµ–é¡¹ï¼ˆroomId ä¸º "general"ï¼‰
>
>   ['general']
> ```
>
> React å°†ç¬¬äºŒæ¬¡æ¸²æŸ“æ—¶çš„ `['general']` ä¸ç¬¬ä¸€æ¬¡æ¸²æŸ“æ—¶çš„ `['general']` è¿›è¡Œæ¯”è¾ƒã€‚**å› ä¸ºæ‰€æœ‰çš„ä¾èµ–é¡¹éƒ½æ˜¯ç›¸åŒçš„ï¼ŒReact ä¼šå¿½ç•¥ç¬¬äºŒæ¬¡æ¸²æŸ“æ—¶çš„ Effect**ã€‚æ‰€ä»¥æ­¤æ—¶ Effect ä¸ä¼šè¢«è°ƒç”¨ã€‚
>
> - ä¾èµ–é¡¹ä¸åŒæ—¶çš„é‡æ–°æ¸²æŸ“ 
>
> æ¥ä¸‹æ¥ï¼Œç”¨æˆ·å¼€å§‹è®¿é—® `<ChatRoom roomId="travel" />`ã€‚æ³¨æ„è¿™é‡Œ `roomId` çš„å±æ€§å€¼æ”¹ä¸ºäº† `'travel'`ï¼Œè¿”å›çš„æ˜¯ä¸åŒçš„ JSX è¾“å‡ºç»“æœï¼š
>
> ```js
>   // ç¬¬ä¸‰æ¬¡æ¸²æŸ“æ—¶çš„ JSXï¼ˆroomId ä¸º "travel"ï¼‰
>
>   return <h1>æ¬¢è¿æ¥åˆ° travelï¼</h1>;
> ```
>
> è¿™æ—¶çš„ React ä¼šæ›´æ–° DOM ï¼Œå°† `"æ¬¢è¿æ¥åˆ° general"` æ›´æ–°ä¸º `"æ¬¢è¿æ¥åˆ° travel"`ã€‚
>
> ç¬¬ä¸‰æ¬¡æ¸²æŸ“çš„ Effect å¦‚ä¸‹æ‰€ç¤ºï¼š
>
> ```js
>   // ç¬¬ä¸‰æ¬¡æ¸²æŸ“æ—¶çš„ Effectï¼ˆroomId ä¸º "travel"ï¼‰
>
>   () => {
>
>     const connection = createConnection('travel');
>
>     connection.connect();
>
>     return () => connection.disconnect();
>
>   },
>
>   // ç¬¬ä¸‰æ¬¡æ¸²æŸ“æ—¶çš„ä¾èµ–é¡¹ï¼ˆroomId ä¸º "travel"ï¼‰
>
>   ['travel']
> ```
>
> React å°†ç¬¬ä¸‰æ¬¡æ¸²æŸ“æ—¶çš„ `['travel']` ä¸ç¬¬äºŒæ¬¡æ¸²æŸ“æ—¶çš„ `['general']` ç›¸äº’æ¯”è¾ƒã€‚ä¼šå‘ç°ä¾èµ–é¡¹ä¸åŒï¼š`Object.is('travel', 'general')` ä¸º `false`ï¼šæ‰€ä»¥è¿™æ¬¡çš„ Effect ä¸èƒ½è·³è¿‡ã€‚
>
> **åœ¨ React æ‰§è¡Œç¬¬ä¸‰æ¬¡æ¸²æŸ“çš„ Effect ä¹‹å‰ï¼Œå®ƒéœ€è¦æ¸…ç†æœ€è¿‘æ¸²æŸ“çš„ Effect**ã€‚ç¬¬äºŒæ¬¡æ¸²æŸ“çš„ Effect è¢«è·³è¿‡äº†ã€‚æ‰€ä»¥ React éœ€è¦æ¸…ç†ç¬¬ä¸€æ¬¡æ¸²æŸ“æ—¶çš„ Effectã€‚å¦‚æœä½ å›çœ‹ç¬¬ä¸€æ¬¡æ¸²æŸ“çš„ Effectï¼Œä½ å¯ä»¥çœ‹åˆ°ç¬¬ä¸€æ¬¡æ¸²æŸ“æ—¶çš„æ¸…ç†å‡½æ•°éœ€è¦æ‰§è¡Œçš„å†…å®¹ï¼Œæ˜¯åœ¨ `createConnection('general')` æ‰€åˆ›å»ºçš„è¿æ¥ä¸Šè°ƒç”¨ `disconnect()`ã€‚ä¹Ÿå°±æ˜¯ä» `'general'` èŠå¤©å®¤æ–­å¼€è¿æ¥ã€‚
>
> ä¹‹åï¼ŒReact æ‰§è¡Œç¬¬ä¸‰æ¬¡æ¸²æŸ“çš„ Effectã€‚å®ƒè¿æ¥åˆ° `'travel'` èŠå¤©å®¤ã€‚
>
> * ç»„ä»¶å¸è½½ 
>
> æœ€åï¼Œå‡è®¾ç”¨æˆ·ç¦»å¼€äº†å½“å‰é¡µé¢ï¼Œ`ChatRoom` ç»„ä»¶**å°†è¢«å¸è½½æ—¶ï¼ŒReact ä¼šæ‰§è¡Œæœ€è¿‘çš„ Effect çš„æ¸…ç†å‡½æ•°**ï¼Œä¹Ÿå°±æ˜¯ç¬¬ä¸‰æ¬¡æ¸²æŸ“æ—¶ Effect çš„æ¸…ç†å‡½æ•°ã€‚ç¬¬ä¸‰æ¬¡æ¸²æŸ“åå†æ¸…ç†æ—¶ï¼Œæ¸…ç†å‡½æ•°ç ´åäº† `createConnection('travel')` æ–¹æ³•åˆ›å»ºçš„è¿æ¥ã€‚å› æ­¤ï¼Œè¯¥åº”ç”¨ç¨‹åºä¸ `travel` æˆ¿é—´æ–­å¼€äº†è¿æ¥ã€‚







## ä½ å¯èƒ½ä¸éœ€è¦Effect

Effect æ˜¯ React èŒƒå¼ä¸­çš„ä¸€ç§è„±å›´æœºåˆ¶ã€‚å®ƒä»¬è®©ä½ å¯ä»¥ â€œé€ƒå‡ºâ€ React å¹¶ä½¿ç»„ä»¶å’Œä¸€äº›å¤–éƒ¨ç³»ç»ŸåŒæ­¥ï¼Œæ¯”å¦‚é React ç»„ä»¶ã€ç½‘ç»œå’Œæµè§ˆå™¨ DOMã€‚

å¯èƒ½ä½ åªæ˜¯æƒ³è¦æ ¹æ®propsæˆ–stateçš„å˜åŒ–æ¥æ›´æ–°ä¸€ä¸ªç»„ä»¶çš„stateï¼Œé‚£ä¹ˆå¯èƒ½ä½ å¹¶ä¸éœ€è¦ä½¿ç”¨åˆ°Effect

ç§»é™¤ä¸å¿…è¦çš„ Effect å¯ä»¥è®©ä½ çš„ä»£ç æ›´å®¹æ˜“ç†è§£ï¼Œè¿è¡Œå¾—æ›´å¿«ï¼Œå¹¶ä¸”æ›´å°‘å‡ºé”™ã€‚



### ä¸¤ç§æƒ…å†µ

æœ‰ä¸¤ç§ä¸å¿…ä½¿ç”¨ Effect çš„å¸¸è§æƒ…å†µï¼š

- **ä½¿ç”¨Effectæ¥è®¡ç®—æ¸²æŸ“æ‰€éœ€æ•°æ®**ï¼Œä¾‹å¦‚ä½ æƒ³è¦åœ¨å±•ç¤ºä¸€ä¸ªåˆ—è¡¨ä¹‹å‰å…ˆåšç­›é€‰ï¼šä½ çš„ç›´è§‰å¯èƒ½æ˜¯å†™ä¸€ä¸ªå½“åˆ—è¡¨å˜åŒ–æ—¶æ›´æ–° state å˜é‡çš„ Effectï¼Œä½†æ˜¯è¿™æ˜¯ä½æ•ˆçš„ï¼Œå½“ä½ æ›´æ–°è¿™ä¸ª state æ—¶ï¼ŒReact é¦–å…ˆä¼šè°ƒç”¨ä½ çš„ç»„ä»¶å‡½æ•°æ¥è®¡ç®—åº”è¯¥æ˜¾ç¤ºåœ¨å±å¹•ä¸Šçš„å†…å®¹ï¼Œç„¶å React ä¼šæŠŠè¿™äº›å˜åŒ–â€œ[æäº¤](https://react.docschina.org/learn/render-and-commit)â€åˆ° DOM ä¸­æ¥æ›´æ–°å±å¹•ï¼Œä¹‹åReactæ‰ä¼šæ‰§è¡Œä½ çš„Effectï¼Œä½†æ˜¯æ­¤æ—¶ä½ çš„ç›®çš„å·²ç»è¾¾åˆ°äº†ï¼ŒEffectåªæ˜¯åšäº†ä¸€æ ·çš„æ“ä½œ
- **ä½¿ç”¨Effectå¤„ç†ç”¨æˆ·äº‹ä»¶**ï¼Œä¾‹å¦‚ï¼Œä½ æƒ³åœ¨ç”¨æˆ·è´­ä¹°ä¸€ä¸ªäº§å“æ—¶å‘é€ä¸€ä¸ª `/api/buy` çš„ POST è¯·æ±‚å¹¶å±•ç¤ºä¸€ä¸ªæç¤ºã€‚åœ¨è¿™ä¸ªè´­ä¹°æŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶å¤„ç†å‡½æ•°ä¸­ï¼Œä½ ç¡®åˆ‡åœ°çŸ¥é“ä¼šå‘ç”Ÿä»€ä¹ˆã€‚ä½†æ˜¯å½“ä¸€ä¸ª Effect è¿è¡Œæ—¶ï¼Œä½ å´ä¸çŸ¥é“ç”¨æˆ·åšäº†ä»€ä¹ˆï¼ˆä¾‹å¦‚ï¼Œç‚¹å‡»äº†å“ªä¸ªæŒ‰é’®ï¼‰ã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆä½ é€šå¸¸åº”è¯¥åœ¨ç›¸åº”çš„äº‹ä»¶å¤„ç†å‡½æ•°ä¸­å¤„ç†ç”¨æˆ·äº‹ä»¶ã€‚



ä¸‹é¢æ˜¯ä¸€äº›å®ä¾‹ï¼š



### ä¸€äº›ä¾‹å­

#### æ ¹æ®propæˆ–stateæ¥æ›´æ–°state

å‡è®¾ä½ æœ‰ä¸€ä¸ªåŒ…å«äº†ä¸¤ä¸ª state å˜é‡çš„ç»„ä»¶ï¼š`firstName` å’Œ `lastName`ã€‚ä½ æƒ³é€šè¿‡æŠŠå®ƒä»¬è”ç»“èµ·æ¥è®¡ç®—å‡º `fullName`ã€‚æ­¤å¤–ï¼Œæ¯å½“ `firstName` å’Œ `lastName` å˜åŒ–æ—¶ï¼Œä½ å¸Œæœ› `fullName` éƒ½èƒ½æ›´æ–°ã€‚ä½ çš„ç¬¬ä¸€ç›´è§‰å¯èƒ½æ˜¯æ·»åŠ ä¸€ä¸ª state å˜é‡ï¼š`fullName`ï¼Œå¹¶åœ¨ä¸€ä¸ª Effect ä¸­æ›´æ–°å®ƒï¼š

```jsx
function Form() {
  const [firstName, setFirstName] = useState('Taylor');
  const [lastName, setLastName] = useState('Swift');

  // ğŸ”´ é¿å…ï¼šå¤šä½™çš„ state å’Œä¸å¿…è¦çš„ Effect
  const [fullName, setFullName] = useState('');
  useEffect(() => {
    setFullName(firstName + ' ' + lastName);
  }, [firstName, lastName]);
  // ...
}
```

å¤§å¯ä¸å¿…è¿™ä¹ˆå¤æ‚ã€‚è€Œä¸”è¿™æ ·æ•ˆç‡ä¹Ÿä¸é«˜ï¼šå®ƒå…ˆæ˜¯ç”¨ `fullName` çš„æ—§å€¼æ‰§è¡Œäº†æ•´ä¸ªæ¸²æŸ“æµç¨‹ï¼Œç„¶åç«‹å³ä½¿ç”¨æ›´æ–°åçš„å€¼åˆé‡æ–°æ¸²æŸ“äº†ä¸€éã€‚è®©æˆ‘ä»¬ç§»é™¤ state å˜é‡å’Œ Effectï¼š

```jsx
function Form() {
  const [firstName, setFirstName] = useState('Taylor');
  const [lastName, setLastName] = useState('Swift');
  // âœ… éå¸¸å¥½ï¼šåœ¨æ¸²æŸ“æœŸé—´è¿›è¡Œè®¡ç®—
  const fullName = firstName + ' ' + lastName;
  // ...
}
```

æ€»ç»“ï¼š**å¦‚æœä¸€ä¸ªå€¼å¯ä»¥åŸºäºç°æœ‰çš„propsæˆ–stateè®¡ç®—å¾—åˆ°ï¼Œé‚£ä¹ˆå°±ä¸è¦å°†å…¶ä½œä¸ºä¸€ä¸ªstateï¼Œè€Œæ˜¯åœ¨æ¸²æŸ“è¿‡ç¨‹ä¸­ç›´æ¥è®¡ç®—å³å¯**



#### ç¼“å­˜æ˜‚è´µçš„è®¡ç®—

å¦‚ä¸‹è¿™ä¸ªä¾‹å­ä¸­ï¼Œç»„ä»¶ä½¿ç”¨æ¥å—åˆ°çš„propsä¸­çš„filterå¯¹å¦ä¸€ä¸ªpropsä¸­çš„todosè¿›è¡Œç­›é€‰ï¼Œè®¡ç®—å¾—åˆ°æ¸²æŸ“éœ€è¦çš„æ•°æ®ï¼Œæ ¹æ®ä¸Šä¸€ä¸ªä¾‹å­ï¼Œæˆ‘ä»¬çŸ¥é“æˆ‘ä»¬ä¼šè¿™ä¹ˆåšäº†

```jsx
function TodoList({ todos, filter }) {
  const [newTodo, setNewTodo] = useState('');
  // âœ… å¦‚æœ getFilteredTodos() çš„è€—æ—¶ä¸é•¿ï¼Œè¿™æ ·å†™å°±å¯ä»¥äº†ã€‚
  const visibleTodos = getFilteredTodos(todos, filter);
  // ...
}
```

ä¸€èˆ¬æ¥è¯´ï¼Œè¿™æ®µä»£ç æ²¡æœ‰é—®é¢˜ï¼ä½†æ˜¯ï¼Œ`getFilteredTodos()` çš„è€—æ—¶å¯èƒ½ä¼šå¾ˆé•¿ï¼Œæˆ–è€…ä½ æœ‰å¾ˆå¤š `todos`

ä½†æ˜¯ï¼ï¼ï¼å½“`newTodo`è¿™æ ·å…¶ä»–ä¸ç›¸å¹²çš„stateå˜åŒ–å¯¼è‡´ç»„ä»¶é‡æ–°æ¸²æŸ“ï¼Œé‚£ä¹ˆæˆ‘ä»¬åˆè¦é‡æ–°è®¡ç®—visibleTodosï¼Œå¯èƒ½é€ æˆä¸å¿…è¦çš„æˆæœ¬è®¡ç®—

ä½ å¯ä»¥ä½¿ç”¨ [`useMemo`](https://zh-hans.react.dev/reference/react/useMemo) Hook ç¼“å­˜ï¼ˆæˆ–è€…è¯´ [è®°å¿†ï¼ˆmemoizeï¼‰](https://en.wikipedia.org/wiki/Memoization)ï¼‰ä¸€ä¸ªæ˜‚è´µçš„è®¡ç®—ã€‚

```jsx
import { useMemo, useState } from 'react';

function TodoList({ todos, filter }) {
  const [newTodo, setNewTodo] = useState('');
  const visibleTodos = useMemo(() => {
    // âœ… é™¤é todos æˆ– filter å‘ç”Ÿå˜åŒ–ï¼Œå¦åˆ™ä¸ä¼šé‡æ–°æ‰§è¡Œ
    return getFilteredTodos(todos, filter);
  }, [todos, filter]);
  // ...
}
```

**è¿™ä¼šå‘Šè¯‰ Reactï¼Œé™¤é todos æˆ– filter å‘ç”Ÿå˜åŒ–ï¼Œå¦åˆ™ä¸è¦é‡æ–°æ‰§è¡Œä¼ å…¥çš„å‡½æ•°**ã€‚React ä¼šåœ¨åˆæ¬¡æ¸²æŸ“çš„æ—¶å€™è®°ä½ `getFilteredTodos()` çš„è¿”å›å€¼ã€‚åœ¨ä¸‹ä¸€æ¬¡æ¸²æŸ“ä¸­ï¼Œå®ƒä¼šæ£€æŸ¥ `todos` æˆ– `filter` æ˜¯å¦å‘ç”Ÿäº†å˜åŒ–ã€‚å¦‚æœå®ƒä»¬è·Ÿä¸Šæ¬¡æ¸²æŸ“æ—¶ä¸€æ ·ï¼Œ`useMemo` ä¼šç›´æ¥è¿”å›å®ƒæœ€åä¿å­˜çš„ç»“æœã€‚å¦‚æœä¸ä¸€æ ·ï¼ŒReact å°†å†æ¬¡è°ƒç”¨ä¼ å…¥çš„å‡½æ•°ï¼ˆå¹¶ä¿å­˜å®ƒçš„ç»“æœï¼‰ã€‚

**æ³¨æ„ï¼š**ä½ ä¼ å…¥`useMemo`çš„å‡½æ•°ä¼šåœ¨æ¸²æŸ“æœŸé—´æ‰§è¡Œï¼Œæ‰€ä»¥å®ƒä»…ä»…é€‚ç”¨äºçº¯å‡½æ•°åœºæ™¯



#### å½“propså˜åŒ–æ—¶é‡ç½®æ‰€æœ‰state

`ProfilePage` ç»„ä»¶æ¥æ”¶ä¸€ä¸ª propï¼š`userId`ã€‚é¡µé¢ä¸Šæœ‰ä¸€ä¸ªè¯„è®ºè¾“å…¥æ¡†ï¼Œä½ ç”¨äº†ä¸€ä¸ª stateï¼š`comment` æ¥ä¿å­˜å®ƒçš„å€¼

éœ€æ±‚ï¼šå¸Œæœ›åœ¨userIdå˜åŒ–æ—¶é‡ç½®é¡µé¢ä¸Šçš„è¡¨å•ï¼š

ä½ å¯èƒ½ä¼šè¿™ä¹ˆåšï¼š

```jsx
export default function ProfilePage({ userId }) {
  const [comment, setComment] = useState('');

  // ğŸ”´ é¿å…ï¼šå½“ prop å˜åŒ–æ—¶ï¼Œåœ¨ Effect ä¸­é‡ç½® state
  useEffect(() => {
    setComment('');
  }, [userId]);
  // ...
}
```

è¿™æ ·æ˜¯ä½æ•ˆçš„ï¼š

1. å› ä¸º `ProfilePage` å’Œå®ƒçš„å­ç»„ä»¶é¦–å…ˆä¼šç”¨æ—§å€¼æ¸²æŸ“ï¼Œç„¶åå†ç”¨æ–°å€¼é‡æ–°æ¸²æŸ“
2. å¦‚æœè¡¨å•æœ‰å¾ˆå¤šé¡¹ç›®å‘¢ï¼Œå¦‚æœè¡¨å•é¡¹æ˜¯åµŒå¥—çš„å‘¢ï¼ˆå°±éœ€è¦åœ¨useEffectä¸­å°†æ¯ä¸€ä¸ªè¡¨å•é¡¹ä¸­çš„stateéƒ½è¿›è¡Œé‡ç½®ï¼ï¼ï¼‰

æœ€å¥½çš„åšæ³•æ˜¯è¿™æ ·ï¼š

ä½ ä¸ºæ¯ä¸€ä¸ªç”¨æˆ·çš„ä¸ªäººè¡¨å•åˆ¶ä½œä¸ºä¸€ä¸ªç»„ä»¶ï¼Œå¹¶ä¸”æä¾›`key`å‘Šè¯‰Reactå®ƒä»¬æ˜¯ä¸åŒçš„ç»„ä»¶

```jsx
export default function ProfilePage({ userId }) {
  return (
    <Profile
      userId={userId}
      key={userId}
    />
  );
}

function Profile({ userId }) {
  // âœ… å½“ key å˜åŒ–æ—¶ï¼Œè¯¥ç»„ä»¶å†…çš„ comment æˆ–å…¶ä»– state ä¼šè‡ªåŠ¨è¢«é‡ç½®
  const [comment, setComment] = useState('');
  // ...
}
```

é€šè¿‡ä¹‹å‰çš„å­¦ä¹ æˆ‘ä»¬çŸ¥é“ï¼Œåœ¨ç›¸åŒçš„ä½ç½®æ¸²æŸ“åŒä¸€ä¸ªç»„ä»¶ï¼ŒReactä¼šä¿ç•™state

è€Œæˆ‘ä»¬**é€šè¿‡å°† userId ä½œä¸º key ä¼ é€’ç»™ Profile ç»„ä»¶ï¼Œä½¿  React å°†å…·æœ‰ä¸åŒ userId çš„ä¸¤ä¸ª Profile ç»„ä»¶è§†ä¸ºä¸¤ä¸ªä¸åº”å…±äº«ä»»ä½•çŠ¶æ€çš„ä¸åŒç»„ä»¶**ã€‚

å› æ­¤ï¼Œå½“`key`å˜åŒ–æ—¶Reactå°†ä¼šé‡æ–°åˆ›å»ºDOMï¼Œå¹¶ä¸”é‡ç½®`Profile`ç»„ä»¶å’Œå®ƒæ‰€æœ‰å­ç»„ä»¶çš„stateï¼Œæˆ‘ä»¬å°±è½»æ¾å®ç°äº†è¿™ä¸ªéœ€æ±‚



#### å½“propå˜åŒ–æ—¶è°ƒæ•´éƒ¨åˆ†state

æœ‰æ—¶å€™ï¼Œå½“ prop å˜åŒ–æ—¶ï¼Œä½ å¯èƒ½åªæƒ³é‡ç½®æˆ–è°ƒæ•´éƒ¨åˆ† state ï¼Œè€Œä¸æ˜¯æ‰€æœ‰ stateã€‚

`List` ç»„ä»¶æ¥æ”¶ä¸€ä¸ª `items` åˆ—è¡¨ä½œä¸º propï¼Œç„¶åç”¨ state å˜é‡ `selection` æ¥ä¿æŒå·²é€‰ä¸­çš„é¡¹ã€‚å½“ `items` æ¥æ”¶åˆ°ä¸€ä¸ªä¸åŒçš„æ•°ç»„æ—¶ï¼Œä½ æƒ³å°† `selection` é‡ç½®ä¸º `null`ï¼š

```jsx
function List({ items }) {
  const [isReverse, setIsReverse] = useState(false);
  const [selection, setSelection] = useState(null);

  // ğŸ”´ é¿å…ï¼šå½“ prop å˜åŒ–æ—¶ï¼Œåœ¨ Effect ä¸­è°ƒæ•´ state
  useEffect(() => {
    setSelection(null);
  }, [items]);
  // ...
}
```

è¿™æ ·çš„åšæ³•è¿˜æ˜¯ä¸å¤ªå¥½ï¼Œå› ä¸ºæ¯å½“`item`å˜åŒ–æ—¶ï¼Œ`List`åŠå…¶å­ç»„ä»¶ä¼šå…ˆä½¿ç”¨æ—§çš„`selection`å€¼æ¸²æŸ“ï¼Œå¦‚ä½•Reactä¼šæ›´æ–°DOMå¹¶ä¸”æ‰§è¡ŒEffectï¼Œæœ€åæ‰è°ƒç”¨setSelection(null)ä½¿å¾—`List`åŠå…¶å­ç»„ä»¶é‡æ–°æ¸²æŸ“

å¥½ä¸€äº›çš„åšæ³•ï¼š

```jsx
function List({ items }) {
  const [isReverse, setIsReverse] = useState(false);
  const [selection, setSelection] = useState(null);

  // å¥½ä¸€äº›ï¼šåœ¨æ¸²æŸ“æœŸé—´è°ƒæ•´ state
  const [prevItems, setPrevItems] = useState(items);
  if (items !== prevItems) {
    setPrevItems(items);
    setSelection(null);
  }
  // ...
}
```

ä½†æ˜¯è¿™æ ·çš„ä»£ç ä¼šé™ä½ä»£ç çš„å¯è¯»æ€§ï¼Œä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œåœ¨æ¸²æŸ“è¿‡ç¨‹ä¸­ç›´æ¥è°ƒç”¨äº†`setSelection`ï¼Œå½“å®ƒæ‰§è¡Œåˆ°`return`è¯­å¥é€€å‡ºåï¼ŒReactå°†ä¼šç«‹å³é‡æ–°æ¸²æŸ“`List`ï¼Œä½†æ˜¯æ­¤æ—¶Reactè¿˜æ²¡æœ‰æ¸²æŸ“`List`çš„å­ç»„ä»¶æˆ–æ›´æ–°DOMï¼Œå› æ­¤ä½¿å¾—`List`çš„å­ç»„ä»¶å¯ä»¥è·³è¿‡æ¸²æŸ“æ—§çš„`selection`å€¼

**è™½ç„¶è¿™ç§æ–¹å¼æ¯” Effect æ›´é«˜æ•ˆï¼Œä½†å¤§å¤šæ•°ç»„ä»¶ä¹Ÿä¸éœ€è¦å®ƒ**ã€‚æ— è®ºä½ æ€ä¹ˆåšï¼Œæ ¹æ® props æˆ–å…¶ä»– state æ¥è°ƒæ•´ state éƒ½ä¼šä½¿æ•°æ®æµæ›´éš¾ç†è§£å’Œè°ƒè¯•ã€‚æ€»æ˜¯æ£€æŸ¥æ˜¯å¦å¯ä»¥é€šè¿‡æ·»åŠ  [key æ¥é‡ç½®æ‰€æœ‰ state](https://zh-hans.react.dev/learn/you-might-not-need-an-effect#resetting-all-state-when-a-prop-changes)ï¼Œæˆ–è€… [åœ¨æ¸²æŸ“æœŸé—´è®¡ç®—æ‰€éœ€å†…å®¹](https://zh-hans.react.dev/learn/you-might-not-need-an-effect#updating-state-based-on-props-or-state)ã€‚ä¾‹å¦‚ï¼Œä½ å¯ä»¥å­˜å‚¨å·²é€‰ä¸­çš„ **item ID** è€Œä¸æ˜¯å­˜å‚¨ï¼ˆå¹¶é‡ç½®ï¼‰å·²é€‰ä¸­çš„ **item**ï¼š

```jsx
function List({ items }) {
  const [isReverse, setIsReverse] = useState(false);
  const [selectedId, setSelectedId] = useState(null);
  // âœ… éå¸¸å¥½ï¼šåœ¨æ¸²æŸ“æœŸé—´è®¡ç®—æ‰€éœ€å†…å®¹
  const selection = items.find(item => item.id === selectedId) ?? null;
  // ...
}
```





#### åœ¨äº‹ä»¶å¤„ç†å‡½æ•°ä¸­å…±äº«é€»è¾‘

å‡è®¾ä½ ç°åœ¨å¤„äºä¸€ä¸ªäº§å“é¡µé¢ï¼Œé¡µé¢ä¸Šæ‹¥æœ‰ä¸¤ä¸ªæŒ‰é’®ï¼ˆè´­ä¹°å’Œä»˜æ¬¾ï¼‰ï¼Œéƒ½å¯ä»¥è®©ä½ è´­ä¹°è¯¥äº§å“ã€‚å½“ç”¨æˆ·å°†äº§å“æ·»åŠ è¿›è´­ç‰©è½¦æ—¶ï¼Œä½ æƒ³æ˜¾ç¤ºä¸€ä¸ªé€šçŸ¥ã€‚åœ¨ä¸¤ä¸ªæŒ‰é’®çš„ click äº‹ä»¶å¤„ç†å‡½æ•°ä¸­éƒ½è°ƒç”¨ `showNotification()` æ„Ÿè§‰æœ‰ç‚¹é‡å¤ï¼Œæ‰€ä»¥ä½ å¯èƒ½æƒ³æŠŠè¿™ä¸ªé€»è¾‘æ”¾åœ¨ä¸€ä¸ª Effect ä¸­ï¼š

```jsx
function ProductPage({ product, addToCart }) {
  // ğŸ”´ é¿å…ï¼šåœ¨ Effect ä¸­å¤„ç†å±äºäº‹ä»¶ç‰¹å®šçš„é€»è¾‘
  useEffect(() => {
    if (product.isInCart) {
      showNotification(`å·²æ·»åŠ  ${product.name} è¿›è´­ç‰©è½¦ï¼`);
    }
  }, [product]);

  function handleBuyClick() {
    addToCart(product);
  }

  function handleCheckoutClick() {
    addToCart(product);
    navigateTo('/checkout');
  }
  // ...
}
```

è¿™ä¸ª Effect æ˜¯å¤šä½™çš„ã€‚è€Œä¸”å¾ˆå¯èƒ½ä¼šå¯¼è‡´é—®é¢˜ã€‚

ä¾‹å¦‚ï¼Œå‡è®¾ä½ çš„åº”ç”¨åœ¨é¡µé¢é‡æ–°åŠ è½½ä¹‹å‰ â€œè®°ä½â€ äº†è´­ç‰©è½¦ä¸­çš„äº§å“ã€‚å¦‚æœä½ æŠŠä¸€ä¸ªäº§å“æ·»åŠ åˆ°è´­ç‰©è½¦ä¸­å¹¶åˆ·æ–°é¡µé¢ï¼Œé€šçŸ¥å°†å†æ¬¡å‡ºç°ã€‚æ¯æ¬¡åˆ·æ–°è¯¥äº§å“é¡µé¢æ—¶ï¼Œå®ƒéƒ½ä¼šå‡ºç°ã€‚è¿™æ˜¯å› ä¸º `product.isInCart` åœ¨é¡µé¢åŠ è½½æ—¶å·²ç»æ˜¯ `true` äº†ï¼Œæ‰€ä»¥ä¸Šé¢çš„ Effect æ¯æ¬¡éƒ½ä¼šè°ƒç”¨ `showNotification()`ã€‚

**å½“ä½ ä¸ç¡®å®šæŸäº›ä»£ç åº”è¯¥æ”¾åœ¨ Effect ä¸­è¿˜æ˜¯äº‹ä»¶å¤„ç†å‡½æ•°ä¸­æ—¶ï¼Œå…ˆè‡ªé—® ä¸ºä»€ä¹ˆ è¦æ‰§è¡Œè¿™äº›ä»£ç ã€‚Effect åªç”¨æ¥æ‰§è¡Œé‚£äº›æ˜¾ç¤ºç»™ç”¨æˆ·æ—¶ç»„ä»¶ éœ€è¦æ‰§è¡Œ çš„ä»£ç **ã€‚åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œé€šçŸ¥åº”è¯¥åœ¨ç”¨æˆ· **æŒ‰ä¸‹æŒ‰é’®** åå‡ºç°ï¼Œè€Œä¸æ˜¯å› ä¸ºé¡µé¢æ˜¾ç¤ºå‡ºæ¥æ—¶ï¼

åˆ é™¤ Effect å¹¶å°†å…±äº«çš„é€»è¾‘æ”¾å…¥ä¸€ä¸ªè¢«ä¸¤ä¸ªäº‹ä»¶å¤„ç†ç¨‹åºè°ƒç”¨çš„å‡½æ•°ä¸­ï¼š

```jsx
function ProductPage({ product, addToCart }) {
  // âœ… éå¸¸å¥½ï¼šäº‹ä»¶ç‰¹å®šçš„é€»è¾‘åœ¨äº‹ä»¶å¤„ç†å‡½æ•°ä¸­å¤„ç†
  function buyProduct() {
    addToCart(product);
    showNotification(`å·²æ·»åŠ  ${product.name} è¿›è´­ç‰©è½¦ï¼`);
  }

  function handleBuyClick() {
    buyProduct();
  }

  function handleCheckoutClick() {
    buyProduct();
    navigateTo('/checkout');
  }
  // ...
}
```



#### å‘é€POSTè¯·æ±‚

è¿™ä¸ª `Form` ç»„ä»¶ä¼šå‘é€ä¸¤ç§ POST è¯·æ±‚ã€‚å®ƒåœ¨é¡µé¢åŠ è½½ä¹‹é™…ä¼šå‘é€ä¸€ä¸ªåˆ†æè¯·æ±‚ã€‚å½“ä½ å¡«å†™è¡¨æ ¼å¹¶ç‚¹å‡»æäº¤æŒ‰é’®æ—¶ï¼Œå®ƒä¼šå‘ `/api/register` æ¥å£å‘é€ä¸€ä¸ª POST è¯·æ±‚ï¼š

```jsx
function Form() {
  const [firstName, setFirstName] = useState('');
  const [lastName, setLastName] = useState('');

  // âœ… éå¸¸å¥½ï¼šè¿™ä¸ªé€»è¾‘åº”è¯¥åœ¨ç»„ä»¶æ˜¾ç¤ºæ—¶æ‰§è¡Œ
  useEffect(() => {
    post('/analytics/event', { eventName: 'visit_form' });
  }, []);

  // ğŸ”´ é¿å…ï¼šåœ¨ Effect ä¸­å¤„ç†å±äºäº‹ä»¶ç‰¹å®šçš„é€»è¾‘
  const [jsonToSubmit, setJsonToSubmit] = useState(null);
  useEffect(() => {
    if (jsonToSubmit !== null) {
      post('/api/register', jsonToSubmit);
    }
  }, [jsonToSubmit]);

  function handleSubmit(e) {
    e.preventDefault();
    setJsonToSubmit({ firstName, lastName });
  }
  // ...
    
  function handleSubmit(e) {
    e.preventDefault();
    // âœ… éå¸¸å¥½ï¼šäº‹ä»¶ç‰¹å®šçš„é€»è¾‘åœ¨äº‹ä»¶å¤„ç†å‡½æ•°ä¸­å¤„ç†
    post('/api/register', { firstName, lastName });
  }
}
```

å¾ˆæ˜æ˜¾ï¼Œæˆ‘ä»¬åªæƒ³åœ¨ç”¨æˆ·ç‚¹å‡»æäº¤æ—¶å‘é€è¯·æ±‚ï¼Œè€Œä¸æ˜¯åœ¨é¡µé¢è¡¨å•æ•°æ®è¢«ä¿®æ”¹æ—¶å‘é€è¯·æ±‚ï¼



#### é“¾å¼è®¡ç®—

æœ‰æ—¶å€™ä½ å¯èƒ½æƒ³é“¾æ¥å¤šä¸ª Effectï¼Œæ¯ä¸ª Effect éƒ½åŸºäºæŸäº› state æ¥è°ƒæ•´å…¶ä»–çš„ stateï¼š

å¦‚ä¸‹æ˜¯ä¸€ä¸ªå…³äºæ¸¸æˆçš„ä¾‹å­ï¼š

```jsx
function Game() {
  const [card, setCard] = useState(null);
  const [goldCardCount, setGoldCardCount] = useState(0);
  const [round, setRound] = useState(1);
  const [isGameOver, setIsGameOver] = useState(false);

  // ğŸ”´ é¿å…ï¼šé“¾æ¥å¤šä¸ª Effect ä»…ä»…ä¸ºäº†ç›¸äº’è§¦å‘è°ƒæ•´ state
  useEffect(() => {
    if (card !== null && card.gold) {
      setGoldCardCount(c => c + 1);
    }
  }, [card]);

  useEffect(() => {
    if (goldCardCount > 3) {
      setRound(r => r + 1)
      setGoldCardCount(0);
    }
  }, [goldCardCount]);

  useEffect(() => {
    if (round > 5) {
      setIsGameOver(true);
    }
  }, [round]);

  useEffect(() => {
    alert('æ¸¸æˆç»“æŸï¼');
  }, [isGameOver]);

  function handlePlaceCard(nextCard) {
    if (isGameOver) {
      throw Error('æ¸¸æˆå·²ç»ç»“æŸäº†ã€‚');
    } else {
      setCard(nextCard);
    }
  }
```

åœ¨å¡ç‰‡æ•°é‡æ”¹å˜æ—¶å…¶ä½™çš„ç›¸å…³å˜é‡ä¹Ÿéœ€è¦æ”¹å˜

è¿™æ®µä»£ç é‡Œæœ‰ä¸¤ä¸ªé—®é¢˜ã€‚

ä¸€ä¸ªé—®é¢˜æ˜¯å®ƒéå¸¸ä½æ•ˆï¼šåœ¨é“¾å¼çš„æ¯ä¸ª `set` è°ƒç”¨ä¹‹é—´ï¼Œç»„ä»¶ï¼ˆåŠå…¶å­ç»„ä»¶ï¼‰éƒ½ä¸å¾—ä¸é‡æ–°æ¸²æŸ“ã€‚åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œåœ¨æœ€åçš„æƒ…å†µä¸‹ï¼ˆ`setCard` â†’ æ¸²æŸ“ â†’ `setGoldCardCount` â†’ æ¸²æŸ“ â†’ `setRound` â†’ æ¸²æŸ“ â†’ `setIsGameOver` â†’ æ¸²æŸ“ï¼‰æœ‰ä¸‰æ¬¡ä¸å¿…è¦çš„é‡æ–°æ¸²æŸ“ã€‚

å³ä½¿ä¸è€ƒè™‘æ¸²æŸ“æ•ˆç‡é—®é¢˜ï¼Œéšç€ä»£ç ä¸æ–­æ‰©å±•ï¼Œä½ ä¼šé‡åˆ°è¿™æ¡ â€œé“¾å¼â€ è°ƒç”¨ä¸ç¬¦åˆæ–°éœ€æ±‚çš„æƒ…å†µã€‚è¯•æƒ³ä¸€ä¸‹ï¼Œä½ ç°åœ¨éœ€è¦æ·»åŠ ä¸€ç§æ–¹æ³•æ¥å›æº¯æ¸¸æˆçš„å†å²è®°å½•ï¼Œå¯ä»¥é€šè¿‡æ›´æ–°æ¯ä¸ª state å˜é‡åˆ°ä¹‹å‰çš„å€¼æ¥å®ç°ã€‚ç„¶è€Œï¼Œå°† `card` è®¾ç½®ä¸ºä¹‹å‰çš„çš„æŸä¸ªå€¼ä¼šå†æ¬¡è§¦å‘ Effect é“¾å¹¶æ›´æ”¹ä½ æ­£åœ¨æ˜¾ç¤ºçš„æ•°æ®ã€‚è¿™æ ·çš„ä»£ç å¾€å¾€æ˜¯åƒµç¡¬è€Œè„†å¼±çš„ã€‚

åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæ›´å¥½çš„åšæ³•æ˜¯ï¼šå°½å¯èƒ½åœ¨æ¸²æŸ“æœŸé—´è¿›è¡Œè®¡ç®—ï¼Œä»¥åŠåœ¨äº‹ä»¶å¤„ç†å‡½æ•°ä¸­è°ƒæ•´ stateï¼š

```jsx
function Game() {
  const [card, setCard] = useState(null);
  const [goldCardCount, setGoldCardCount] = useState(0);
  const [round, setRound] = useState(1);

  // âœ… å°½å¯èƒ½åœ¨æ¸²æŸ“æœŸé—´è¿›è¡Œè®¡ç®—
  const isGameOver = round > 5;

  function handlePlaceCard(nextCard) {
    if (isGameOver) {
      throw Error('æ¸¸æˆå·²ç»ç»“æŸäº†ã€‚');
    }

    // âœ… åœ¨äº‹ä»¶å¤„ç†å‡½æ•°ä¸­è®¡ç®—å‰©ä¸‹çš„æ‰€æœ‰ state
    setCard(nextCard);
    if (nextCard.gold) {
      if (goldCardCount <= 3) {
        setGoldCardCount(goldCardCount + 1);
      } else {
        setGoldCardCount(0);
        setRound(round + 1);
        if (round === 5) {
          alert('æ¸¸æˆç»“æŸï¼');
        }
      }
    }
  }

  // ...
```

å¦‚æœä½ å®ç°äº†ä¸€ä¸ªå›æº¯æ¸¸æˆå†å²çš„æ–¹æ³•ï¼Œç°åœ¨ä½ å¯ä»¥å°†æ¯ä¸ª state å˜é‡è®¾ç½®ä¸ºä¹‹å‰çš„ä»»ä½•çš„ä¸€ä¸ªå€¼ï¼Œè€Œä¸ä¼šè§¦å‘æ¯ä¸ªè°ƒæ•´å…¶ä»–å€¼çš„ Effect é“¾

> å€¼å¾—ä¸€æçš„æ˜¯ï¼š
>
> åœ¨äº‹ä»¶å¤„ç†å‡½æ•°å†…éƒ¨ï¼Œ[state çš„è¡Œä¸ºç±»ä¼¼å¿«ç…§](https://react.docschina.org/learn/state-as-a-snapshot)ã€‚ä¾‹å¦‚ï¼Œå³ä½¿ä½ è°ƒç”¨äº† `setRound(round + 1)`ï¼Œ`round` å˜é‡ä»ç„¶æ˜¯ç”¨æˆ·ç‚¹å‡»æŒ‰é’®æ—¶çš„å€¼ã€‚å¦‚æœä½ éœ€è¦ä½¿ç”¨ä¸‹ä¸€ä¸ªå€¼è¿›è¡Œè®¡ç®—ï¼Œåˆ™éœ€è¦åƒè¿™æ ·æ‰‹åŠ¨å®šä¹‰å®ƒï¼š`const nextRound = round + 1`ã€‚
>
> åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œä½ **æ— æ³•** åœ¨äº‹ä»¶å¤„ç†å‡½æ•°ä¸­ç›´æ¥è®¡ç®—å‡ºä¸‹ä¸€ä¸ª stateã€‚ä¾‹å¦‚ï¼Œè¯•æƒ³ä¸€ä¸ªå…·æœ‰å¤šä¸ªä¸‹æ‹‰èœå•çš„è¡¨å•ï¼Œå¦‚æœä¸‹ä¸€ä¸ªä¸‹æ‹‰èœå•çš„é€‰é¡¹å–å†³äºå‰ä¸€ä¸ªä¸‹æ‹‰èœå•é€‰æ‹©çš„å€¼ã€‚**è¿™æ—¶ï¼ŒEffect é“¾æ˜¯åˆé€‚çš„**ï¼Œå› ä¸ºä½ éœ€è¦ä¸ç½‘ç»œè¿›è¡ŒåŒæ­¥ã€‚



#### åˆå§‹åŒ–åº”ç”¨

æœ‰äº›é€»è¾‘åªéœ€è¦åœ¨åº”ç”¨åŠ è½½æ—¶æ‰§è¡Œä¸€æ¬¡ã€‚

ä½ å¯èƒ½æƒ³æŠŠå®ƒæ”¾åœ¨ä¸€ä¸ªé¡¶å±‚ç»„ä»¶çš„ Effect ä¸­ï¼š

```jsx
function App() {
  // ğŸ”´ é¿å…ï¼šæŠŠåªéœ€è¦æ‰§è¡Œä¸€æ¬¡çš„é€»è¾‘æ”¾åœ¨ Effect ä¸­
  useEffect(() => {
    loadDataFromLocalStorage();
    checkAuthToken();
  }, []);
  // ...
}
```

ç„¶åï¼Œä½ å¾ˆå¿«å°±ä¼šå‘ç°å®ƒåœ¨ [å¼€å‘ç¯å¢ƒä¼šæ‰§è¡Œä¸¤æ¬¡](https://react.docschina.org/learn/synchronizing-with-effects#how-to-handle-the-effect-firing-twice-in-development)ã€‚è¿™ä¼šå¯¼è‡´ä¸€äº›é—®é¢˜â€”â€”ä¾‹å¦‚ï¼Œå®ƒå¯èƒ½ä½¿èº«ä»½éªŒè¯ token æ— æ•ˆï¼Œå› ä¸ºè¯¥å‡½æ•°ä¸æ˜¯ä¸ºè¢«è°ƒç”¨ä¸¤æ¬¡è€Œè®¾è®¡çš„ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œå½“ç»„ä»¶é‡æ–°æŒ‚è½½æ—¶åº”è¯¥å…·æœ‰ä¸€è‡´æ€§ã€‚åŒ…æ‹¬ä½ çš„é¡¶å±‚ `App` ç»„ä»¶

å°½ç®¡åœ¨å®é™…çš„ç”Ÿäº§ç¯å¢ƒä¸­å› ä¸ºå®ƒæ˜¯é¡¶çº§ç»„ä»¶å®ƒå¯èƒ½æ°¸è¿œä¸ä¼šè¢«é‡æ–°æŒ‚è½½

å¦‚æœæŸäº›é€»è¾‘å¿…é¡»åœ¨ **æ¯æ¬¡åº”ç”¨åŠ è½½æ—¶æ‰§è¡Œä¸€æ¬¡**ï¼Œè€Œä¸æ˜¯åœ¨ **æ¯æ¬¡ç»„ä»¶æŒ‚è½½æ—¶æ‰§è¡Œä¸€æ¬¡**ï¼Œå¯ä»¥æ·»åŠ ä¸€ä¸ªé¡¶å±‚å˜é‡æ¥è®°å½•å®ƒæ˜¯å¦å·²ç»æ‰§è¡Œè¿‡äº†ï¼š

```jsx
let didInit = false;

function App() {
  useEffect(() => {
    if (!didInit) {
      didInit = true;
      // âœ… åªåœ¨æ¯æ¬¡åº”ç”¨åŠ è½½æ—¶æ‰§è¡Œä¸€æ¬¡
      loadDataFromLocalStorage();
      checkAuthToken();
    }
  }, []);
  // ...
}
```

ä½ ä¹Ÿå¯ä»¥åœ¨æ¨¡å—åˆå§‹åŒ–å’Œåº”ç”¨æ¸²æŸ“ä¹‹å‰æ‰§è¡Œå®ƒï¼š

```jsx
if (typeof window !== 'undefined') { // æ£€æµ‹æˆ‘ä»¬æ˜¯å¦åœ¨æµè§ˆå™¨ç¯å¢ƒ
   // âœ… åªåœ¨æ¯æ¬¡åº”ç”¨åŠ è½½æ—¶æ‰§è¡Œä¸€æ¬¡
  checkAuthToken();
  loadDataFromLocalStorage();
}

function App() {
  // ...
}
```

å½“ç„¶è¿™ç§åšæ³•ä¹Ÿæœ‰ç¼ºç‚¹ï¼š

é¡¶å±‚ä»£ç ä¼šåœ¨ç»„ä»¶è¢«**å¯¼å…¥**æ—¶æ‰§è¡Œä¸€æ¬¡ï¼Œå³ä½¿ç»„ä»¶å¹¶æœªè¢«æ¸²æŸ“ï¼Œä¸ºäº†é¿å…åœ¨å¯¼å…¥ä»»æ„ç»„ä»¶æ—¶é™ä½æ€§èƒ½æˆ–äº§ç”Ÿæ„å¤–è¡Œä¸ºï¼Œ**è¯·ä¸è¦è¿‡åº¦ä½¿ç”¨è¿™ç§æ–¹æ³•**ï¼Œå»ºè®®å°†åº”ç”¨çº§åˆ«çš„åˆå§‹åŒ–é€»è¾‘ä¿ç•™åœ¨åƒ `App.js` è¿™æ ·çš„æ ¹ç»„ä»¶æ¨¡å—æˆ–ä½ çš„åº”ç”¨å…¥å£ä¸­



#### é€šçŸ¥çˆ¶ç»„ä»¶æœ‰å…³stateå˜åŒ–çš„ä¿¡æ¯

å‡è®¾ä½ æ­£åœ¨ç¼–å†™ä¸€ä¸ªæœ‰å…·æœ‰å†…éƒ¨ state `isOn` çš„ `Toggle` ç»„ä»¶ï¼Œè¯¥ state å¯ä»¥æ˜¯ `true` æˆ– `false`ã€‚æœ‰å‡ ç§ä¸åŒçš„æ–¹å¼æ¥è¿›è¡Œåˆ‡æ¢ï¼ˆé€šè¿‡ç‚¹å‡»æˆ–æ‹–åŠ¨ï¼‰ã€‚ä½ å¸Œæœ›åœ¨ `Toggle` çš„ state å˜åŒ–æ—¶é€šçŸ¥çˆ¶ç»„ä»¶ï¼Œå› æ­¤ä½ æš´éœ²äº†ä¸€ä¸ª `onChange` äº‹ä»¶å¹¶åœ¨ `Effect` ä¸­è°ƒç”¨å®ƒï¼š

```jsx
function Toggle({ onChange }) {
  const [isOn, setIsOn] = useState(false);

  // ğŸ”´ é¿å…ï¼šonChange å¤„ç†å‡½æ•°æ‰§è¡Œçš„æ—¶é—´å¤ªæ™šäº†
  useEffect(() => {
    onChange(isOn);
  }, [isOn, onChange])

  function handleClick() {
    setIsOn(!isOn);
  }

  function handleDragEnd(e) {
    if (isCloserToRightEdge(e)) {
      setIsOn(true);
    } else {
      setIsOn(false);
    }
  }

  // ...
}
```

Reactæ‰§è¡Œè¿‡ç¨‹ï¼š`Toggle`é¦–å…ˆæ›´æ–°è‡ªå·±çš„stateï¼Œç„¶åReactå°†å…¶æ¸²æŸ“åˆ°å±å¹•ä¸Šï¼Œå†æ‰§è¡ŒEffectä¸­çš„ä»£ç æ‰å»è°ƒç”¨çˆ¶ç»„ä»¶çš„`onChange`å‡½æ•°ï¼Œçˆ¶ç»„ä»¶æ‰å¼€å§‹æ›´æ–°è‡ªå·±çš„stateï¼Œå†æ¬¡å¼€å¯ä¸€æ¬¡æ¸²æŸ“ã€‚ã€‚ã€‚

åˆ é™¤ Effectï¼Œå¹¶åœ¨åŒä¸€ä¸ªäº‹ä»¶å¤„ç†å‡½æ•°ä¸­æ›´æ–° **ä¸¤ä¸ª** ç»„ä»¶çš„ stateï¼š

```jsx
function Toggle({ onChange }) {
  const [isOn, setIsOn] = useState(false);

  function updateToggle(nextIsOn) {
    // âœ… éå¸¸å¥½ï¼šåœ¨è§¦å‘å®ƒä»¬çš„äº‹ä»¶ä¸­æ‰§è¡Œæ‰€æœ‰æ›´æ–°
    setIsOn(nextIsOn);
    onChange(nextIsOn);
  }

  function handleClick() {
    updateToggle(!isOn);
  }

  function handleDragEnd(e) {
    if (isCloserToRightEdge(e)) {
      updateToggle(true);
    } else {
      updateToggle(false);
    }
  }

  // ...
}
```

é€šè¿‡è¿™ç§æ–¹å¼ï¼ŒReactä¼šæ‰¹é‡å¤„ç†æ¥è‡ªä¸åŒç»„ä»¶çš„æ›´æ–°ï¼Œæ‰€ä»¥åªæœ‰ä¸€æ¬¡æ¸²æŸ“

ä½ ä¹Ÿå¯ä»¥å®Œå…¨ç§»é™¤è¯¥ stateï¼Œå¹¶ä»çˆ¶ç»„ä»¶ä¸­æ¥æ”¶ `isOn`ï¼š

```jsx
// âœ… ä¹Ÿå¾ˆå¥½ï¼šè¯¥ç»„ä»¶å®Œå…¨ç”±å®ƒçš„çˆ¶ç»„ä»¶æ§åˆ¶
function Toggle({ isOn, onChange }) {
  function handleClick() {
    onChange(!isOn);
  }

  function handleDragEnd(e) {
    if (isCloserToRightEdge(e)) {
      onChange(true);
    } else {
      onChange(false);
    }
  }

  // ...
}
```

â€œ[çŠ¶æ€æå‡](https://react.docschina.org/learn/sharing-state-between-components)â€ å…è®¸çˆ¶ç»„ä»¶é€šè¿‡åˆ‡æ¢è‡ªèº«çš„ state æ¥å®Œå…¨æ§åˆ¶ `Toggle` ç»„ä»¶ã€‚è¿™æ„å‘³ç€çˆ¶ç»„ä»¶ä¼šåŒ…å«æ›´å¤šçš„é€»è¾‘ï¼Œä½†æ•´ä½“ä¸Šéœ€è¦å…³å¿ƒçš„çŠ¶æ€å˜å°‘äº†ã€‚æ¯å½“ä½ å°è¯•ä¿æŒä¸¤ä¸ªä¸åŒçš„ state å˜é‡ä¹‹é—´çš„åŒæ­¥æ—¶ï¼Œè¯•è¯•çŠ¶æ€æå‡ï¼



#### å°†æ•°æ®ä¼ é€’ç»™çˆ¶ç»„ä»¶

`Child` ç»„ä»¶è·å–äº†ä¸€äº›æ•°æ®å¹¶åœ¨ Effect ä¸­ä¼ é€’ç»™ `Parent` ç»„ä»¶ï¼š

```jsx
function Parent() {
  const [data, setData] = useState(null);
  // ...
  return <Child onFetched={setData} />;
}

function Child({ onFetched }) {
  const data = useSomeAPI();
  // ğŸ”´ é¿å…ï¼šåœ¨ Effect ä¸­ä¼ é€’æ•°æ®ç»™çˆ¶ç»„ä»¶
  useEffect(() => {
    if (data) {
      onFetched(data);
    }
  }, [onFetched, data]);
  // ...
}
```

åœ¨ React ä¸­ï¼Œæ•°æ®ä»çˆ¶ç»„ä»¶æµå‘å­ç»„ä»¶ã€‚å½“ä½ åœ¨å±å¹•ä¸Šçœ‹åˆ°äº†ä¸€äº›é”™è¯¯æ—¶ï¼Œä½ å¯ä»¥é€šè¿‡ä¸€è·¯è¿½è¸ªç»„ä»¶æ ‘æ¥å¯»æ‰¾é”™è¯¯ä¿¡æ¯æ˜¯ä»å“ªä¸ªç»„ä»¶ä¼ é€’ä¸‹æ¥çš„ï¼Œä»è€Œæ‰¾åˆ°ä¼ é€’äº†é”™è¯¯çš„ prop æˆ–å…·æœ‰é”™è¯¯çš„ state çš„ç»„ä»¶ã€‚å½“å­ç»„ä»¶åœ¨ Effect ä¸­æ›´æ–°å…¶çˆ¶ç»„ä»¶çš„ state æ—¶ï¼Œæ•°æ®æµå˜å¾—éå¸¸éš¾ä»¥è¿½è¸ªã€‚æ—¢ç„¶å­ç»„ä»¶å’Œçˆ¶ç»„ä»¶éƒ½éœ€è¦ç›¸åŒçš„æ•°æ®ï¼Œé‚£ä¹ˆå¯ä»¥è®©çˆ¶ç»„ä»¶è·å–é‚£äº›æ•°æ®ï¼Œå¹¶å°†å…¶ **å‘ä¸‹ä¼ é€’** ç»™å­ç»„ä»¶ï¼š

```jsx
function Parent() {
  const data = useSomeAPI();
  // ...
  // âœ… éå¸¸å¥½ï¼šå‘å­ç»„ä»¶ä¼ é€’æ•°æ®
  return <Child data={data} />;
}

function Child({ data }) {
  // ...
}
```



#### è®¢é˜…å¤–éƒ¨store

æœ‰æ—¶å€™ï¼Œä½ çš„ç»„ä»¶å¯èƒ½éœ€è¦è®¢é˜… React state ä¹‹å¤–çš„ä¸€äº›æ•°æ®ã€‚è¿™äº›æ•°æ®å¯èƒ½æ¥è‡ªç¬¬ä¸‰æ–¹åº“æˆ–å†…ç½®æµè§ˆå™¨ APIã€‚ç”±äºè¿™äº›æ•°æ®å¯èƒ½åœ¨ React æ— æ³•æ„ŸçŸ¥çš„æƒ…å†µä¸‹å‘å˜åŒ–ï¼Œä½ éœ€è¦åœ¨ä½ çš„ç»„ä»¶ä¸­æ‰‹åŠ¨è®¢é˜…å®ƒä»¬ã€‚è¿™ç»å¸¸ä½¿ç”¨ Effect æ¥å®ç°ï¼Œä¾‹å¦‚ï¼š

```jsx
function useOnlineStatus() {
  // ä¸ç†æƒ³ï¼šåœ¨ Effect ä¸­æ‰‹åŠ¨è®¢é˜… store
  const [isOnline, setIsOnline] = useState(true);
  useEffect(() => {
    function updateState() {
      setIsOnline(navigator.onLine);
    }

    updateState();

    window.addEventListener('online', updateState);
    window.addEventListener('offline', updateState);
    return () => {
      window.removeEventListener('online', updateState);
      window.removeEventListener('offline', updateState);
    };
  }, []);
  return isOnline;
}

function ChatIndicator() {
  const isOnline = useOnlineStatus();
  // ...
}
```

è¿™ä¸ªç»„ä»¶è®¢é˜…äº†ä¸€ä¸ªå¤–éƒ¨çš„ store æ•°æ®ï¼ˆåœ¨è¿™é‡Œï¼Œæ˜¯æµè§ˆå™¨çš„ `navigator.onLine` APIï¼‰ã€‚ç”±äºè¿™ä¸ª API åœ¨æœåŠ¡ç«¯ä¸å­˜åœ¨ï¼ˆå› æ­¤ä¸èƒ½ç”¨äºåˆå§‹çš„ HTMLï¼‰ï¼Œå› æ­¤ state æœ€åˆè¢«è®¾ç½®ä¸º `true`ã€‚æ¯å½“æµè§ˆå™¨ store ä¸­çš„å€¼å‘ç”Ÿå˜åŒ–æ—¶ï¼Œç»„ä»¶éƒ½ä¼šæ›´æ–°å®ƒçš„ stateã€‚

å®é™…ä¸Šï¼ŒReactä¸ºæˆ‘ä»¬æä¾›äº†ä¸€ä¸ªHookä¸“é—¨ç”¨äºè®¢é˜…å¤–éƒ¨storeï¼Œå³[`useSyncExternalStore`](https://react.docschina.org/reference/react/useSyncExternalStore),ä¸æ‰‹åŠ¨ä½¿ç”¨ Effect å°†å¯å˜æ•°æ®åŒæ­¥åˆ° React state ç›¸æ¯”ï¼Œ**è¿™ç§æ–¹æ³•èƒ½å‡å°‘é”™è¯¯**ã€‚

```jsx
function subscribe(callback) {
  window.addEventListener('online', callback);
  window.addEventListener('offline', callback);
  return () => {
    window.removeEventListener('online', callback);
    window.removeEventListener('offline', callback);
  };
}

function useOnlineStatus() {
  // âœ… éå¸¸å¥½ï¼šç”¨å†…ç½®çš„ Hook è®¢é˜…å¤–éƒ¨ store
  return useSyncExternalStore(
    subscribe, // åªè¦ä¼ é€’çš„æ˜¯åŒä¸€ä¸ªå‡½æ•°ï¼ŒReact ä¸ä¼šé‡æ–°è®¢é˜…
    () => navigator.onLine, // å¦‚ä½•åœ¨å®¢æˆ·ç«¯è·å–å€¼
    () => true // å¦‚ä½•åœ¨æœåŠ¡ç«¯è·å–å€¼
  );
}

function ChatIndicator() {
  const isOnline = useOnlineStatus();
  // ...
}
```



#### å‘è¯·æ±‚è·å–æ•°æ®

è®¸å¤šåº”ç”¨ä½¿ç”¨ Effect æ¥å‘èµ·æ•°æ®è·å–è¯·æ±‚ã€‚åƒè¿™æ ·åœ¨ Effect ä¸­å†™ä¸€ä¸ªæ•°æ®è·å–è¯·æ±‚æ˜¯ç›¸å½“å¸¸è§çš„ï¼š

```jsx
function SearchResults({ query }) {
  const [results, setResults] = useState([]);
  const [page, setPage] = useState(1);

  useEffect(() => {
    // ğŸ”´ é¿å…ï¼šæ²¡æœ‰æ¸…é™¤é€»è¾‘çš„è·å–æ•°æ®
    fetchResults(query, page).then(json => {
      setResults(json);
    });
  }, [query, page]);

  function handleNextPageClick() {
    setPage(page + 1);
  }
  // ...
}
```

`page` å’Œ `query` çš„æ¥æºå…¶å®å¹¶ä¸é‡è¦ã€‚åªè¦è¯¥ç»„ä»¶å¯è§ï¼Œä½ å°±éœ€è¦é€šè¿‡å½“å‰ `page` å’Œ `query` çš„å€¼ï¼Œä¿æŒ `results` å’Œç½‘ç»œæ•°æ®çš„ [åŒæ­¥](https://react.docschina.org/learn/synchronizing-with-effects)ã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆè¿™é‡Œæ˜¯ä¸€ä¸ª Effect çš„åŸå› ã€‚

ç„¶è€Œï¼Œä¸Šé¢çš„ä»£ç æœ‰ä¸€ä¸ªé—®é¢˜ã€‚å‡è®¾ä½ å¿«é€Ÿåœ°è¾“å…¥ `â€œhelloâ€`ã€‚é‚£ä¹ˆ `query` ä¼šä» `â€œhâ€` å˜æˆ `â€œheâ€`ï¼Œ`â€œhelâ€`ï¼Œ`â€œhellâ€` æœ€åæ˜¯ `â€œhelloâ€`ã€‚è¿™ä¼šè§¦å‘ä¸€è¿ä¸²ä¸åŒçš„æ•°æ®è·å–è¯·æ±‚ï¼Œä½†æ— æ³•ä¿è¯å¯¹åº”çš„è¿”å›é¡ºåºã€‚ä¾‹å¦‚ï¼Œ`â€œhellâ€` çš„å“åº”å¯èƒ½åœ¨ `â€œhelloâ€` çš„å“åº” **ä¹‹å** è¿”å›ã€‚ç”±äºå®ƒçš„ `setResults()` æ˜¯åœ¨æœ€åè¢«è°ƒç”¨çš„ï¼Œä½ å°†ä¼šæ˜¾ç¤ºé”™è¯¯çš„æœç´¢ç»“æœã€‚è¿™ç§æƒ…å†µè¢«ç§°ä¸º â€œ[ç«æ€æ¡ä»¶](https://en.wikipedia.org/wiki/Race_condition)â€ï¼šä¸¤ä¸ªä¸åŒçš„è¯·æ±‚ â€œç›¸äº’ç«äº‰â€ï¼Œå¹¶ä»¥ä¸ä½ é¢„æœŸä¸ç¬¦çš„é¡ºåºè¿”å›ã€‚

**ä¸ºäº†ä¿®å¤è¿™ä¸ªé—®é¢˜ï¼Œä½ éœ€è¦æ·»åŠ ä¸€ä¸ª æ¸…ç†å‡½æ•° æ¥å¿½ç•¥è¾ƒæ—©çš„è¿”å›ç»“æœï¼š**

```jsx
  useEffect(() => {
    let ignore = false;
    fetchResults(query, page).then(json => {
      if (!ignore) {
        setResults(json);
      }
    });
    return () => {
      ignore = true;
    };
  }, [query, page]);
```

è¿™ç¡®ä¿äº†å½“ä½ åœ¨ Effect ä¸­è·å–æ•°æ®æ—¶ï¼Œé™¤äº†æœ€åä¸€æ¬¡è¯·æ±‚çš„æ‰€æœ‰è¿”å›ç»“æœéƒ½å°†è¢«å¿½ç•¥ã€‚



### å°ç»“

- å¦‚æœä½ å¯ä»¥åœ¨æ¸²æŸ“æœŸé—´è®¡ç®—æŸäº›å†…å®¹ï¼Œåˆ™ä¸éœ€è¦ä½¿ç”¨ Effectã€‚
- æƒ³è¦ç¼“å­˜æ˜‚è´µçš„è®¡ç®—ï¼Œè¯·ä½¿ç”¨ `useMemo` è€Œä¸æ˜¯ `useEffect`ã€‚
- æƒ³è¦é‡ç½®æ•´ä¸ªç»„ä»¶æ ‘çš„ stateï¼Œè¯·ä¼ å…¥ä¸åŒçš„ `key`ã€‚
- æƒ³è¦åœ¨ prop å˜åŒ–æ—¶é‡ç½®æŸäº›ç‰¹å®šçš„ stateï¼Œè¯·åœ¨æ¸²æŸ“æœŸé—´å¤„ç†ã€‚
- ç»„ä»¶ **æ˜¾ç¤º** æ—¶å°±éœ€è¦æ‰§è¡Œçš„ä»£ç åº”è¯¥æ”¾åœ¨ Effect ä¸­ï¼Œå¦åˆ™åº”è¯¥æ”¾åœ¨äº‹ä»¶å¤„ç†å‡½æ•°ä¸­ã€‚
- å¦‚æœä½ éœ€è¦æ›´æ–°å¤šä¸ªç»„ä»¶çš„ stateï¼Œæœ€å¥½åœ¨å•ä¸ªäº‹ä»¶å¤„ç†å‡½æ•°ä¸­å¤„ç†ã€‚
- å½“ä½ å°è¯•åœ¨ä¸åŒç»„ä»¶ä¸­åŒæ­¥ state å˜é‡æ—¶ï¼Œè¯·è€ƒè™‘çŠ¶æ€æå‡ã€‚
- ä½ å¯ä»¥ä½¿ç”¨ Effect è·å–æ•°æ®ï¼Œä½†ä½ éœ€è¦å®ç°æ¸…é™¤é€»è¾‘ä»¥é¿å…ç«æ€æ¡ä»¶ã€‚





## å“åº”å¼Effectçš„ç”Ÿå‘½å‘¨æœŸ

Effect ä¸ç»„ä»¶æœ‰ä¸åŒçš„ç”Ÿå‘½å‘¨æœŸã€‚ç»„ä»¶å¯ä»¥æŒ‚è½½ã€æ›´æ–°æˆ–å¸è½½ã€‚Effect åªèƒ½åšä¸¤ä»¶äº‹ï¼šå¼€å§‹åŒæ­¥æŸäº›ä¸œè¥¿ï¼Œç„¶ååœæ­¢åŒæ­¥å®ƒã€‚å¦‚æœ Effect ä¾èµ–äºéšæ—¶é—´å˜åŒ–çš„ props å’Œ stateï¼Œè¿™ä¸ªå¾ªç¯å¯èƒ½ä¼šå‘ç”Ÿå¤šæ¬¡ã€‚

React æä¾›äº†ä»£ç æ£€æŸ¥è§„åˆ™æ¥æ£€æŸ¥æ˜¯å¦æ­£ç¡®åœ°æŒ‡å®šäº† Effect çš„ä¾èµ–é¡¹ï¼Œè¿™èƒ½å¤Ÿä½¿ Effect ä¸æœ€æ–°çš„ props å’Œ state ä¿æŒåŒæ­¥ã€‚



### Effectçš„ç”Ÿå‘½å‘¨æœŸ

æ¯ä¸ª React ç»„ä»¶éƒ½ç»å†ç›¸åŒçš„ç”Ÿå‘½å‘¨æœŸï¼š

- å½“ç»„ä»¶è¢«æ·»åŠ åˆ°å±å¹•ä¸Šæ—¶ï¼Œå®ƒä¼šè¿›è¡Œç»„ä»¶çš„ **æŒ‚è½½**ã€‚
- å½“ç»„ä»¶æ¥æ”¶åˆ°æ–°çš„ props æˆ– state æ—¶ï¼Œé€šå¸¸æ˜¯ä½œä¸ºå¯¹äº¤äº’çš„å“åº”ï¼Œå®ƒä¼šè¿›è¡Œç»„ä»¶çš„ **æ›´æ–°**ã€‚
- å½“ç»„ä»¶ä»å±å¹•ä¸Šç§»é™¤æ—¶ï¼Œå®ƒä¼šè¿›è¡Œç»„ä»¶çš„ **å¸è½½**ã€‚

è¿™æ˜¯ç»„ä»¶çš„ç”Ÿå‘½å‘¨æœŸä½†å¹¶ä¸é€‚ç”¨äºEffect

å¦‚ä¸‹è¿™ä¸ªç¤ºä¾‹ï¼š

```jsx
const serverUrl = 'https://localhost:1234';

function ChatRoom({ roomId }) {
  useEffect(() => {
    const connection = createConnection(serverUrl, roomId);
    connection.connect();
    return () => {
      connection.disconnect();
    };
  }, [roomId]);
  // ...
}
```

ä½ å¯èƒ½ä¼šç›´è§‚åœ°è®¤ä¸ºå½“ç»„ä»¶æŒ‚è½½æ—¶ React ä¼š **å¼€å§‹åŒæ­¥**ï¼Œè€Œå½“ç»„ä»¶å¸è½½æ—¶ä¼š **åœæ­¢åŒæ­¥**ã€‚ç„¶è€Œï¼Œäº‹æƒ…å¹¶æ²¡æœ‰è¿™ä¹ˆç®€å•ï¼æœ‰æ—¶ï¼Œåœ¨ç»„ä»¶ä¿æŒæŒ‚è½½çŠ¶æ€çš„åŒæ—¶ï¼Œå¯èƒ½è¿˜éœ€è¦ **å¤šæ¬¡å¼€å§‹å’Œåœæ­¢åŒæ­¥**ã€‚

ä¾‹å¦‚ï¼š

è¿™ä¸ª `ChatRoom` ç»„ä»¶æ¥æ”¶ `roomId` å±æ€§ï¼Œç”¨æˆ·å¯ä»¥åœ¨ä¸‹æ‹‰èœå•ä¸­é€‰æ‹©ã€‚å‡è®¾åˆå§‹æ—¶ï¼Œç”¨æˆ·é€‰æ‹©äº† `"general"` ä½œä¸º `roomId`ã€‚åº”ç”¨ç¨‹åºä¼šæ˜¾ç¤º `"general"` èŠå¤©å®¤ï¼š

```jsx
const serverUrl = 'https://localhost:1234';

function ChatRoom({ roomId /* "general" */ }) {
  // ...
  return <h1>æ¬¢è¿æ¥åˆ° {roomId} æˆ¿é—´ï¼</h1>;
}
```

åœ¨ UI æ˜¾ç¤ºï¼ˆReactæ¸²æŸ“ï¼‰ä¹‹åï¼ŒReact å°†è¿è¡Œ Effect æ¥ **å¼€å§‹åŒæ­¥**ã€‚å®ƒè¿æ¥åˆ° `"general"` èŠå¤©å®¤ï¼š

ä¹‹åï¼Œç”¨æˆ·åœ¨ä¸‹æ‹‰èœå•ä¸­é€‰æ‹©äº†ä¸åŒçš„æˆ¿é—´ï¼ˆä¾‹å¦‚ `"travel"` ï¼‰ã€‚é¦–å…ˆï¼ŒReact ä¼šæ›´æ–° UIï¼ˆé‡æ–°æ¸²æŸ“ï¼‰ï¼š

æ€è€ƒæ¥ä¸‹æ¥åº”è¯¥å‘ç”Ÿä»€ä¹ˆã€‚ç”¨æˆ·åœ¨ç•Œé¢ä¸­çœ‹åˆ° `"travel"` æ˜¯å½“å‰é€‰å®šçš„èŠå¤©å®¤ã€‚ç„¶è€Œï¼Œä¸Šæ¬¡è¿è¡Œçš„ Effect ä»ç„¶è¿æ¥åˆ° `"general"` èŠå¤©å®¤ã€‚**roomId å±æ€§å·²ç»å‘ç”Ÿäº†å˜åŒ–ï¼Œæ‰€ä»¥ä¹‹å‰ Effect æ‰€åšçš„äº‹æƒ…ï¼ˆè¿æ¥åˆ° "general" èŠå¤©å®¤ï¼‰ä¸å†ä¸ UI åŒ¹é…**ã€‚

æ­¤æ—¶ï¼Œä½ å¸Œæœ› React æ‰§è¡Œä¸¤ä¸ªæ“ä½œï¼š

1. åœæ­¢ä¸æ—§çš„ `roomId` åŒæ­¥ï¼ˆæ–­å¼€ä¸ `"general"` èŠå¤©å®¤çš„è¿æ¥ï¼‰
2. å¼€å§‹ä¸æ–°çš„ `roomId` åŒæ­¥ï¼ˆè¿æ¥åˆ° `"travel"` èŠå¤©å®¤ï¼‰



### Effectå¦‚ä½•é‡æ–°åŒæ­¥Effect

å›æƒ³ä¸€ä¸‹ï¼Œ`ChatRoom` ç»„ä»¶å·²ç»æ¥æ”¶åˆ°äº† `roomId` å±æ€§çš„æ–°å€¼ã€‚ä¹‹å‰å®ƒæ˜¯ `"general"`ï¼Œç°åœ¨å˜æˆäº† `"travel"`ã€‚React éœ€è¦é‡æ–°åŒæ­¥ Effectï¼Œä»¥é‡æ–°è¿æ¥åˆ°ä¸åŒçš„èŠå¤©å®¤ã€‚

ä¸ºäº† **åœæ­¢åŒæ­¥**ï¼ŒReact å°†è°ƒç”¨ Effect è¿”å›çš„æ¸…ç†å‡½æ•°ï¼Œè¯¥å‡½æ•°åœ¨è¿æ¥åˆ° `"general"` èŠå¤©å®¤åè¿”å›ã€‚ç”±äº `roomId` ä¸º `"general"`ï¼Œæ¸…ç†å‡½æ•°å°†æ–­å¼€ä¸ `"general"` èŠå¤©å®¤çš„è¿æ¥ï¼š

```jsx
function ChatRoom({ roomId /* "general" */ }) {

  useEffect(() => {

    const connection = createConnection(serverUrl, roomId); // è¿æ¥åˆ° "general" èŠå¤©å®¤

    connection.connect();

    return () => {

      connection.disconnect(); // æ–­å¼€ä¸ "general" èŠå¤©å®¤çš„è¿æ¥

    };

    // ...
```

ç„¶åï¼ŒReact å°†è¿è¡Œåœ¨æ­¤æ¸²æŸ“æœŸé—´æä¾›çš„ Effectã€‚è¿™æ¬¡ï¼Œ`roomId` ä¸º `"travel"`ï¼Œå› æ­¤å®ƒå°† **å¼€å§‹åŒæ­¥** åˆ° `"travel"` èŠå¤©å®¤ï¼ˆç›´åˆ°æœ€ç»ˆä¹Ÿè°ƒç”¨äº†æ¸…ç†å‡½æ•°ï¼‰ï¼š

```jsx
function ChatRoom({ roomId /* "travel" */ }) {

  useEffect(() => {

    const connection = createConnection(serverUrl, roomId); // è¿æ¥åˆ° "travel" èŠå¤©å®¤

    connection.connect();

    // ...
```

æ¯å½“ç»„ä»¶ä½¿ç”¨ä¸åŒçš„ `roomId` é‡æ–°æ¸²æŸ“åï¼ŒEffect å°†é‡æ–°è¿›è¡ŒåŒæ­¥ã€‚ä¾‹å¦‚ï¼Œå‡è®¾ç”¨æˆ·å°† `roomId` ä» `"travel"` æ›´æ”¹ä¸º `"music"`ã€‚React å°†å†æ¬¡é€šè¿‡è°ƒç”¨æ¸…ç†å‡½æ•° **åœæ­¢åŒæ­¥** Effectï¼ˆæ–­å¼€ä¸ `"travel"` èŠå¤©å®¤çš„è¿æ¥ï¼‰ã€‚ç„¶åï¼Œå®ƒå°†é€šè¿‡ä½¿ç”¨æ–°çš„ `roomId` å±æ€§å†æ¬¡è¿è¡Œ Effect çš„ä¸»ä½“éƒ¨åˆ† **å¼€å§‹åŒæ­¥**ï¼ˆè¿æ¥åˆ° `"music"` èŠå¤©å®¤ï¼‰ã€‚

æœ€åï¼Œå½“ç”¨æˆ·åˆ‡æ¢åˆ°ä¸åŒçš„å±å¹•æ—¶ï¼Œ`ChatRoom` ç»„ä»¶å°†è¢«å¸è½½ã€‚ç°åœ¨æ²¡æœ‰å¿…è¦ä¿æŒè¿æ¥äº†ã€‚React å°† **æœ€åä¸€æ¬¡åœæ­¢åŒæ­¥** Effectï¼Œå¹¶ä» `"music"` èŠå¤©å®¤æ–­å¼€è¿æ¥ã€‚



### ä»Effectçš„è§’åº¦æ€è€ƒ

è®©æˆ‘ä»¬æ€»ç»“ä¸€ä¸‹ä» `ChatRoom` ç»„ä»¶çš„è§’åº¦æ‰€å‘ç”Ÿçš„ä¸€åˆ‡ï¼š

1. `ChatRoom` ç»„ä»¶æŒ‚è½½ï¼Œ`roomId` è®¾ç½®ä¸º `"general"`
2. `ChatRoom` ç»„ä»¶æ›´æ–°ï¼Œ`roomId` è®¾ç½®ä¸º `"travel"`
3. `ChatRoom` ç»„ä»¶æ›´æ–°ï¼Œ`roomId` è®¾ç½®ä¸º `"music"`
4. `ChatRoom` ç»„ä»¶å¸è½½

åœ¨ç»„ä»¶ç”Ÿå‘½å‘¨æœŸçš„æ¯ä¸ªé˜¶æ®µï¼ŒEffect æ‰§è¡Œäº†ä¸åŒçš„æ“ä½œï¼š

1. Effect è¿æ¥åˆ°äº† `"general"` èŠå¤©å®¤
2. Effect æ–­å¼€äº†ä¸ `"general"` èŠå¤©å®¤çš„è¿æ¥ï¼Œå¹¶è¿æ¥åˆ°äº† `"travel"` èŠå¤©å®¤
3. Effect æ–­å¼€äº†ä¸ `"travel"` èŠå¤©å®¤çš„è¿æ¥ï¼Œå¹¶è¿æ¥åˆ°äº† `"music"` èŠå¤©å®¤
4. Effect æ–­å¼€äº†ä¸ `"music"` èŠå¤©å®¤çš„è¿æ¥

ç°åœ¨è®©æˆ‘ä»¬ä» Effect æœ¬èº«çš„è§’åº¦æ¥æ€è€ƒæ‰€å‘ç”Ÿçš„äº‹æƒ…ï¼š

```jsx
  useEffect(() => {
    // Effect è¿æ¥åˆ°äº†é€šè¿‡ roomId æŒ‡å®šçš„èŠå¤©å®¤...
    const connection = createConnection(serverUrl, roomId);
    connection.connect();
    return () => {
      // ...ç›´åˆ°å®ƒæ–­å¼€è¿æ¥
      connection.disconnect();
    };
  }, [roomId]);
```

è¿™æ®µä»£ç çš„ç»“æ„å¯èƒ½ä¼šå°†æ‰€å‘ç”Ÿçš„äº‹æƒ…çœ‹ä½œæ˜¯ä¸€ç³»åˆ—ä¸é‡å çš„æ—¶é—´æ®µï¼š

1. Effect è¿æ¥åˆ°äº† `"general"` èŠå¤©å®¤ï¼ˆç›´åˆ°æ–­å¼€è¿æ¥ï¼‰
2. Effect è¿æ¥åˆ°äº† `"travel"` èŠå¤©å®¤ï¼ˆç›´åˆ°æ–­å¼€è¿æ¥ï¼‰
3. Effect è¿æ¥åˆ°äº† `"music"` èŠå¤©å®¤ï¼ˆç›´åˆ°æ–­å¼€è¿æ¥ï¼‰

ä¹‹å‰ï¼Œä½ æ˜¯ä»ç»„ä»¶çš„è§’åº¦æ€è€ƒçš„ã€‚å½“ä½ ä»ç»„ä»¶çš„è§’åº¦æ€è€ƒæ—¶ï¼Œå¾ˆå®¹æ˜“å°† Effect è§†ä¸ºåœ¨ç‰¹å®šæ—¶é—´ç‚¹è§¦å‘çš„â€œå›è°ƒå‡½æ•°â€æˆ–â€œç”Ÿå‘½å‘¨æœŸäº‹ä»¶â€ï¼Œä¾‹å¦‚â€œæ¸²æŸ“åâ€æˆ–â€œå¸è½½å‰â€ã€‚è¿™ç§æ€ç»´æ–¹å¼å¾ˆå¿«å˜å¾—å¤æ‚ï¼Œæ‰€ä»¥æœ€å¥½é¿å…ä½¿ç”¨ã€‚



### Reactå¦‚ä½•çŸ¥é“éœ€è¦é‡æ–°è¿›è¡ŒEffectçš„åŒæ­¥

è¿™æ˜¯å› ä¸º **ä½ å‘Šè¯‰äº† React** å®ƒçš„ä»£ç ä¾èµ–äº `roomId`ï¼Œé€šè¿‡å°†å…¶åŒ…å«åœ¨ [ä¾èµ–åˆ—è¡¨](https://react.docschina.org/learn/synchronizing-with-effects#step-2-specify-the-effect-dependencies) ä¸­ã€‚

æ¯æ¬¡åœ¨ç»„ä»¶é‡æ–°æ¸²æŸ“åï¼ŒReact éƒ½ä¼šæŸ¥çœ‹ä¼ é€’çš„ä¾èµ–é¡¹æ•°ç»„ã€‚å¦‚æœæ•°ç»„ä¸­çš„ä»»ä½•å€¼ä¸ä¸Šä¸€æ¬¡æ¸²æŸ“æ—¶åœ¨ç›¸åŒä½ç½®ä¼ é€’çš„å€¼ä¸åŒï¼ŒReact å°†é‡æ–°åŒæ­¥ Effectã€‚

ä¾‹å¦‚ï¼Œå¦‚æœåœ¨åˆå§‹æ¸²æŸ“æ—¶ä¼ é€’äº† `["general"]`ï¼Œç„¶ååœ¨ä¸‹ä¸€æ¬¡æ¸²æŸ“æ—¶ä¼ é€’äº† `["travel"]`ï¼ŒReact å°†æ¯”è¾ƒ `"general"` å’Œ `"travel"`ã€‚è¿™äº›æ˜¯ä¸åŒçš„å€¼ï¼ˆä½¿ç”¨ [`Object.is`](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Object/is) è¿›è¡Œæ¯”è¾ƒï¼‰ï¼Œå› æ­¤ React å°†é‡æ–°åŒæ­¥ Effectã€‚å¦ä¸€æ–¹é¢ï¼Œå¦‚æœç»„ä»¶é‡æ–°æ¸²æŸ“ä½† `roomId` æ²¡æœ‰å‘ç”Ÿå˜åŒ–ï¼ŒEffect å°†ç»§ç»­è¿æ¥åˆ°ç›¸åŒçš„æˆ¿é—´ã€‚





### æ¯ä¸ª Effect è¡¨ç¤ºä¸€ä¸ªç‹¬ç«‹çš„åŒæ­¥è¿‡ç¨‹

æŠµåˆ¶å°†ä¸ Effect æ— å…³çš„é€»è¾‘æ·»åŠ åˆ°å·²ç»ç¼–å†™çš„ Effect ä¸­ï¼Œä»…ä»…å› ä¸ºè¿™äº›é€»è¾‘éœ€è¦ä¸ Effect åŒæ—¶è¿è¡Œã€‚ä¾‹å¦‚ï¼Œå‡è®¾ä½ æƒ³åœ¨ç”¨æˆ·è®¿é—®æˆ¿é—´æ—¶å‘é€ä¸€ä¸ªåˆ†æäº‹ä»¶ã€‚ä½ å·²ç»æœ‰ä¸€ä¸ªä¾èµ–äº `roomId` çš„ Effectï¼Œæ‰€ä»¥ä½ å¯èƒ½ä¼šæƒ³è¦å°†åˆ†æè°ƒç”¨æ·»åŠ åˆ°é‚£é‡Œï¼š

```jsx
function ChatRoom({ roomId }) {
  useEffect(() => {
    logVisit(roomId);
    const connection = createConnection(serverUrl, roomId);
    connection.connect();
    return () => {
      connection.disconnect();
    };
  }, [roomId]);
  // ...
}
```

ä½†æ˜¯å¦‚æœæœªæ¥è¯¥Effectçš„ä¾èµ–é¡¹å‘ç”Ÿäº†æ”¹å˜ï¼Œå¯èƒ½Effectçš„æ‰§è¡Œè¡Œä¸ºå¹¶éä½ æƒ³è¦çš„äº†

è®°å½•è®¿é—®è¡Œä¸ºæ˜¯ **ä¸€ä¸ªç‹¬ç«‹çš„è¿‡ç¨‹**ï¼Œä¸è¿æ¥ä¸åŒã€‚å°†å®ƒä»¬ä½œä¸ºä¸¤ä¸ªå•ç‹¬çš„ Effect ç¼–å†™ï¼š

```jsx
function ChatRoom({ roomId }) {
  useEffect(() => {
    logVisit(roomId);
  }, [roomId]);

  useEffect(() => {
    const connection = createConnection(serverUrl, roomId);
    // ...
  }, [roomId]);
  // ...
}
```

**ä»£ç ä¸­çš„æ¯ä¸ª Effect åº”è¯¥ä»£è¡¨ä¸€ä¸ªç‹¬ç«‹çš„åŒæ­¥è¿‡ç¨‹ã€‚**

åœ¨ä¸Šé¢çš„ç¤ºä¾‹ä¸­ï¼Œåˆ é™¤ä¸€ä¸ª Effect ä¸ä¼šå½±å“å¦ä¸€ä¸ª Effect çš„é€»è¾‘ã€‚è¿™è¡¨æ˜å®ƒä»¬åŒæ­¥ä¸åŒçš„å†…å®¹ï¼Œå› æ­¤å°†å®ƒä»¬æ‹†åˆ†å¼€æ˜¯æœ‰æ„ä¹‰çš„ã€‚å¦ä¸€æ–¹é¢ï¼Œå¦‚æœå°†ä¸€ä¸ªå†…èšçš„é€»è¾‘æ‹†åˆ†æˆå¤šä¸ªç‹¬ç«‹çš„ Effectsï¼Œä»£ç å¯èƒ½ä¼šçœ‹èµ·æ¥æ›´åŠ â€œæ¸…æ™°â€ï¼Œä½† [ç»´æŠ¤èµ·æ¥ä¼šæ›´åŠ å›°éš¾](https://react.docschina.org/learn/you-might-not-need-an-effect#chains-of-computations)ã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆä½ åº”è¯¥è€ƒè™‘è¿™äº›è¿‡ç¨‹æ˜¯ç›¸åŒè¿˜æ˜¯ç‹¬ç«‹çš„ï¼Œè€Œä¸æ˜¯åªè€ƒè™‘ä»£ç æ˜¯å¦çœ‹èµ·æ¥æ›´æ•´æ´ã€‚



### Effect ä¼šâ€œå“åº”â€äºå“åº”å¼å€¼

å³åªæœ‰ä¼šéšæ—¶é—´å˜åŒ–çš„å€¼è¢«èµ‹äºˆä½œä¸ºä¾èµ–é¡¹æ—¶ï¼Œä»–æ‰ä¼šæœ‰æ„ä¹‰



### æ²¡æœ‰ä¾èµ–é¡¹çš„Effectçš„å«ä¹‰

Effect çš„ä»£ç ä¸ä½¿ç”¨ä»»ä½•å“åº”å¼å€¼ï¼Œå› æ­¤å®ƒçš„ä¾èµ–å¯ä»¥æ˜¯ç©ºçš„ (`[]`)

ä»ç»„ä»¶çš„è§’åº¦æ¥çœ‹ï¼Œç©ºçš„ `[]` ä¾èµ–æ•°ç»„æ„å‘³ç€è¿™ä¸ª Effect ä»…åœ¨ç»„ä»¶æŒ‚è½½æ—¶è¿æ¥åˆ°èŠå¤©å®¤ï¼Œå¹¶åœ¨ç»„ä»¶å¸è½½æ—¶æ–­å¼€è¿æ¥ã€‚ï¼ˆè¯·è®°ä½ï¼Œåœ¨å¼€å‘ç¯å¢ƒä¸­ï¼ŒReact ä»ä¼š [é¢å¤–æ‰§è¡Œä¸€æ¬¡](https://react.docschina.org/learn/lifecycle-of-reactive-effects#how-react-verifies-that-your-effect-can-re-synchronize) æ¥å¯¹é€»è¾‘è¿›è¡Œå‹åŠ›æµ‹è¯•ã€‚ï¼‰



### åœ¨ç»„ä»¶ä¸»ä½“ä¸­å£°æ˜çš„æ‰€æœ‰å˜é‡éƒ½æ˜¯å“åº”å¼çš„ 

Props å’Œ state å¹¶ä¸æ˜¯å”¯ä¸€çš„å“åº”å¼å€¼ã€‚ä»å®ƒä»¬è®¡ç®—å‡ºçš„å€¼ä¹Ÿæ˜¯å“åº”å¼çš„ã€‚å¦‚æœ props æˆ– state å‘ç”Ÿå˜åŒ–ï¼Œç»„ä»¶å°†é‡æ–°æ¸²æŸ“ï¼Œä»ä¸­è®¡ç®—å‡ºçš„å€¼ä¹Ÿä¼šéšä¹‹æ”¹å˜ã€‚è¿™å°±æ˜¯**ä¸ºä»€ä¹ˆ Effect ä½¿ç”¨çš„ç»„ä»¶ä¸»ä½“ä¸­çš„æ‰€æœ‰å˜é‡éƒ½åº”è¯¥åœ¨ä¾èµ–åˆ—è¡¨ä¸­**ã€‚

**ç»„ä»¶å†…éƒ¨çš„æ‰€æœ‰å€¼ï¼ˆåŒ…æ‹¬ propsã€state å’Œç»„ä»¶ä½“å†…çš„å˜é‡ï¼‰éƒ½æ˜¯å“åº”å¼çš„ã€‚ä»»ä½•å“åº”å¼å€¼éƒ½å¯ä»¥åœ¨é‡æ–°æ¸²æŸ“æ—¶å‘ç”Ÿå˜åŒ–ï¼Œæ‰€ä»¥éœ€è¦å°†å“åº”å¼å€¼åŒ…æ‹¬åœ¨ Effect çš„ä¾èµ–é¡¹ä¸­**ã€‚







## ä½¿ç”¨è‡ªå®šä¹‰Hookå¤ç”¨é€»è¾‘

React æœ‰ä¸€äº›å†…ç½® Hookï¼Œä¾‹å¦‚ `useState`ï¼Œ`useContext` å’Œ `useEffect`ã€‚æœ‰æ—¶ä½ éœ€è¦ä¸€ä¸ªç”¨é€”æ›´ç‰¹æ®Šçš„ Hookï¼šä¾‹å¦‚è·å–æ•°æ®ï¼Œè®°å½•ç”¨æˆ·æ˜¯å¦åœ¨çº¿æˆ–è€…è¿æ¥èŠå¤©å®¤ã€‚è™½ç„¶ React ä¸­å¯èƒ½æ²¡æœ‰è¿™äº› Hookï¼Œä½†æ˜¯ä½ å¯ä»¥æ ¹æ®åº”ç”¨éœ€æ±‚åˆ›å»ºè‡ªå·±çš„ Hookã€‚

### è‡ªå®šä¹‰ Hookï¼šç»„ä»¶é—´å…±äº«é€»è¾‘

å‡è®¾ä½ æ­£åœ¨å¼€å‘ä¸€æ¬¾é‡åº¦ä¾èµ–ç½‘ç»œçš„åº”ç”¨ï¼ˆå’Œå¤§å¤šæ•°åº”ç”¨ä¸€æ ·ï¼‰ã€‚å½“ç”¨æˆ·ä½¿ç”¨åº”ç”¨æ—¶ç½‘ç»œæ„å¤–æ–­å¼€ï¼Œä½ éœ€è¦æé†’ä»–ã€‚ä½ ä¼šæ€ä¹ˆå¤„ç†å‘¢ï¼Ÿçœ‹ä¸Šå»ç»„ä»¶éœ€è¦ä¸¤ä¸ªä¸œè¥¿ï¼š

1. ä¸€ä¸ªè¿½è¸ªç½‘ç»œæ˜¯å¦åœ¨çº¿çš„ stateã€‚
2. ä¸€ä¸ªè®¢é˜…å…¨å±€ [`online`](https://developer.mozilla.org/zh-CN/docs/Web/API/Window/online_event) å’Œ [`offline`](https://developer.mozilla.org/zh-CN/docs/Web/API/Window/offline_event) äº‹ä»¶å¹¶æ›´æ–°ä¸Šè¿° state çš„ Effectã€‚

è¿™ä¼šè®©ç»„ä»¶ä¸ç½‘ç»œçŠ¶æ€ä¿æŒ [åŒæ­¥](https://zh-hans.react.dev/learn/synchronizing-with-effects)ã€‚ä½ ä¹Ÿè®¸å¯ä»¥åƒè¿™æ ·å¼€å§‹

```jsx
import { useState, useEffect } from 'react';

export default function StatusBar() {
  const [isOnline, setIsOnline] = useState(true);
  useEffect(() => {
    function handleOnline() {
      setIsOnline(true);
    }
    function handleOffline() {
      setIsOnline(false);
    }
    window.addEventListener('online', handleOnline);
    window.addEventListener('offline', handleOffline);
    return () => {
      window.removeEventListener('online', handleOnline);
      window.removeEventListener('offline', handleOffline);
    };
  }, []);

  return <h1>{isOnline ? 'âœ… Online' : 'âŒ Disconnected'}</h1>;
}

```

å‡è®¾ç°åœ¨ä½ æƒ³åœ¨å¦ä¸€ä¸ªä¸åŒçš„ç»„ä»¶é‡Œ **ä¹Ÿ** ä½¿ç”¨åŒæ ·çš„é€»è¾‘ã€‚ä½ å¸Œæœ›å®ç°ä¸€ä¸ªä¿å­˜æŒ‰é’®ï¼Œæ¯å½“ç½‘ç»œæ–­å¼€è¿™ä¸ªæŒ‰é’®å°±ä¼šä¸å¯ç”¨å¹¶ä¸”æ˜¾ç¤ºâ€œReconnectingâ€¦â€è€Œä¸æ˜¯â€œSave progressâ€ã€‚

ä½ å¯ä»¥ä»å¤åˆ¶ç²˜è´´ `isOnline` state å’Œ Effect åˆ° `SaveButton` ç»„ä»¶å¼€å§‹ï¼š

```jsx
import { useState, useEffect } from 'react';

export default function SaveButton() {
  const [isOnline, setIsOnline] = useState(true);
  useEffect(() => {
    function handleOnline() {
      setIsOnline(true);
    }
    function handleOffline() {
      setIsOnline(false);
    }
    window.addEventListener('online', handleOnline);
    window.addEventListener('offline', handleOffline);
    return () => {
      window.removeEventListener('online', handleOnline);
      window.removeEventListener('offline', handleOffline);
    };
  }, []);

  function handleSaveClick() {
    console.log('âœ… Progress saved');
  }

  return (
    <button disabled={!isOnline} onClick={handleSaveClick}>
      {isOnline ? 'Save progress' : 'Reconnecting...'}
    </button>
  );
}

```

è¿™ä¸¤ä¸ªç»„ä»¶éƒ½èƒ½å¾ˆå¥½åœ°å·¥ä½œï¼Œä½†ä¸å¹¸çš„æ˜¯ä»–ä»¬çš„é€»è¾‘é‡å¤äº†ã€‚ä»–ä»¬çœ‹ä¸Šå»æœ‰ä¸åŒçš„ **è§†è§‰å¤–è§‚**ï¼Œä½†ä½ ä¾ç„¶æƒ³å¤ç”¨ä»–ä»¬çš„é€»è¾‘ã€‚



### ä»ç»„ä»¶ä¸­æå–è‡ªå®šä¹‰Hook

å‡è®¾æœ‰ä¸€ä¸ªå†…ç½® Hook `useOnlineStatus`ï¼Œå®ƒä¸ [`useState`](https://zh-hans.react.dev/reference/react/useState) å’Œ [`useEffect`](https://zh-hans.react.dev/reference/react/useEffect) ç›¸ä¼¼ã€‚é‚£ä¹ˆä½ å°±å¯ä»¥ç®€åŒ–è¿™ä¸¤ä¸ªç»„ä»¶å¹¶ç§»é™¤ä»–ä»¬ä¹‹é—´çš„é‡å¤éƒ¨åˆ†ï¼š

```jsx
function StatusBar() {
  const isOnline = useOnlineStatus();
  return <h1>{isOnline ? 'âœ… Online' : 'âŒ Disconnected'}</h1>;
}

function SaveButton() {
  const isOnline = useOnlineStatus();

  function handleSaveClick() {
    console.log('âœ… Progress saved');
  }

  return (
    <button disabled={!isOnline} onClick={handleSaveClick}>
      {isOnline ? 'Save progress' : 'Reconnecting...'}
    </button>
  );
}
```



å°½ç®¡ç›®å‰è¿˜æ²¡æœ‰è¿™æ ·çš„å†…ç½® Hookï¼Œä½†æ˜¯ä½ å¯ä»¥è‡ªå·±å†™ã€‚å£°æ˜ä¸€ä¸ª `useOnlineStatus` å‡½æ•°ï¼Œå¹¶æŠŠç»„ä»¶é‡Œæ—©å‰å†™çš„æ‰€æœ‰é‡å¤ä»£ç ç§»å…¥è¯¥å‡½æ•°ï¼š

```jsx
function useOnlineStatus() {
  const [isOnline, setIsOnline] = useState(true);
  useEffect(() => {
    function handleOnline() {
      setIsOnline(true);
    }
    function handleOffline() {
      setIsOnline(false);
    }
    window.addEventListener('online', handleOnline);
    window.addEventListener('offline', handleOffline);
    return () => {
      window.removeEventListener('online', handleOnline);
      window.removeEventListener('offline', handleOffline);
    };
  }, []);
  return isOnline;
}
```

åœ¨å‡½æ•°ç»“å°¾å¤„è¿”å› `isOnline`ã€‚è¿™å¯ä»¥è®©ç»„ä»¶è¯»å–åˆ°è¯¥å€¼ï¼š

è¿™æ ·åœ¨éœ€è¦ä½¿ç”¨åˆ°è¯¥Hookçš„åœ°æ–¹ç›´æ¥å¯¼å…¥ä½¿ç”¨å³å¯

```jsx
import { useOnlineStatus } from './useOnlineStatus.js';

function StatusBar() {
  const isOnline = useOnlineStatus();
  return <h1>{isOnline ? 'âœ… Online' : 'âŒ Disconnected'}</h1>;
}

function SaveButton() {
  const isOnline = useOnlineStatus();

  function handleSaveClick() {
    console.log('âœ… Progress saved');
  }

  return (
    <button disabled={!isOnline} onClick={handleSaveClick}>
      {isOnline ? 'Save progress' : 'Reconnecting...'}
    </button>
  );
}

export default function App() {
  return (
    <>
      <SaveButton />
      <StatusBar />
    </>
  );
}
```

ç°åœ¨ç»„ä»¶é‡Œæ²¡æœ‰é‚£ä¹ˆå¤šçš„é‡å¤é€»è¾‘äº†ã€‚**æ›´é‡è¦çš„æ˜¯ï¼Œç»„ä»¶å†…éƒ¨çš„ä»£ç æè¿°çš„æ˜¯æƒ³è¦åšä»€ä¹ˆï¼ˆä½¿ç”¨åœ¨çº¿çŠ¶æ€ï¼ï¼‰ï¼Œè€Œä¸æ˜¯æ€ä¹ˆåšï¼ˆé€šè¿‡è®¢é˜…æµè§ˆå™¨äº‹ä»¶å®Œæˆï¼‰**ã€‚

å½“æå–é€»è¾‘åˆ°è‡ªå®šä¹‰ Hook æ—¶ï¼Œä½ å¯ä»¥éšè—å¦‚ä½•å¤„ç†å¤–éƒ¨ç³»ç»Ÿæˆ–è€…æµè§ˆå™¨ API è¿™äº›ä¹±ä¸ƒå…«ç³Ÿçš„ç»†èŠ‚ã€‚ç»„ä»¶å†…éƒ¨çš„ä»£ç è¡¨è¾¾çš„æ˜¯ç›®æ ‡è€Œä¸æ˜¯å…·ä½“å®ç°ã€‚



### Hookçš„åç§°å¿…é¡»æ°¸è¿œä»¥`use`å¼€å¤´

React åº”ç”¨æ˜¯ç”±ç»„ä»¶æ„æˆï¼Œè€Œç»„ä»¶ç”±å†…ç½®æˆ–è‡ªå®šä¹‰ Hook æ„æˆã€‚å¯èƒ½ä½ ç»å¸¸ä½¿ç”¨åˆ«äººå†™çš„è‡ªå®šä¹‰ Hookï¼Œä½†å¶å°”ä¹Ÿè¦è‡ªå·±å†™ï¼

ä½ å¿…é¡»éµå¾ªä»¥ä¸‹è¿™äº›å‘½åå…¬çº¦ï¼š

1. **React ç»„ä»¶åç§°å¿…é¡»ä»¥å¤§å†™å­—æ¯å¼€å¤´**ï¼Œæ¯”å¦‚ `StatusBar` å’Œ `SaveButton`ã€‚React ç»„ä»¶è¿˜éœ€è¦è¿”å›ä¸€äº› React èƒ½å¤Ÿæ˜¾ç¤ºçš„å†…å®¹ï¼Œæ¯”å¦‚ä¸€æ®µ JSXã€‚
2. **Hook çš„åç§°å¿…é¡»ä»¥ use å¼€å¤´ï¼Œç„¶åç´§è·Ÿä¸€ä¸ªå¤§å†™å­—æ¯**ï¼Œå°±åƒå†…ç½®çš„ [`useState`](https://zh-hans.react.dev/reference/react/useState) æˆ–è€…æœ¬æ–‡æ—©å‰çš„è‡ªå®šä¹‰ `useOnlineStatus` ä¸€æ ·ã€‚Hook å¯ä»¥è¿”å›ä»»æ„å€¼ã€‚

è¿™ä¸ªå…¬çº¦ä¿è¯ä½ å§‹ç»ˆèƒ½ä¸€çœ¼è¯†åˆ«å‡ºç»„ä»¶å¹¶ä¸”çŸ¥é“å®ƒçš„ stateï¼ŒEffect ä»¥åŠå…¶ä»–çš„ React ç‰¹æ€§å¯èƒ½â€œéšè—â€åœ¨å“ªé‡Œã€‚ä¾‹å¦‚å¦‚æœä½ åœ¨ç»„ä»¶å†…éƒ¨çœ‹è§ `getColor()` å‡½æ•°è°ƒç”¨ï¼Œå°±å¯ä»¥ç¡®å®šå®ƒé‡Œé¢ä¸å¯èƒ½åŒ…å« React stateï¼Œå› ä¸ºå®ƒçš„åç§°æ²¡æœ‰ä»¥ `use` å¼€å¤´ã€‚ä½†æ˜¯åƒ `useOnlineStatus()` è¿™æ ·çš„å‡½æ•°è°ƒç”¨å°±å¾ˆå¯èƒ½åŒ…å«å¯¹å†…éƒ¨å…¶ä»– Hook çš„è°ƒç”¨ï¼

> tipsï¼š
>
> å¦‚æœä½ ä¸º [React é…ç½®äº†](https://zh-hans.react.dev/learn/editor-setup#linting) ä»£ç æ£€æŸ¥å·¥å…·ï¼Œå®ƒä¼šå¼ºåˆ¶æ‰§è¡Œè¿™ä¸ªå‘½åå…¬çº¦ã€‚ç°åœ¨æ»‘åŠ¨åˆ°ä¸Šé¢çš„ sandboxï¼Œå¹¶å°† `useOnlineStatus` é‡å‘½åä¸º `getOnlineStatus`ã€‚æ³¨æ„æ­¤æ—¶ä»£ç æ£€æŸ¥å·¥å…·å°†ä¸ä¼šå†å…è®¸ä½ åœ¨å…¶å†…éƒ¨è°ƒç”¨ `useState` æˆ–è€… `useEffect`ã€‚åªæœ‰ Hook å’Œç»„ä»¶å¯ä»¥è°ƒç”¨å…¶ä»– Hookï¼

> æ¸²æŸ“æœŸé—´è°ƒç”¨çš„æ‰€æœ‰å‡½æ•°éƒ½åº”è¯¥ä»¥ use å‰ç¼€å¼€å¤´ä¹ˆï¼Ÿ 
>
> ä¸ã€‚æ²¡æœ‰ **è°ƒç”¨** Hook çš„å‡½æ•°ä¸éœ€è¦ **å˜æˆ** Hookã€‚
>
> å¦‚æœä½ åˆ›å»ºçš„å‡½æ•°æ²¡æœ‰è°ƒç”¨ä»»ä½• Hook æ–¹æ³•ï¼Œåœ¨å‘½åæ—¶åº”é¿å…ä½¿ç”¨ `use` å‰ç¼€ï¼ŒæŠŠå®ƒå½“æˆä¸€ä¸ªå¸¸è§„å‡½æ•°å»å‘½åã€‚å¦‚ä¸‹æ¡ˆä¾‹ä¸­çš„ `useSorted` å‡½æ•°å°±æ²¡æœ‰è°ƒç”¨ä»»ä½• Hook æ–¹æ³•ï¼Œæ‰€ä»¥æ›´æ¨èç”¨ `getSorted` æ¥å‘½åï¼š
>
> ```js
> // ğŸ”´ Avoid: æ²¡æœ‰è°ƒç”¨å…¶ä»–Hookçš„Hook
>
> function useSorted(items) {
>
>   return items.slice().sort();
>
> }
>
>
>
> // âœ… Good: æ²¡æœ‰ä½¿ç”¨Hookçš„å¸¸è§„å‡½æ•°
>
> function getSorted(items) {
>
>   return items.slice().sort();
>
> }
> ```
>
> è¿™ä¿è¯ä½ çš„ä»£ç å¯ä»¥åœ¨åŒ…å«æ¡ä»¶è¯­å¥åœ¨å†…çš„ä»»ä½•åœ°æ–¹è°ƒç”¨è¿™ä¸ªå¸¸è§„å‡½æ•°ï¼š
>
> ```js
> function List({ items, shouldSort }) {
>
>   let displayedItems = items;
>
>   if (shouldSort) {
>
>     // âœ… åœ¨æ¡ä»¶åˆ†æ”¯é‡Œè°ƒç”¨getSorted()æ˜¯æ²¡é—®é¢˜çš„ï¼Œå› ä¸ºå®ƒä¸æ˜¯Hook
>
>     displayedItems = getSorted(items);
>
>   }
>
>   // ...
>
> }
> ```
>
> å“ªæ€•å†…éƒ¨åªä½¿ç”¨äº†ä¸€ä¸ª Hookï¼Œä½ ä¹Ÿåº”è¯¥ç»™è¿™ä¸ªå‡½æ•°åŠ  `use` å‰ç¼€ï¼ˆè®©å®ƒæˆä¸ºä¸€ä¸ª Hookï¼‰ï¼š
>
> ```js
> // âœ… Good: ä¸€ä¸ªä½¿ç”¨äº†å…¶ä»–Hookçš„Hook
>
> function useAuth() {
>
>   return useContext(Auth);
>
> }
> ```
>
> æŠ€æœ¯ä¸Š React å¯¹æ­¤å¹¶ä¸å¼ºåˆ¶è¦æ±‚ã€‚åŸåˆ™ä¸Šä½ å¯ä»¥å†™å‡ºä¸è°ƒç”¨å…¶ä»– Hook çš„ Hookã€‚ä½†è¿™å¸¸å¸¸ä¼šéš¾ä»¥ç†è§£ä¸”å—é™ï¼Œæ‰€ä»¥æœ€å¥½é¿å…è¿™ç§æ–¹å¼ã€‚ä½†æ˜¯å®ƒåœ¨æå°‘æ•°åœºæ™¯ä¸‹å¯èƒ½æ˜¯æœ‰ç›Šçš„ã€‚ä¾‹å¦‚å‡½æ•°ç›®å‰ä¹Ÿè®¸å¹¶æ²¡æœ‰ä½¿ç”¨ä»»ä½• Hookï¼Œä½†æ˜¯ä½ è®¡åˆ’æœªæ¥åœ¨è¯¥å‡½æ•°å†…éƒ¨æ·»åŠ ä¸€äº› Hook è°ƒç”¨ã€‚é‚£ä¹ˆä½¿ç”¨ `use` å‰ç¼€å‘½åå°±å¾ˆæœ‰æ„ä¹‰ï¼š
>
> ```js
> // âœ… Good: ä¹‹åå¯èƒ½ä½¿ç”¨å…¶ä»–Hookçš„Hook
>
> function useAuth() {
>
>   // TODO: å½“è®¤è¯åŠŸèƒ½å®ç°ä»¥åï¼Œæ›¿æ¢è¿™ä¸€è¡Œï¼š
>
>   // è¿”å› useContext(Auth)ï¼›
>
>   return TEST_USER;
>
> }
> ```
>
> æ¥ä¸‹æ¥ç»„ä»¶å°±ä¸èƒ½åœ¨æ¡ä»¶è¯­å¥é‡Œè°ƒç”¨è¿™ä¸ªå‡½æ•°ã€‚å½“ä½ åœ¨å†…éƒ¨å®é™…æ·»åŠ äº† Hook è°ƒç”¨æ—¶ï¼Œè¿™ä¸€ç‚¹å°†å˜å¾—å¾ˆé‡è¦ã€‚å¦‚æœä½ ï¼ˆç°åœ¨æˆ–è€…ä¹‹åï¼‰æ²¡æœ‰è®¡åˆ’åœ¨å†…éƒ¨ä½¿ç”¨ Hookï¼Œè¯·ä¸è¦è®©å®ƒå˜æˆ Hookã€‚



### è‡ªå®šä¹‰ Hook å…±äº«çš„æ˜¯çŠ¶æ€é€»è¾‘ï¼Œè€Œä¸æ˜¯çŠ¶æ€æœ¬èº« 

ä¹‹å‰çš„ä¾‹å­é‡Œï¼Œå½“ä½ å¼€å¯æˆ–å…³é—­ç½‘ç»œæ—¶ï¼Œä¸¤ä¸ªç»„ä»¶ä¸€èµ·æ›´æ–°äº†ã€‚ä½†æ˜¯ä¸¤ä¸ªç»„ä»¶å…±äº« state å˜é‡ `isOnline` è¿™ç§æƒ³æ³•æ˜¯é”™çš„ã€‚çœ‹è¿™æ®µä»£ç ï¼š

```js
function StatusBar() {

  const isOnline = useOnlineStatus();

  // ...

}



function SaveButton() {

  const isOnline = useOnlineStatus();

  // ...

}
```

å®ƒçš„å·¥ä½œæ–¹å¼å’Œä½ ä¹‹å‰æå–çš„é‡å¤ä»£ç ä¸€æ¨¡ä¸€æ ·ï¼š

```js
function StatusBar() {

  const [isOnline, setIsOnline] = useState(true);

  useEffect(() => {

    // ...

  }, []);

  // ...

}



function SaveButton() {

  const [isOnline, setIsOnline] = useState(true);

  useEffect(() => {

    // ...

  }, []);

  // ...

}
```

**è¿™æ˜¯å®Œå…¨ç‹¬ç«‹çš„ä¸¤ä¸ª state å˜é‡å’Œ Effect**ï¼åªæ˜¯ç¢°å·§åŒä¸€æ—¶é—´å€¼ä¸€æ ·ï¼Œå› ä¸ºä½ ä½¿ç”¨äº†ç›¸åŒçš„å¤–éƒ¨å€¼åŒæ­¥ä¸¤ä¸ªç»„ä»¶ï¼ˆæ— è®ºç½‘ç»œæ˜¯å¦å¼€å¯ï¼‰ã€‚

ä¾‹å¦‚ä¸€ä¸ªè¡¨å•å­˜åœ¨ä¸¤ä¸ªç›¸åŒçš„input

```jsx
import { useState } from 'react';

export default function Form() {
  const [firstName, setFirstName] = useState('Mary');
  const [lastName, setLastName] = useState('Poppins');

  function handleFirstNameChange(e) {
    setFirstName(e.target.value);
  }

  function handleLastNameChange(e) {
    setLastName(e.target.value);
  }

  return (
    <>
      <label>
        First name:
        <input value={firstName} onChange={handleFirstNameChange} />
      </label>
      <label>
        Last name:
        <input value={lastName} onChange={handleLastNameChange} />
      </label>
      <p><b>Good morning, {firstName} {lastName}.</b></p>
    </>
  );
}

```

æ¯ä¸ªè¡¨å•åŸŸéƒ½æœ‰ä¸€éƒ¨åˆ†é‡å¤çš„é€»è¾‘ï¼š

1. éƒ½æœ‰ä¸€ä¸ª stateï¼ˆ`firstName` å’Œ `lastName`ï¼‰ã€‚
2. éƒ½æœ‰ change äº‹ä»¶çš„å¤„ç†å‡½æ•°ï¼ˆ`handleFirstNameChange` å’Œ `handleLastNameChange`ï¼‰ã€‚
3. éƒ½æœ‰ä¸ºè¾“å…¥æ¡†æŒ‡å®š `value` å’Œ `onChange` å±æ€§çš„ JSXã€‚

ä½ å¯ä»¥æå–é‡å¤çš„é€»è¾‘åˆ°è‡ªå®šä¹‰ Hook `useFormInput`ï¼š

```jsx
import { useState } from 'react';

export function useFormInput(initialValue) {
  const [value, setValue] = useState(initialValue);

  function handleChange(e) {
    setValue(e.target.value);
  }

  const inputProps = {
    value: value,
    onChange: handleChange
  };

  return inputProps;
}
// ä½¿ç”¨è¯¥hook
import { useFormInput } from './useFormInput.js';

export default function Form() {
  const firstNameProps = useFormInput('Mary');
  const lastNameProps = useFormInput('Poppins');

  return (
    <>
      <label>
        First name:
        <input {...firstNameProps} />
      </label>
      <label>
        Last name:
        <input {...lastNameProps} />
      </label>
      <p><b>Good morning, {firstNameProps.value} {lastNameProps.value}.</b></p>
    </>
  );
}

```

**è‡ªå®šä¹‰ Hook å…±äº«çš„åªæ˜¯çŠ¶æ€é€»è¾‘è€Œä¸æ˜¯çŠ¶æ€æœ¬èº«ã€‚å¯¹ Hook çš„æ¯ä¸ªè°ƒç”¨å®Œå…¨ç‹¬ç«‹äºå¯¹åŒä¸€ä¸ª Hook çš„å…¶ä»–è°ƒç”¨**ã€‚è¿™å°±æ˜¯ä¸Šé¢ä¸¤ä¸ª sandbox ç»“æœå®Œå…¨ç›¸åŒçš„åŸå› ã€‚å¦‚æœæ„¿æ„ï¼Œä½ å¯ä»¥åˆ’ä¸Šå»è¿›è¡Œæ¯”è¾ƒã€‚æå–è‡ªå®šä¹‰ Hook å‰åç»„ä»¶çš„è¡Œä¸ºæ˜¯ä¸€è‡´çš„ã€‚

å½“ä½ éœ€è¦åœ¨å¤šä¸ªç»„ä»¶ä¹‹é—´å…±äº« state æœ¬èº«æ—¶ï¼Œéœ€è¦ [å°†å˜é‡æå‡å¹¶ä¼ é€’ä¸‹å»](https://react.docschina.org/learn/sharing-state-between-components)ã€‚



### åœ¨Hookä¹‹é—´ä¼ é€’å“åº”å€¼

æ¯å½“ç»„ä»¶é‡æ–°æ¸²æŸ“ï¼Œè‡ªå®šä¹‰ Hook ä¸­çš„ä»£ç å°±ä¼šé‡æ–°è¿è¡Œã€‚è¿™å°±æ˜¯ç»„ä»¶å’Œè‡ªå®šä¹‰ Hook éƒ½ [éœ€è¦æ˜¯çº¯å‡½æ•°](https://react.docschina.org/learn/keeping-components-pure) çš„åŸå› ã€‚æˆ‘ä»¬åº”è¯¥æŠŠè‡ªå®šä¹‰ Hook çš„ä»£ç çœ‹ä½œç»„ä»¶ä¸»ä½“çš„ä¸€éƒ¨åˆ†ã€‚

ç”±äºè‡ªå®šä¹‰ Hook ä¼šéšç€ç»„ä»¶ä¸€èµ·é‡æ–°æ¸²æŸ“ï¼Œæ‰€ä»¥ç»„ä»¶å¯ä»¥ä¸€ç›´æ¥æ”¶åˆ°æœ€æ–°çš„ props å’Œ state

ä¾‹å¦‚ï¼Œç”±å¦‚ä¸‹è¿™æ ·çš„Hook

```jsx
export function useChatRoom({ serverUrl, roomId }) {
  useEffect(() => {
    const options = {
      serverUrl: serverUrl,
      roomId: roomId
    };
    const connection = createConnection(options);
    connection.connect();
    connection.on('message', (msg) => {
      showNotification('New message: ' + msg);
    });
    return () => connection.disconnect();
  }, [roomId, serverUrl]);
}
```

ä½¿ç”¨è¯¥Hook

```jsx
export default function ChatRoom({ roomId }) {
  const [serverUrl, setServerUrl] = useState('https://localhost:1234');

  useChatRoom({
    roomId: roomId,
    serverUrl: serverUrl
  });

  return (
    <>
      <label>
        Server URL:
        <input value={serverUrl} onChange={e => setServerUrl(e.target.value)} />
      </label>
      <h1>Welcome to the {roomId} room!</h1>
    </>
  );
}
```

æ³¨æ„é€»è¾‘ **ä»ç„¶å“åº”** props å’Œ state çš„å˜åŒ–

æ¯æ¬¡ `ChatRoom` ç»„ä»¶é‡æ–°æ¸²æŸ“ï¼Œå®ƒå°±ä¼šä¼ æœ€æ–°çš„ `roomId` å’Œ `serverUrl` åˆ°ä½ çš„ Hook



### æŠŠäº‹ä»¶å¤„ç†å‡½æ•°ä¼ é€’åˆ°è‡ªå®šä¹‰Hookä¸­ï¼ˆå®éªŒæ€§ï¼‰

çœ‹ä¸‹é¢è¿™ä¸ªä¾‹å­æˆ‘ä»¬å¯ä»¥ç†è§£`useEffectEvent`çš„ä½œç”¨ï¼š

```jsx
/// app.js
import { useCounter } from './useCounter.js';
import { useInterval } from './useInterval.js';

export default function Counter() {
  const count = useCounter(1000);

  useInterval(() => {
    const randomColor = `hsla(${Math.random() * 360}, 100%, 50%, 0.2)`;
    document.body.style.backgroundColor = randomColor;
  }, 2000);

  return <h1>Seconds passed: {count}</h1>;
}

// useCounter.js
import { useState } from 'react';
import { useInterval } from './useInterval.js';

export function useCounter(delay) {
  const [count, setCount] = useState(0);
  useInterval(() => {
    setCount(c => c + 1);
  }, delay);
  return count;
}

// useInterval.js
import { useEffect } from 'react';
import { experimental_useEffectEvent as useEffectEvent } from 'react';

export function useInterval(onTick, delay) {
  useEffect(() => {
    console.log('âœ… Setting up an interval with delay ', delay)
    const id = setInterval(onTick, delay);
    return () => {
      console.log('âŒ Clearing an interval with delay ', delay)
      clearInterval(id);
    };
  }, [onTick, delay]);
}
```

å¦‚ä¸Šæˆ‘ä»¬è‡ªå®šä¹‰äº†ä¸¤ä¸ªHookï¼Œä¸€ä¸ªç”¨äºè®¾ç½®ä¸€ä¸ªå®šæ—¶å™¨ï¼Œä¸€ä¸ªç”¨äºæ¯ç§’é€’å¢countå˜é‡ä¸”ä½¿ç”¨äº†å®šæ—¶å™¨Hookï¼Œåœ¨é¡¶å±‚ç»„ä»¶appä¸­ä¹Ÿä½¿ç”¨äº†å®šæ—¶å™¨Hookç”¨äºå®šæ—¶è®¾ç½®èƒŒæ™¯é¢œè‰²

å€¼å¾—æ³¨æ„çš„æ˜¯ï¼š`useInterval`Hookä¸­çš„useEffectä¾èµ–ä¼ å…¥çš„ä¸€ä¸ªå›è°ƒå‡½æ•°

è§‚å¯Ÿæ‰“å°å†…å®¹ï¼Œæˆ‘ä»¬ä¸éš¾å‘ç°ï¼Œæ¯è¿‡ä¸€ç§’ï¼Œå°±ä¼šå¯¼è‡´useEffectçš„åŒæ­¥è¡Œä¸ºï¼Œè¿™æ˜¯å› ä¸ºåœ¨useCounterä¸­ä½¿ç”¨useIntervalä¼ å…¥çš„å›è°ƒå‡½æ•°æ›´æ–°äº†stateå˜é‡å¯¼è‡´äº†é¡µé¢é‡æ–°æ¸²æŸ“è¿›è€Œå¯¼è‡´useEffectåŒæ­¥è¡Œä¸ºçš„å‘ç”Ÿ

å› æ­¤æˆ‘ä»¬éœ€è¦ä» Effect çš„ä¾èµ–é¡¹ä¸­åˆ æ‰ `onTick`ã€‚æ¯æ¬¡ç»„ä»¶é‡æ–°æ¸²æŸ“æ—¶ï¼ŒEffect å°†ä¸ä¼šé‡æ–°åŒæ­¥

å¹¶ä¸”ä½¿ç”¨åˆ°è¿™ä¸ªå®éªŒæ€§çš„é’©å­`useEffectEvent`

æœ€ç»ˆä»£ç ï¼š

```js
import { useEffect } from 'react';
import { experimental_useEffectEvent as useEffectEvent } from 'react';

export function useInterval(callback, delay) {
  const onTick = useEffectEvent(callback);
  useEffect(() => {
    const id = setInterval(onTick, delay);
    return () => clearInterval(id);
  }, [delay]);
}

```









### ä»€ä¹ˆæ—¶å€™ä½¿ç”¨è‡ªå®šä¹‰Hook

ä½ æ²¡å¿…è¦å¯¹æ¯æ®µé‡å¤çš„ä»£ç éƒ½æå–è‡ªå®šä¹‰ Hookã€‚ä¸€äº›é‡å¤æ˜¯å¥½çš„ã€‚ä¾‹å¦‚åƒæ—©å‰æå–çš„åŒ…è£¹å•ä¸ª `useState` è°ƒç”¨çš„ `useFormInput` Hook å°±æ˜¯æ²¡æœ‰å¿…è¦çš„ã€‚

ä½†æ˜¯æ¯å½“ä½ å†™ Effect æ—¶ï¼Œè€ƒè™‘ä¸€ä¸‹æŠŠå®ƒåŒ…è£¹åœ¨è‡ªå®šä¹‰ Hook æ˜¯å¦æ›´æ¸…æ™°ã€‚[ä½ ä¸åº”è¯¥ç»å¸¸ä½¿ç”¨ Effect](https://react.docschina.org/learn/you-might-not-need-an-effect)ï¼Œæ‰€ä»¥å¦‚æœä½ æ­£åœ¨å†™ Effect å°±æ„å‘³ç€ä½ éœ€è¦â€œèµ°å‡º Reactâ€å’ŒæŸäº›å¤–éƒ¨ç³»ç»ŸåŒæ­¥ï¼Œæˆ–è€…éœ€è¦åšä¸€äº› React ä¸­æ²¡æœ‰å¯¹åº”å†…ç½® API çš„äº‹ã€‚æŠŠ Effect åŒ…è£¹è¿›è‡ªå®šä¹‰ Hook å¯ä»¥å‡†ç¡®è¡¨è¾¾ä½ çš„ç›®æ ‡ä»¥åŠæ•°æ®åœ¨é‡Œé¢æ˜¯å¦‚ä½•æµåŠ¨çš„ã€‚

ä¾‹å¦‚ï¼Œå‡è®¾ `ShippingForm` ç»„ä»¶å±•ç¤ºä¸¤ä¸ªä¸‹æ‹‰èœå•ï¼šä¸€ä¸ªæ˜¾ç¤ºåŸå¸‚åˆ—è¡¨ï¼Œå¦ä¸€ä¸ªæ˜¾ç¤ºé€‰ä¸­åŸå¸‚çš„åŒºåŸŸåˆ—è¡¨ã€‚ä½ å¯èƒ½ä¸€å¼€å§‹ä¼šåƒè¿™æ ·å†™ä»£ç å»åˆ†åˆ«è¯·æ±‚ä¸¤ä¸ªåˆ—è¡¨æ•°æ®

```jsx
function ShippingForm({ country }) {
  const [cities, setCities] = useState(null);
  // è¿™ä¸ª Effect æ‹‰å–ä¸€ä¸ªå›½å®¶çš„åŸå¸‚æ•°æ®
  useEffect(() => {
    let ignore = false;
    fetch(`/api/cities?country=${country}`)
      .then(response => response.json())
      .then(json => {
        if (!ignore) {
          setCities(json);
        }
      });
    return () => {
      ignore = true;
    };
  }, [country]);

  const [city, setCity] = useState(null);
  const [areas, setAreas] = useState(null);
  // è¿™ä¸ª Effect æ‹‰å–é€‰ä¸­åŸå¸‚çš„åŒºåŸŸåˆ—è¡¨
  useEffect(() => {
    if (city) {
      let ignore = false;
      fetch(`/api/areas?city=${city}`)
        .then(response => response.json())
        .then(json => {
          if (!ignore) {
            setAreas(json);
          }
        });
      return () => {
        ignore = true;
      };
    }
  }, [city]);
```

å°½ç®¡è¿™éƒ¨åˆ†ä»£ç æ˜¯é‡å¤çš„ï¼Œä½†æ˜¯ [æŠŠè¿™äº› Effect å„è‡ªåˆ†å¼€æ˜¯æ­£ç¡®çš„](https://react.docschina.org/learn/removing-effect-dependencies#is-your-effect-doing-several-unrelated-things)ã€‚ä»–ä»¬åŒæ­¥ä¸¤ä»¶ä¸åŒçš„äº‹æƒ…ï¼Œæ‰€ä»¥ä¸åº”è¯¥æŠŠä»–ä»¬åˆå¹¶åˆ°åŒä¸€ä¸ª Effectã€‚è€Œæ˜¯æå–å…¶ä¸­çš„é€šç”¨é€»è¾‘åˆ°ä½ è‡ªå·±çš„ `useData` Hook æ¥ç®€åŒ–ä¸Šé¢çš„ `ShippingForm` ç»„ä»¶ï¼š

```jsx
function useData(url) {
  const [data, setData] = useState(null);
  useEffect(() => {
    if (url) {
      let ignore = false;
      fetch(url)
        .then(response => response.json())
        .then(json => {
          if (!ignore) {
            setData(json);
          }
        });
      return () => {
        ignore = true;
      };
    }
  }, [url]);
  return data;
}
```

ç°åœ¨ä½ å¯ä»¥åœ¨ `ShippingForm` ç»„ä»¶ä¸­è°ƒç”¨ `useData` æ›¿æ¢ä¸¤ä¸ª Effectï¼š

```jsx
function ShippingForm({ country }) {

  const cities = useData(`/api/cities?country=${country}`);

  const [city, setCity] = useState(null);

  const areas = useData(city ? `/api/areas?city=${city}` : null);

  // ...
    
```

æå–è‡ªå®šä¹‰ Hook è®©æ•°æ®æµæ¸…æ™°ã€‚è¾“å…¥ `url`ï¼Œå°±ä¼šè¾“å‡º `data`ã€‚é€šè¿‡æŠŠ Effect â€œéšè—â€åœ¨ `useData` å†…éƒ¨ï¼Œä½ ä¹Ÿå¯ä»¥é˜²æ­¢ä¸€äº›æ­£åœ¨å¤„ç† `ShippingForm` ç»„ä»¶çš„äººå‘é‡Œé¢æ·»åŠ  [ä¸å¿…è¦çš„ä¾èµ–](https://react.docschina.org/learn/removing-effect-dependencies)ã€‚éšç€æ—¶é—´çš„æ¨ç§»ï¼Œåº”ç”¨ä¸­å¤§éƒ¨åˆ† Effect éƒ½ä¼šå­˜åœ¨äºè‡ªå®šä¹‰ Hook å†…éƒ¨ã€‚

**å¥½çš„è‡ªå®šä¹‰ Hook é€šè¿‡é™åˆ¶åŠŸèƒ½ä½¿ä»£ç è°ƒç”¨æ›´å…·å£°æ˜æ€§**ã€‚ä¾‹å¦‚ `useChatRoom(options)` åªèƒ½è¿æ¥èŠå¤©å®¤ï¼Œè€Œ `useImpressionLog(eventName, extraData)` åªèƒ½å‘åˆ†æç³»ç»Ÿå‘é€å±•ç¤ºæ—¥å¿—ã€‚å¦‚æœä½ çš„è‡ªå®šä¹‰ Hook API æ²¡æœ‰çº¦æŸç”¨ä¾‹ä¸”éå¸¸æŠ½è±¡ï¼Œé‚£ä¹ˆåœ¨é•¿æœŸçš„è¿è¡Œä¸­ï¼Œå®ƒå¼•å…¥çš„é—®é¢˜å¯èƒ½æ¯”è§£å†³çš„é—®é¢˜æ›´å¤šã€‚



### è‡ªå®šä¹‰ Hook å¸®åŠ©ä½ è¿ç§»åˆ°æ›´å¥½çš„æ¨¡å¼ 

Effect æ˜¯ä¸€ä¸ª [è„±å›´æœºåˆ¶](https://react.docschina.org/learn/escape-hatches)ï¼šå½“éœ€è¦â€œèµ°å‡º Reactâ€ä¸”ç”¨ä¾‹æ²¡æœ‰æ›´å¥½çš„å†…ç½®è§£å†³æ–¹æ¡ˆæ—¶ä½ å¯ä»¥ä½¿ç”¨ä»–ä»¬ã€‚éšç€æ—¶é—´çš„æ¨ç§»ï¼ŒReact å›¢é˜Ÿçš„ç›®æ ‡æ˜¯é€šè¿‡ç»™æ›´å…·ä½“çš„é—®é¢˜æä¾›æ›´å…·ä½“çš„è§£å†³æ–¹æ¡ˆæ¥æœ€å°åŒ–åº”ç”¨ä¸­çš„ Effect æ•°é‡ã€‚æŠŠä½ çš„ Effect åŒ…è£¹è¿›è‡ªå®šä¹‰ Hookï¼Œå½“è¿™äº›è§£å†³æ–¹æ¡ˆå¯ç”¨æ—¶å‡çº§ä»£ç ä¼šæ›´åŠ å®¹æ˜“ã€‚

åœ¨å‰é¢çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬å»ºç«‹äº†ä¸€ä¸ªå…³äºç½‘ç»œçŠ¶æ€çš„Hookï¼Œä½†å¹¶ä¸æ˜¯æœ€å¥½çš„è§£å†³æ–¹æ¡ˆï¼Œå› ä¸ºå­˜åœ¨è¾¹ç•Œç”¨ä¾‹ï¼šä¾‹å¦‚å½“ç»„ä»¶åŠ è½½æ—¶`isOnline`å·²ç»ä¸ºtrueä½†æ˜¯å¦‚æœåœ¨ç›‘å¬å™¨æ³¨å†Œä¹‹å‰ç½‘ç»œå·²ç»ç¦»çº¿ï¼Œé‚£ä¹ˆè¿™å°±æ˜¯é”™è¯¯çš„ï¼Œå¯ä»¥ä½¿ç”¨æµè§ˆå™¨ [`navigator.onLine`](https://developer.mozilla.org/en-US/docs/Web/API/Navigator/onLine) API æ¥æ£€æŸ¥

å¹¸è¿çš„æ˜¯ï¼ŒReact 18 åŒ…å«äº†ä¸€ä¸ªå«åš [`useSyncExternalStore`](https://react.docschina.org/reference/react/useSyncExternalStore) çš„ä¸“ç”¨ APIï¼Œå®ƒå¯ä»¥è§£å†³ä½ æ‰€æœ‰è¿™äº›é—®é¢˜ã€‚è¿™é‡Œå±•ç¤ºäº†å¦‚ä½•åˆ©ç”¨è¿™ä¸ªæ–° API æ¥é‡å†™ä½ çš„ `useOnlineStatus` Hookï¼š

```jsx
import { useSyncExternalStore } from 'react';

function subscribe(callback) {
  window.addEventListener('online', callback);
  window.addEventListener('offline', callback);
  return () => {
    window.removeEventListener('online', callback);
    window.removeEventListener('offline', callback);
  };
}

export function useOnlineStatus() {
  return useSyncExternalStore(
    subscribe,
    () => navigator.onLine, // å¦‚ä½•åœ¨å®¢æˆ·ç«¯è·å–å€¼
    () => true // å¦‚ä½•åœ¨æœåŠ¡ç«¯è·å–å€¼
  );
}

```

è€Œè¿™é‡Œæˆ‘ä»¬éœ€è¦å­¦ä¹ åˆ°çš„é‡ç‚¹åœ¨äºï¼š**ä½ ä¸éœ€è¦ä¿®æ”¹ä»»ä½•ç»„ä»¶** å°±èƒ½å®Œæˆè¿™æ¬¡æ”¹è¿›

è¿™æ˜¯æŠŠ Effect åŒ…è£¹è¿›è‡ªå®šä¹‰ Hook æœ‰ç›Šçš„å¦ä¸€ä¸ªåŸå› ï¼š

1. ä½ è®©è¿›å‡º Effect çš„æ•°æ®æµéå¸¸æ¸…æ™°ã€‚
2. ä½ è®©ç»„ä»¶ä¸“æ³¨äºç›®æ ‡ï¼Œè€Œä¸æ˜¯ Effect çš„å‡†ç¡®å®ç°ã€‚
3. å½“ React å¢åŠ æ–°ç‰¹æ€§æ—¶ï¼Œä½ å¯ä»¥åœ¨ä¸ä¿®æ”¹ä»»ä½•ç»„ä»¶çš„æƒ…å†µä¸‹ç§»é™¤è¿™äº› Effectã€‚

å’Œ [è®¾è®¡ç³»ç»Ÿ](https://uxdesign.cc/everything-you-need-to-know-about-design-systems-54b109851969) ç›¸ä¼¼ï¼Œä½ å¯èƒ½ä¼šå‘ç°ä»åº”ç”¨çš„ç»„ä»¶ä¸­æå–é€šç”¨é€»è¾‘åˆ°è‡ªå®šä¹‰ Hook æ˜¯éå¸¸æœ‰å¸®åŠ©çš„ã€‚è¿™ä¼šè®©ä½ çš„ç»„ä»¶ä»£ç ä¸“æ³¨äºç›®æ ‡ï¼Œå¹¶ä¸”é¿å…ç»å¸¸å†™åŸå§‹ Effectã€‚è®¸å¤šå¾ˆæ£’çš„è‡ªå®šä¹‰ Hook æ˜¯ç”± React ç¤¾åŒºç»´æŠ¤çš„ã€‚