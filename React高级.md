# è„±å›´æœºåˆ¶

æœ‰äº›ç»„ä»¶å¯èƒ½éœ€è¦æ§åˆ¶å’ŒåŒæ­¥ React ä¹‹å¤–çš„ç³»ç»Ÿã€‚ä¾‹å¦‚ï¼Œä½ å¯èƒ½éœ€è¦ä½¿ç”¨æµè§ˆå™¨ API èšç„¦è¾“å…¥æ¡†ï¼Œæˆ–è€…åœ¨æ²¡æœ‰ React çš„æƒ…å†µä¸‹å®ç°è§†é¢‘æ’­æ”¾å™¨ï¼Œæˆ–è€…è¿æ¥å¹¶ç›‘å¬è¿œç¨‹æœåŠ¡å™¨çš„æ¶ˆæ¯ã€‚åœ¨æœ¬ç« ä¸­ï¼Œä½ å°†å­¦ä¹ åˆ°ä¸€äº›è„±å›´æœºåˆ¶ï¼Œè®©ä½ å¯ä»¥â€œèµ°å‡ºâ€ React å¹¶è¿æ¥åˆ°å¤–éƒ¨ç³»ç»Ÿã€‚å¤§å¤šæ•°åº”ç”¨é€»è¾‘å’Œæ•°æ®æµä¸åº”è¯¥ä¾èµ–è¿™äº›åŠŸèƒ½ã€‚



## ä½¿ç”¨refå¼•ç”¨å€¼

### æ¦‚è¿°

å¦‚æœä½ å¸Œæœ›ç»„ä»¶"è®°ä½"æŸäº›ä¿¡æ¯ï¼Œä½†æ˜¯åˆä¸æƒ³è®©è¿™äº›ä¿¡æ¯ä¿®æ”¹æ—¶è§¦å‘æ¸²æŸ“ï¼Œä½ å¯ä»¥ä½¿ç”¨`ref`ï¼š

ä½¿ç”¨Hook `useRef`è¿›è¡Œå£°æ˜å˜é‡å³å¯

```jsx
import {useRef} from 'react'

// å‚æ•°æ˜¯å”¯ä¸€çš„ï¼Œä»£è¡¨ä½ æƒ³è¦çš„å˜é‡åˆå§‹å€¼
const ref = useRef(0);

// useRefè¿”å›è¿™æ ·ä¸€ä¸ªå¯¹è±¡
{ 
  current: 0 // ä½ å‘ useRef ä¼ å…¥çš„å€¼
}
```

ä¸ state ä¸€æ ·ï¼Œref åœ¨é‡æ–°æ¸²æŸ“ä¹‹é—´ç”± React ä¿ç•™ã€‚ä½†æ˜¯ï¼Œ**è®¾ç½® state ä¼šé‡æ–°æ¸²æŸ“ç»„ä»¶ï¼Œè€Œæ›´æ”¹ ref ä¸ä¼š**ï¼ä½ å¯ä»¥é€šè¿‡ `ref.current` å±æ€§è®¿é—®è¯¥ ref çš„å½“å‰å€¼ï¼ˆ**å¯è¯»å¯æ”¹**ï¼‰ã€‚

å¦‚ä¸‹ä¾‹å­ï¼š

```jsx
import { useRef } from 'react';

export default function Counter() {
  let ref = useRef(0);
  console.log('æ¸²æŸ“äº†')
  function handleClick() {
    ref.current = ref.current + 1;
    alert('ä½ ç‚¹å‡»äº† ' + ref.current + ' æ¬¡!');
  }

  return (
    <button onClick={handleClick}>
      ç‚¹æˆ‘ï¼
    </button>
  );
}
```

è¿è¡Œä»£ç å¯ä»¥å‘ç°åœ¨ç‚¹å‡»äº†æŒ‰é’®ä¹‹åå¹¶ä¸ä¼šæ‰“å° æ¸²æŸ“äº†

è¿™é‡Œçš„ ref æŒ‡å‘ä¸€ä¸ªæ•°å­—ï¼Œä½†æ˜¯ï¼Œåƒ [state](https://zh-hans.react.dev/learn/state-a-components-memory) ä¸€æ ·ï¼Œä½ å¯ä»¥è®©å®ƒ**æŒ‡å‘ä»»ä½•ä¸œè¥¿**ï¼šå­—ç¬¦ä¸²ã€å¯¹è±¡ï¼Œç”šè‡³æ˜¯å‡½æ•°ã€‚ä¸ state ä¸åŒçš„æ˜¯ï¼Œ**ref æ˜¯ä¸€ä¸ªæ™®é€šçš„ JavaScript å¯¹è±¡**ï¼Œå…·æœ‰å¯ä»¥è¢«è¯»å–å’Œä¿®æ”¹çš„ `current` å±æ€§ã€‚

åœ¨å®˜ç½‘ä¸­æœ‰ä¸€ä¸ªç§’è¡¨ä¾‹å­ï¼Œå¯å…·ä½“å‚è€ƒï¼š[ä½¿ç”¨ ref å¼•ç”¨å€¼ â€“ React ä¸­æ–‡æ–‡æ¡£](https://zh-hans.react.dev/learn/referencing-values-with-refs)



###ref VS state

æˆ‘ä»¬å»ºè®®ä½ ä½¿ç”¨ stateã€‚ref æ˜¯ä¸€ç§â€œè„±å›´æœºåˆ¶â€ï¼Œä½ å¹¶ä¸ä¼šç»å¸¸ç”¨åˆ°å®ƒã€‚ ä»¥ä¸‹æ˜¯ state å’Œ ref çš„å¯¹æ¯”ï¼š

| ref                                                         | state                                                        |
| ----------------------------------------------------------- | ------------------------------------------------------------ |
| `useRef(initialValue)`è¿”å› `{ current: initialValue }`      | `useState(initialValue)` è¿”å› state å˜é‡çš„å½“å‰å€¼å’Œä¸€ä¸ª state è®¾ç½®å‡½æ•° ( `[value, setValue]`) |
| æ›´æ”¹æ—¶**ä¸ä¼š**è§¦å‘é‡æ–°æ¸²æŸ“                                  | æ›´æ”¹æ—¶**è§¦å‘**é‡æ–°æ¸²æŸ“ã€‚                                     |
| **å¯å˜** â€”â€” ä½ å¯ä»¥åœ¨æ¸²æŸ“è¿‡ç¨‹ä¹‹å¤–ä¿®æ”¹å’Œæ›´æ–° `current` çš„å€¼ã€‚ | â€œä¸å¯å˜â€ â€”â€” **ä½ å¿…é¡»ä½¿ç”¨ state è®¾ç½®å‡½æ•°**æ¥ä¿®æ”¹ state å˜é‡ï¼Œä»è€Œæ’é˜Ÿé‡æ–°æ¸²æŸ“ã€‚ |
| ä½ **ä¸åº”åœ¨æ¸²æŸ“æœŸé—´è¯»å–ï¼ˆæˆ–å†™å…¥ï¼‰** `current` å€¼ã€‚           | ä½ å¯ä»¥**éšæ—¶è¯»å–** stateã€‚ä½†æ˜¯ï¼Œæ¯æ¬¡æ¸²æŸ“éƒ½æœ‰è‡ªå·±ä¸å˜çš„ state [å¿«ç…§](https://zh-hans.react.dev/learn/state-as-a-snapshot)ã€‚ |

ä¸‹é¢è¿™ä¸ªä¾‹å­å¯ä»¥çœ‹åˆ°ï¼š

```jsx
import { useState } from 'react';

export default function Counter() {
  const [count, setCount] = useState(0);

  function handleClick() {
    setCount(count + 1);
  }

  console.log('æ¸²æŸ“äº†')
  
  return (
    <button onClick={handleClick}>
      ä½ ç‚¹å‡»äº† {count} æ¬¡
    </button>
  );
}

```

```jsx
import { useRef } from 'react';

export default function Counter() {
  let countRef = useRef(0);

  function handleClick() {
    // è¿™æ ·å¹¶æœªé‡æ–°æ¸²æŸ“ç»„ä»¶ï¼
    countRef.current = countRef.current + 1;
  }

  return (
    <button onClick={handleClick}>
      ä½ ç‚¹å‡»äº† {countRef.current} æ¬¡
    </button>
  );
}

```

å¯ä»¥çœ‹åˆ°ä¸¤ä¸ªä¾‹å­åˆ†åˆ«ä½¿ç”¨äº†`state`å’Œ`ref`å­˜å‚¨æˆ‘ä»¬éœ€è¦ç”¨äºæ¸²æŸ“çš„å˜é‡countï¼Œä½†æ˜¯è¿è¡Œä»£ç å‘ç°ä½¿ç”¨`ref`çš„ä¾‹å­ä¸­ï¼Œå¹¶ä¸èƒ½æ­£å¸¸è¿è¡Œï¼Œå› ä¸ºå®ƒå®Œå…¨æ²¡æœ‰è§¦å‘ç»„ä»¶çš„é‡æ–°æ¸²æŸ“

è¿™å°±æ˜¯ä¸ºä»€ä¹ˆåœ¨æ¸²æŸ“æœŸé—´è¯»å– `ref.current` ä¼šå¯¼è‡´ä»£ç ä¸å¯é çš„åŸå› ã€‚å¦‚æœéœ€è¦ï¼Œè¯·æ”¹ç”¨ state

éœ€è¦å¼ºè°ƒçš„æ˜¯ï¼š

React state çš„é™åˆ¶ä¸é€‚ç”¨äº refã€‚ä¾‹å¦‚ï¼Œstate å°±åƒ [æ¯æ¬¡æ¸²æŸ“çš„å¿«ç…§](https://zh-hans.react.dev/learn/state-as-a-snapshot)ï¼Œå¹¶ä¸” [ä¸ä¼šåŒæ­¥æ›´æ–°](https://zh-hans.react.dev/learn/queueing-a-series-of-state-updates)/"ç«‹å³æ›´æ–°"ã€‚ä½†æ˜¯å½“ä½ æ”¹å˜ **ref çš„ current å€¼**æ—¶ï¼Œå®ƒä¼š**ç«‹å³æ”¹å˜**ï¼š

```jsx
ref.current = 5;
console.log(ref.current); // 5
```

è¿™æ˜¯å› ä¸º`ref`æœ¬èº«å°±æ˜¯ä¸€ä¸ªæ™®é€šçš„JavaScriptå¯¹è±¡

> refåŸç†ï¼š
>
> å®é™…ä¸Šï¼Œæˆ‘ä»¬å¯ä»¥æƒ³è±¡`useRef`æ˜¯ç”±`useState`å®ç°çš„
>
> ```jsx
> // React å†…éƒ¨
> function useRef(initialValue) {
>   const [ref, unused] = useState({ current: initialValue });
>   return ref;
> }
> ```
>
> åœ¨è§¦å‘åˆæ¬¡æ¸²æŸ“åï¼ŒuseRefç›´æ¥è¿”å›`{ current: initialValue }`ï¼Œå¹¶ä¸”æ²¡æœ‰ä½¿ç”¨å’Œè¿”å›stateè®¾ç½®å‡½æ•°ï¼Œå› ä¸ºæˆ‘ä»¬çš„refä¸éœ€è¦è§¦å‘æ¸²æŸ“ï¼Œè€Œstateè®¾ç½®å‡½æ•°çš„ä½œç”¨å°±æ˜¯ä¸ºäº†è§¦å‘æ¸²æŸ“



### åº”ç”¨

- å¸¸è§åº”ç”¨ï¼š
  - å­˜å‚¨å®šæ—¶å™¨id
  - å­˜å‚¨DOMå…ƒç´ 
  - æœ‰æ—¶å€™ï¼Œåœ¨ä¸€äº›å¼‚æ­¥æ“ä½œä¸­ï¼Œstateå­˜å‚¨çš„å¿«ç…§ä¸èƒ½æ»¡è¶³æˆ‘ä»¬å®æ—¶çš„éœ€æ±‚ï¼Œrefå¯èƒ½æ˜¯ä¸€ç§é€‰æ‹©
  - ä»¥åŠå…¶ä»–ä¸å½±å“ç»„ä»¶æ¸²æŸ“è¾“å‡ºçš„å¯¹è±¡
- åŸåˆ™ï¼š
  - **å°†refè§†ä¸ºè„±å›´æœºåˆ¶**ï¼šå½“æˆ‘ä»¬ä½¿ç”¨åˆ°å¤–éƒ¨ç³»ç»Ÿæˆ–æµè§ˆå™¨APIæ—¶ï¼Œrefæ˜¯æœ‰ç”¨çš„
  - **ä¸è¦åœ¨æ¸²æŸ“è¿‡ç¨‹ä¸­å¯¹`ref.current`è¿›è¡Œè¯»å†™**ï¼å¦‚æœæ¸²æŸ“è¿‡ç¨‹ä¸­éœ€è¦æŸäº›ä¿¡æ¯ï¼Œè¯·ä½¿ç”¨ [state](https://zh-hans.react.dev/learn/state-a-components-memory) ä»£æ›¿ã€‚ç”±äº React ä¸çŸ¥é“ `ref.current` ä½•æ—¶å‘ç”Ÿå˜åŒ–ï¼Œå³ä½¿åœ¨æ¸²æŸ“æ—¶è¯»å–å®ƒä¹Ÿä¼šä½¿ç»„ä»¶çš„è¡Œä¸ºéš¾ä»¥é¢„æµ‹ã€‚ï¼ˆå”¯ä¸€çš„ä¾‹å¤–æ˜¯åƒ `if (!ref.current) ref.current = new Thing()` è¿™æ ·çš„ä»£ç ï¼Œå®ƒåªåœ¨ç¬¬ä¸€æ¬¡æ¸²æŸ“æœŸé—´è®¾ç½®ä¸€æ¬¡ refã€‚ï¼‰





### refå’ŒDOM

refå¸¸è§çš„ç”¨æ³•æ˜¯è®¿é—®DOMå…ƒç´ ï¼ˆç”¨æ³•ç±»ä¼¼`vue`çš„refæ¨¡æ¿å¼•ç”¨ï¼‰

å½“ä½ å°† ref ä¼ é€’ç»™ JSX ä¸­çš„ `ref` å±æ€§æ—¶ï¼Œæ¯”å¦‚ `<div ref={myRef}>`ï¼ŒReact ä¼šå°†ç›¸åº”çš„ DOM å…ƒç´ æ”¾å…¥ `myRef.current` ä¸­ã€‚å½“å…ƒç´ ä» DOM ä¸­åˆ é™¤æ—¶ï¼ŒReact ä¼šå°† `myRef.current` æ›´æ–°ä¸º `null`ã€‚ä½ å¯ä»¥åœ¨ [ä½¿ç”¨ ref æ“ä½œ DOM](https://zh-hans.react.dev/learn/manipulating-the-dom-with-refs) ä¸­é˜…è¯»æ›´å¤šç›¸å…³ä¿¡æ¯ã€‚







### æ€è€ƒrefå˜é‡ä¸ç»„ä»¶é‡Œçš„æ™®é€šå˜é‡çš„åŒºåˆ«

çœ‹è¿™ä¸ªä¾‹å­ï¼š

```jsx
import { useState } from 'react';

export default function Chat() {
  const [text, setText] = useState('');
  const [isSending, setIsSending] = useState(false);
  let timeoutID = null;

  function handleSend() {
    setIsSending(true);
    timeoutID = setTimeout(() => {
      alert('å·²å‘é€ï¼');
      setIsSending(false);
    }, 3000);
  }

  function handleUndo() {
    setIsSending(false);
    clearTimeout(timeoutID);
  }

  return (
    <>
      <input
        disabled={isSending}
        value={text}
        onChange={e => setText(e.target.value)}
      />
      <button
        disabled={isSending}
        onClick={handleSend}>
        {isSending ? 'å‘é€ä¸­â€¦â€¦' : 'å‘é€'}
      </button>
      {isSending &&
        <button onClick={handleUndo}>
          æ’¤é”€
        </button>
      }
    </>
  );
}

```

è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬å¸Œæœ›çš„åŠŸèƒ½æ˜¯åœ¨ç”¨æˆ·ç‚¹å‡»å‘é€ä¹‹ååœ¨å»¶è¿Ÿ3såalertå‡º å·²å‘é€ ï¼ŒåŒæ—¶åœ¨3så†…ä¼šæ˜¾ç¤ºä¸€ä¸ª æ’¤é”€ æŒ‰é’®ï¼Œå¦‚æœç”¨æˆ·ç‚¹å‡»æ’¤é”€ï¼Œé‚£ä¹ˆå³å¯å–æ¶ˆå®šæ—¶å™¨

åœ¨è¿™ä¸ªéœ€æ±‚ä¸­ï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨ä¸€ä¸ªå˜é‡æ¥å­˜å‚¨å®šæ—¶å™¨IDï¼Œä»¥ä¾¿è¿›è¡Œå­˜å‚¨

å¦‚ä¸Šä»£ç çš„åšæ³•æ˜¯ä½¿ç”¨äº†ä¸€ä¸ªæ™®é€šå˜é‡è¿›è¡Œå­˜å‚¨ï¼Œå®é™…æ•ˆæœå¹¶æ²¡æœ‰å¦‚é¢„æœŸ

è€Œæ˜¯åœ¨ç”¨æˆ·ç‚¹å‡»äº†æ’¤é”€æŒ‰é’®åï¼Œä»ç„¶alert å·²å‘é€

åŸå› ï¼š

- æ™®é€šå˜é‡å¹¶ä¸ä¼šåœ¨æ¯ä¸€æ¬¡Reactç»„ä»¶çš„æ¸²æŸ“ä¸­å­˜æ´»
- åœ¨ä»£ç ä¸­ï¼Œå½“æˆ‘ä»¬ç‚¹å‡»äº†æ’¤é”€æŒ‰é’®ï¼Œä½¿ç”¨äº†stateçš„è®¾ç½®å‡½æ•°ï¼Œè§¦å‘äº†Reactçš„æ¸²æŸ“ï¼Œå› æ­¤æ™®é€šå˜é‡çš„å€¼ä¹Ÿå°±ä¸å­˜åœ¨äº†/æ²¡æœ‰å­˜å‚¨åˆ°æƒ³è¦çš„å†…å®¹äº†

æ­£ç¡®åšæ³•è¿˜æ˜¯é€‰æ‹©ä½¿ç”¨refï¼Œå› ä¸º**refä¹Ÿæ˜¯ä¸€ä¸ªç‰¹æ®Šçš„stateå¯ä»¥åœ¨æ¸²æŸ“ä¸­å­˜æ´»ä¸‹æ¥ï¼Œå´ä¸ä¼šè§¦å‘æ¸²æŸ“**



## ä½¿ç”¨refæ“ä½œDOM

 React ä¼šè‡ªåŠ¨å¤„ç†æ›´æ–° [DOM](https://developer.mozilla.org/docs/Web/API/Document_Object_Model/Introduction) ä»¥åŒ¹é…ä½ çš„æ¸²æŸ“è¾“å‡ºï¼Œå› æ­¤ä½ åœ¨ç»„ä»¶ä¸­é€šå¸¸ä¸éœ€è¦æ“ä½œ DOMã€‚ä½†æ˜¯ï¼Œæœ‰æ—¶ä½ å¯èƒ½éœ€è¦è®¿é—®ç”± React ç®¡ç†çš„ DOM å…ƒç´  â€”â€” ä¾‹å¦‚ï¼Œè®©ä¸€ä¸ªèŠ‚ç‚¹è·å¾—ç„¦ç‚¹ã€æ»šåŠ¨åˆ°å®ƒæˆ–æµ‹é‡å®ƒçš„å°ºå¯¸å’Œä½ç½®ã€‚åœ¨ React ä¸­æ²¡æœ‰å†…ç½®çš„æ–¹æ³•æ¥åšè¿™äº›äº‹æƒ…ï¼Œæ‰€ä»¥ä½ éœ€è¦ä¸€ä¸ªæŒ‡å‘ DOM èŠ‚ç‚¹çš„ **ref** æ¥å®ç°



### è·å–æŒ‡å®šèŠ‚ç‚¹çš„ref

ç”¨æ³•ä¸Šä¸vueçš„refæ¨¡æ¿å¼•ç”¨ç±»ä¼¼çš„

è¦è®¿é—®ç”± React ç®¡ç†çš„ DOM èŠ‚ç‚¹ï¼Œé¦–å…ˆï¼Œå¼•å…¥ `useRef` Hookï¼š

```jsx
import { useRef } from 'react';
```

ç„¶åï¼Œåœ¨ä½ çš„ç»„ä»¶ä¸­ä½¿ç”¨å®ƒå£°æ˜ä¸€ä¸ª refï¼š

```jsx
const myRef = useRef(null);
```

æœ€åï¼Œå°† ref ä½œä¸º `ref` å±æ€§å€¼ä¼ é€’ç»™æƒ³è¦è·å–çš„ DOM èŠ‚ç‚¹çš„ JSX æ ‡ç­¾ï¼š

```jsx
<div ref={myRef}>
```

è¿™æ ·æˆ‘ä»¬çš„`myRef.current`ä¸­å°±å­˜å‚¨äº†è¯¥èŠ‚ç‚¹çš„å¼•ç”¨äº†

```jsx
// ä½ å¯ä»¥ä½¿ç”¨ä»»æ„æµè§ˆå™¨ APIï¼Œä¾‹å¦‚ï¼š
myRef.current.scrollIntoView();
```

å…·ä½“DOMæ“ä½œä¾‹å­å¯ä»¥æŸ¥çœ‹[ä½¿ç”¨ ref æ“ä½œ DOM â€“ React ä¸­æ–‡æ–‡æ¡£](https://zh-hans.react.dev/learn/manipulating-the-dom-with-refs)





### åˆ—è¡¨æ•°æ®ç»‘å®šref

æœ‰æ—¶å€™ï¼Œåœ¨ä¸€ä¸ªåˆ—è¡¨æ•°æ®ä¸­ï¼Œæˆ‘ä»¬éœ€è¦ä¸ºå…¶æ¯ä¸€é¡¹éƒ½ç»‘å®šrefï¼Œåƒè¿™ä¹ˆåšæ˜¯ä¸è¡Œçš„

```jsx
<ul>
  {items.map((item) => {
    // è¡Œä¸é€šï¼
    const ref = useRef(null);
    return <li ref={ref} />;
  })}
</ul>
```

è¿™æ˜¯å› ä¸º **Hook åªèƒ½åœ¨ç»„ä»¶çš„é¡¶å±‚è¢«è°ƒç”¨**ã€‚ä¸èƒ½åœ¨å¾ªç¯è¯­å¥ã€æ¡ä»¶è¯­å¥æˆ– `map()` å‡½æ•°ä¸­è°ƒç”¨ `useRef` ã€‚

- è§£å†³æ–¹æ¡ˆï¼š
  - ä½¿ç”¨refå¼•ç”¨å…¶çˆ¶å…ƒç´ ï¼Œå†ä½¿ç”¨DOMæ–¹æ³•`querySelectorAll`æ¥å¯»æ‰¾å…¶å­èŠ‚ç‚¹ï¼Œä½†æ˜¯å¦‚æœDOMç»“æ„å˜åŒ–ï¼Œå¯èƒ½ä¼šå¤±æ•ˆæˆ–æŠ¥é”™ã€‚
  - å°†å‡½æ•°ä¼ é€’ç»™refå±æ€§ï¼Œè¿™å«`refå›è°ƒ`ï¼Œå½“éœ€è¦è®¾ç½® ref æ—¶ï¼ŒReact å°†ä¼ å…¥ DOM èŠ‚ç‚¹æ¥è°ƒç”¨ä½ çš„ ref å›è°ƒï¼Œå¹¶åœ¨éœ€è¦æ¸…é™¤å®ƒæ—¶ä¼ å…¥ `null` ã€‚è¿™ä½¿ä½ å¯ä»¥ç»´æŠ¤è‡ªå·±çš„æ•°ç»„æˆ– [Map](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Map)ï¼Œå¹¶é€šè¿‡å…¶ç´¢å¼•æˆ–æŸç§ç±»å‹çš„ ID è®¿é—®ä»»ä½• refã€‚

ç¤ºä¾‹ï¼š

```jsx
import { useRef } from 'react';

export default function CatFriends() {
  const itemsRef = useRef(null);

  function scrollToId(itemId) {
    const map = getMap();
    const node = map.get(itemId);
    node.scrollIntoView({
      behavior: 'smooth',
      block: 'nearest',
      inline: 'center'
    });
  }

  function getMap() {
    if (!itemsRef.current) {
      // é¦–æ¬¡è¿è¡Œæ—¶åˆå§‹åŒ– Mapã€‚
      itemsRef.current = new Map();
    }
    return itemsRef.current;
  }

  return (
    <>
      <nav>
        <button onClick={() => scrollToId(0)}>
          Tom
        </button>
        <button onClick={() => scrollToId(5)}>
          Maru
        </button>
        <button onClick={() => scrollToId(9)}>
          Jellylorum
        </button>
      </nav>
      <div>
        <ul>
          {catList.map(cat => (
            <li
              key={cat.id}
              ref={(node) => {
                const map = getMap();
                if (node) {
                  map.set(cat.id, node);
                } else {
                  map.delete(cat.id);
                }
              }}
            >
              <img
                src={cat.imageUrl}
                alt={'Cat #' + cat.id}
              />
            </li>
          ))}
        </ul>
      </div>
    </>
  );
}

const catList = [];
for (let i = 0; i < 10; i++) {
  catList.push({
    id: i,
    imageUrl: 'https://placekitten.com/250/200?image=' + i
  });
}

```

åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œ`itemsRef`ä¿å­˜çš„ä¸æ˜¯å•ä¸ªDOMèŠ‚ç‚¹ï¼Œè€Œæ˜¯åŒ…å«åˆ—è¡¨é¡¹IDå’ŒDOMèŠ‚ç‚¹çš„Mapï¼Œæ¯ä¸ªåˆ—è¡¨é¡¹ä¸Šçš„refå›è°ƒä¼šæ›´æ–°Mapï¼Œè¿™ä½¿ä½ å¯ä»¥ä¹‹åä» Map è¯»å–å•ä¸ª DOM èŠ‚ç‚¹ã€‚





### è®¿é—®ç»„ä»¶çš„DOMèŠ‚ç‚¹

å½“æˆ‘ä»¬å°†refæ”¾åœ¨ä¸€ä¸ªç»„ä»¶ä¸Šæ—¶ï¼Œæ­¤æ—¶ç»‘å®šå¾—åˆ°çš„refå˜é‡å€¼ä¸º`null`ï¼ï¼ï¼

å‘ç”Ÿè¿™ç§æƒ…å†µæ˜¯å› ä¸ºé»˜è®¤æƒ…å†µä¸‹ï¼ŒR**eact ä¸å…è®¸ç»„ä»¶è®¿é—®å…¶ä»–ç»„ä»¶çš„ DOM èŠ‚ç‚¹**ã€‚ç”šè‡³è‡ªå·±çš„å­ç»„ä»¶ä¹Ÿä¸è¡Œï¼è¿™æ˜¯æ•…æ„çš„ã€‚Refs æ˜¯ä¸€ç§è„±å›´æœºåˆ¶ï¼Œåº”è¯¥è°¨æ…ä½¿ç”¨ã€‚æ‰‹åŠ¨æ“ä½œ **å¦ä¸€ä¸ª** ç»„ä»¶çš„ DOM èŠ‚ç‚¹ä¼šä½¿ä½ çš„ä»£ç æ›´åŠ è„†å¼±ã€‚

å¦‚æœæƒ³è¦è¿™ä¹ˆåšï¼Œéœ€è¦éµå¾ªå¦‚ä¸‹æ­¥éª¤ï¼š

1. ç»„ä»¶å…è®¸è‡ªå·±çš„refè¢«è®¿é—®ï¼ˆä½¿ç”¨`forwardRef`APIï¼‰

   ```jsx
   const MyInput = forwardRef((props, ref) => {
     return <input {...props} ref={ref} />;
   });
   ```

2. å¤–éƒ¨ç»„ä»¶ä½¿ç”¨refå±æ€§ç»‘å®šrefå˜é‡

å®ƒæ˜¯è¿™æ ·å·¥ä½œçš„:

1. `<MyInput ref={inputRef} />` å‘Šè¯‰ React å°†å¯¹åº”çš„ DOM èŠ‚ç‚¹æ”¾å…¥ `inputRef.current` ä¸­ã€‚ä½†æ˜¯ï¼Œè¿™å–å†³äº `MyInput` ç»„ä»¶æ˜¯å¦å…è®¸è¿™ç§è¡Œä¸ºï¼Œ é»˜è®¤æƒ…å†µä¸‹æ˜¯ä¸å…è®¸çš„ã€‚
2. `MyInput` ç»„ä»¶æ˜¯ä½¿ç”¨ `forwardRef` å£°æ˜çš„ã€‚ **è¿™è®©ä»ä¸Šé¢æ¥æ”¶çš„ inputRef ä½œä¸ºç¬¬äºŒä¸ªå‚æ•° ref ä¼ å…¥ç»„ä»¶**ï¼Œç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ `props` ã€‚
3. `MyInput` ç»„ä»¶å°†è‡ªå·±æ¥æ”¶åˆ°çš„ `ref` ä¼ é€’ç»™å®ƒå†…éƒ¨çš„ `<input>`ã€‚

```jsx
import { forwardRef, useRef } from 'react';

const MyInput = forwardRef((props, ref) => {
  return <input {...props} ref={ref} />;
});

export default function Form() {
  const inputRef = useRef(null);

  function handleClick() {
    inputRef.current.focus();
  }

  return (
    <>
      <MyInput ref={inputRef} />
      <button onClick={handleClick}>
        èšç„¦è¾“å…¥æ¡†
      </button>
    </>
  );
}

```

åœ¨è®¾è®¡ç³»ç»Ÿä¸­ï¼Œå°†ä½çº§ç»„ä»¶ï¼ˆå¦‚æŒ‰é’®ã€è¾“å…¥æ¡†ç­‰ï¼‰çš„ ref è½¬å‘åˆ°å®ƒä»¬çš„ DOM èŠ‚ç‚¹æ˜¯ä¸€ç§å¸¸è§æ¨¡å¼ã€‚å¦ä¸€æ–¹é¢ï¼Œåƒè¡¨å•ã€åˆ—è¡¨æˆ–é¡µé¢æ®µè½è¿™æ ·çš„é«˜çº§ç»„ä»¶é€šå¸¸ä¸ä¼šæš´éœ²å®ƒä»¬çš„ DOM èŠ‚ç‚¹ï¼Œä»¥é¿å…å¯¹ DOM ç»“æ„çš„æ„å¤–ä¾èµ–ã€‚

> é™åˆ¶ç»„ä»¶æš´éœ²çš„å†…å®¹ï¼š
>
> åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œ`MyInput` æš´éœ²äº†åŸå§‹çš„ DOM å…ƒç´  inputã€‚è¿™è®©çˆ¶ç»„ä»¶å¯ä»¥å¯¹å…¶è°ƒç”¨`focus()`ã€‚ç„¶è€Œï¼Œè¿™ä¹Ÿè®©çˆ¶ç»„ä»¶èƒ½å¤Ÿåšå…¶ä»–äº‹æƒ… â€”â€” ä¾‹å¦‚ï¼Œæ”¹å˜å…¶ CSS æ ·å¼
>
> åœ¨ä¸€äº›ä¸å¸¸è§çš„æƒ…å†µä¸‹ï¼Œä½ å¯èƒ½å¸Œæœ›é™åˆ¶æš´éœ²çš„åŠŸèƒ½ã€‚ä½ å¯ä»¥ç”¨ `useImperativeHandle` åšåˆ°è¿™ä¸€ç‚¹ï¼š
>
> ```jsx
> import {
>   forwardRef, 
>   useRef, 
>   useImperativeHandle
> } from 'react';
>
> const MyInput = forwardRef((props, ref) => {
>   const realInputRef = useRef(null);
>   useImperativeHandle(ref, () => ({
>     // åªæš´éœ² focusï¼Œæ²¡æœ‰åˆ«çš„
>     focus() {
>       realInputRef.current.focus();
>     },
>   }));
>   return <input {...props} ref={realInputRef} />;
> });
>
> export default function Form() {
>   const inputRef = useRef(null);
>
>   function handleClick() {
>     inputRef.current.focus();
>   }
>
>   return (
>     <>
>       <MyInput ref={inputRef} />
>       <button onClick={handleClick}>
>         èšç„¦è¾“å…¥æ¡†
>       </button>
>     </>
>   );
> }
>
> ```
>
> è¿™é‡Œï¼Œ`MyInput` ä¸­çš„ `realInputRef` ä¿å­˜äº†å®é™…çš„ input DOM èŠ‚ç‚¹ã€‚ ä½†æ˜¯ï¼Œ`useImperativeHandle` æŒ‡ç¤º React å°†ä½ è‡ªå·±æŒ‡å®šçš„å¯¹è±¡ä½œä¸ºçˆ¶ç»„ä»¶çš„ ref å€¼ã€‚ æ‰€ä»¥ `Form` ç»„ä»¶å†…çš„ `inputRef.current` å°†åªæœ‰ `focus` æ–¹æ³•









##  ä½¿ç”¨EffectåŒæ­¥

æœ‰äº›ç»„ä»¶éœ€è¦ä¸å¤–éƒ¨ç³»ç»ŸåŒæ­¥ã€‚ä¾‹å¦‚ï¼Œä½ å¯èƒ½å¸Œæœ›æ ¹æ® React state æ§åˆ¶é React ç»„ä»¶ã€è®¾ç½®æœåŠ¡å™¨è¿æ¥æˆ–åœ¨ç»„ä»¶å‡ºç°åœ¨å±å¹•ä¸Šæ—¶å‘é€åˆ†ææ—¥å¿—ã€‚**Effects ä¼šåœ¨æ¸²æŸ“åè¿è¡Œä¸€äº›ä»£ç **ï¼Œä»¥ä¾¿å¯ä»¥å°†ç»„ä»¶ä¸ React ä¹‹å¤–çš„æŸäº›ç³»ç»ŸåŒæ­¥ã€‚



### ä»€ä¹ˆæ˜¯Effectï¼Œå®ƒä¸äº‹ä»¶ï¼ˆeventï¼‰æœ‰ä½•ä¸åŒ

åœ¨è°ˆåˆ° Effect ä¹‹å‰ï¼Œä½ éœ€è¦ç†Ÿæ‚‰ React ç»„ä»¶ä¸­çš„ä¸¤ç§é€»è¾‘ç±»å‹ï¼š

- **æ¸²æŸ“é€»è¾‘ä»£ç **ï¼ˆåœ¨ [æè¿° UI](https://zh-hans.react.dev/learn/describing-the-ui) ä¸­æœ‰ä»‹ç»ï¼‰ä½äºç»„ä»¶çš„é¡¶å±‚ã€‚ä½ å°†åœ¨è¿™é‡Œæ¥æ”¶ props å’Œ stateï¼Œå¹¶å¯¹å®ƒä»¬è¿›è¡Œè½¬æ¢ï¼Œæœ€ç»ˆè¿”å›ä½ æƒ³åœ¨å±å¹•ä¸Šçœ‹åˆ°çš„ JSXã€‚[æ¸²æŸ“çš„ä»£ç å¿…é¡»æ˜¯çº¯ç²¹çš„](https://zh-hans.react.dev/learn/keeping-components-pure)â€”â€”å°±åƒæ•°å­¦å…¬å¼ä¸€æ ·ï¼Œå®ƒåªåº”è¯¥â€œè®¡ç®—â€ç»“æœï¼Œè€Œä¸åšå…¶ä»–ä»»ä½•äº‹æƒ…ã€‚
- **äº‹ä»¶å¤„ç†ç¨‹åº**ï¼ˆåœ¨ [æ·»åŠ äº¤äº’æ€§](https://zh-hans.react.dev/learn/adding-interactivity) ä¸­ä»‹ç»ï¼‰æ˜¯åµŒå¥—åœ¨ç»„ä»¶å†…éƒ¨çš„å‡½æ•°ï¼Œè€Œä¸ä»…ä»…æ˜¯è®¡ç®—å‡½æ•°ã€‚äº‹ä»¶å¤„ç†ç¨‹åºå¯èƒ½ä¼šæ›´æ–°è¾“å…¥å­—æ®µã€æäº¤ HTTP POST è¯·æ±‚ä»¥è´­ä¹°äº§å“ï¼Œæˆ–è€…å°†ç”¨æˆ·å¯¼èˆªåˆ°å¦ä¸€ä¸ªå±å¹•ã€‚äº‹ä»¶å¤„ç†ç¨‹åºåŒ…å«ç”±ç‰¹å®šç”¨æˆ·æ“ä½œï¼ˆä¾‹å¦‚æŒ‰é’®ç‚¹å‡»æˆ–é”®å…¥ï¼‰å¼•èµ·çš„â€œå‰¯ä½œç”¨â€ï¼ˆå®ƒä»¬æ”¹å˜äº†ç¨‹åºçš„çŠ¶æ€ï¼‰ï¼ˆäº‹ä»¶å¤„ç†å‡½æ•°ä¸ä¼šåœ¨æ¸²æŸ“æ—¶æ‰§è¡Œå› æ­¤åŒ…å«å‰¯ä½œç”¨ä¹Ÿæ— å¦¨ï¼‰ã€‚

æœ‰æ—¶è¿™è¿˜ä¸å¤Ÿã€‚è€ƒè™‘ä¸€ä¸ª `ChatRoom` ç»„ä»¶ï¼Œå®ƒåœ¨å±å¹•ä¸Šå¯è§æ—¶å¿…é¡»è¿æ¥åˆ°èŠå¤©æœåŠ¡å™¨ã€‚è¿æ¥åˆ°æœåŠ¡å™¨ä¸æ˜¯ä¸€ä¸ªçº¯è®¡ç®—ï¼ˆå®ƒåŒ…å«å‰¯ä½œç”¨ï¼‰ï¼Œå› æ­¤å®ƒä¸èƒ½åœ¨æ¸²æŸ“è¿‡ç¨‹ä¸­å‘ç”Ÿã€‚ç„¶è€Œï¼Œå¹¶æ²¡æœ‰ä¸€ä¸ªç‰¹å®šçš„äº‹ä»¶ï¼ˆæ¯”å¦‚ç‚¹å‡»ï¼‰å¯¼è‡´ `ChatRoom` è¢«æ˜¾ç¤ºã€‚

**Effect å…è®¸ä½ æŒ‡å®šç”±æ¸²æŸ“æœ¬èº«ï¼Œè€Œä¸æ˜¯ç‰¹å®šäº‹ä»¶å¼•èµ·çš„å‰¯ä½œç”¨**ã€‚åœ¨èŠå¤©ä¸­å‘é€æ¶ˆæ¯æ˜¯ä¸€ä¸ªâ€œäº‹ä»¶â€ï¼Œå› ä¸ºå®ƒç›´æ¥ç”±ç”¨æˆ·ç‚¹å‡»ç‰¹å®šæŒ‰é’®å¼•èµ·ã€‚ç„¶è€Œï¼Œå»ºç«‹æœåŠ¡å™¨è¿æ¥æ˜¯ Effectï¼Œå› ä¸ºå®ƒåº”è¯¥å‘ç”Ÿæ— è®ºå“ªç§äº¤äº’å¯¼è‡´ç»„ä»¶å‡ºç°ã€‚Effect åœ¨å±å¹•æ›´æ–°åçš„ [æäº¤é˜¶æ®µ](https://zh-hans.react.dev/learn/render-and-commit) è¿è¡Œã€‚è¿™æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„æ—¶æœºï¼Œå¯ä»¥å°† React ç»„ä»¶ä¸æŸä¸ªå¤–éƒ¨ç³»ç»Ÿï¼ˆå¦‚ç½‘ç»œæˆ–ç¬¬ä¸‰æ–¹åº“ï¼‰åŒæ­¥ã€‚

> æ³¨æ„ï¼š
>
> åœ¨æœ¬æ–‡å’Œåç»­æ–‡æœ¬ä¸­ï¼Œ`Effect` åœ¨ React ä¸­æ˜¯ä¸“æœ‰å®šä¹‰â€”â€”ç”±æ¸²æŸ“å¼•èµ·çš„å‰¯ä½œç”¨ã€‚ä¸ºäº†æŒ‡ä»£æ›´å¹¿æ³›çš„ç¼–ç¨‹æ¦‚å¿µï¼Œä¹Ÿå¯ä»¥å°†å…¶ç§°ä¸ºâ€œå‰¯ä½œç”¨ï¼ˆside effectï¼‰â€ã€‚
>
> ä½ å¯èƒ½ä¸éœ€è¦Effectï¼š
>
> **ä¸è¦éšæ„åœ¨ä½ çš„ç»„ä»¶ä¸­ä½¿ç”¨ Effect**ã€‚è®°ä½ï¼ŒEffect é€šå¸¸ç”¨äºæš‚æ—¶â€œè·³å‡ºâ€ React ä»£ç å¹¶ä¸ä¸€äº› **å¤–éƒ¨** ç³»ç»Ÿè¿›è¡ŒåŒæ­¥ã€‚è¿™åŒ…æ‹¬æµè§ˆå™¨ APIã€ç¬¬ä¸‰æ–¹å°éƒ¨ä»¶ï¼Œä»¥åŠç½‘ç»œç­‰ç­‰ã€‚å¦‚æœä½ æƒ³ç”¨ Effect ä»…æ ¹æ®å…¶ä»–çŠ¶æ€è°ƒæ•´æŸäº›çŠ¶æ€ï¼Œé‚£ä¹ˆ [ä½ å¯èƒ½ä¸éœ€è¦ Effect](https://zh-hans.react.dev/learn/you-might-not-need-an-effect)ã€‚



### å¦‚ä½•ç¼–å†™Effect

ç¼–å†™ Effect éœ€è¦éµå¾ªä»¥ä¸‹ä¸‰ä¸ªè§„åˆ™ï¼š

1. **å£°æ˜ Effect**ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼ŒEffect ä¼šåœ¨æ¯æ¬¡ [commit](https://zh-hans.react.dev/learn/render-and-commit) ï¼ˆ**æ¸²æŸ“**ï¼‰åéƒ½ä¼šæ‰§è¡Œã€‚
2. **æŒ‡å®š Effect ä¾èµ–**ã€‚å¤§å¤šæ•° Effect åº”è¯¥æŒ‰éœ€æ‰§è¡Œï¼Œè€Œä¸æ˜¯åœ¨æ¯æ¬¡æ¸²æŸ“åéƒ½æ‰§è¡Œã€‚ä¾‹å¦‚ï¼Œæ·¡å…¥åŠ¨ç”»åº”è¯¥åªåœ¨ç»„ä»¶å‡ºç°æ—¶è§¦å‘ã€‚è¿æ¥å’Œæ–­å¼€æœåŠ¡å™¨çš„æ“ä½œåªåº”åœ¨ç»„ä»¶å‡ºç°å’Œæ¶ˆå¤±æ—¶ï¼Œæˆ–è€…åˆ‡æ¢èŠå¤©å®¤æ—¶æ‰§è¡Œã€‚æ–‡ç« å°†ä»‹ç»å¦‚ä½•é€šè¿‡æŒ‡å®šä¾èµ–æ¥æ§åˆ¶å¦‚ä½•æŒ‰éœ€æ‰§è¡Œã€‚
3. **å¿…è¦æ—¶æ·»åŠ æ¸…ç†ï¼ˆcleanupï¼‰å‡½æ•°**ã€‚æœ‰æ—¶ Effect éœ€è¦æŒ‡å®šå¦‚ä½•åœæ­¢ã€æ’¤é”€ï¼Œæˆ–è€…æ¸…é™¤å®ƒçš„æ•ˆæœã€‚ä¾‹å¦‚ï¼Œâ€œè¿æ¥â€æ“ä½œéœ€è¦â€œæ–­è¿â€ï¼Œâ€œè®¢é˜…â€éœ€è¦â€œé€€è®¢â€ï¼Œâ€œè·å–â€æ—¢éœ€è¦â€œå–æ¶ˆâ€ä¹Ÿéœ€è¦â€œå¿½ç•¥â€ã€‚ä½ å°†å­¦ä¹ å¦‚ä½•ä½¿ç”¨ **æ¸…ç†å‡½æ•°** æ¥åšåˆ°è¿™ä¸€åˆ‡ã€‚

ä»¥ä¸‹æ˜¯å…·ä½“æ­¥éª¤ï¼š



#### å£°æ˜Effect

é¦–å…ˆåœ¨ React ä¸­å¼•å…¥ [`useEffect` Hook](https://zh-hans.react.dev/reference/react/useEffect)ï¼š

```js
import { useEffect } from 'react';
```

ç„¶åï¼Œåœ¨ç»„ä»¶é¡¶éƒ¨è°ƒç”¨å®ƒï¼Œå¹¶ä¼ å…¥åœ¨æ¯æ¬¡æ¸²æŸ“æ—¶éƒ½éœ€è¦æ‰§è¡Œçš„ä»£ç ï¼š

```js
function MyComponent() {

  useEffect(() => {

    // æ¯æ¬¡æ¸²æŸ“åéƒ½ä¼šæ‰§è¡Œæ­¤å¤„çš„ä»£ç 

  });

  return <div />;

}
```

æ¯å½“ä½ çš„ç»„ä»¶æ¸²æŸ“æ—¶ï¼ŒReact å°†æ›´æ–°å±å¹•ï¼Œç„¶åè¿è¡Œ `useEffect` ä¸­çš„ä»£ç ã€‚æ¢å¥è¯è¯´ï¼Œ**useEffect ä¼šæŠŠè¿™æ®µä»£ç æ”¾åˆ°å±å¹•æ›´æ–°æ¸²æŸ“ä¹‹åæ‰§è¡Œ**ã€‚

è®©æˆ‘ä»¬çœ‹çœ‹å¦‚ä½•ä½¿ç”¨ Effect ä¸å¤–éƒ¨ç³»ç»ŸåŒæ­¥ã€‚è€ƒè™‘ä¸€ä¸ª `<VideoPlayer>` React ç»„ä»¶ã€‚é€šè¿‡ä¼ é€’å¸ƒå°”ç±»å‹çš„ `isPlaying` prop ä»¥æ§åˆ¶æ˜¯æ’­æ”¾è¿˜æ˜¯æš‚åœï¼š

```js
<VideoPlayer isPlaying={isPlaying} />;
```

è‡ªå®šä¹‰çš„ `VideoPlayer` ç»„ä»¶æ¸²æŸ“äº†å†…ç½®çš„ [`video`](https://developer.mozilla.org/zh-CN/docs/Web/HTML/Element/video) æ ‡ç­¾ï¼š

```js
function VideoPlayer({ src, isPlaying }) {

  // TODOï¼šä½¿ç”¨ isPlaying åšä¸€äº›äº‹æƒ…

  return <video src={src} />;

}
```

ä½†æ˜¯ï¼Œæµè§ˆå™¨çš„ `<video>` æ ‡ç­¾æ²¡æœ‰ `isPlaying` å±æ€§ã€‚æ§åˆ¶å®ƒçš„å”¯ä¸€æ–¹å¼æ˜¯åœ¨ DOM å…ƒç´ ä¸Šè°ƒç”¨ [`play()`](https://developer.mozilla.org/zh-CN/docs/Web/API/HTMLMediaElement/play) å’Œ [`pause()`](https://developer.mozilla.org/zh-CN/docs/Web/API/HTMLMediaElement/pause) æ–¹æ³•ã€‚å› æ­¤ï¼Œ**ä½ éœ€è¦å°† isPlaying prop çš„å€¼ä¸ play() å’Œ pause() ç­‰å‡½æ•°çš„è°ƒç”¨è¿›è¡ŒåŒæ­¥ï¼Œè¯¥å±æ€§ç”¨äºå‘ŠçŸ¥å½“å‰è§†é¢‘æ˜¯å¦åº”è¯¥æ’­æ”¾**ã€‚

é¦–å…ˆè¦è·å– `<video>`  DOM èŠ‚ç‚¹çš„ [å¯¹è±¡å¼•ç”¨](https://zh-hans.react.dev/learn/manipulating-the-dom-with-refs)ã€‚

ä½ å¯èƒ½ä¼šå°è¯•åœ¨æ¸²æŸ“æœŸé—´è°ƒç”¨ `play()` æˆ– `pause()`ï¼Œä½†è¿™ç§åšæ³•æ˜¯é”™çš„ï¼š

```jsx
import { useState, useRef, useEffect } from 'react';

function VideoPlayer({ src, isPlaying }) {
  const ref = useRef(null);

  if (isPlaying) {
    ref.current.play();  // æ¸²æŸ“æœŸé—´ä¸èƒ½è°ƒç”¨ `play()`ã€‚ 
  } else {
    ref.current.pause(); // åŒæ ·ï¼Œè°ƒç”¨ `pause()` ä¹Ÿä¸è¡Œã€‚
  }

  return <video ref={ref} src={src} loop playsInline />;
}

export default function App() {
  const [isPlaying, setIsPlaying] = useState(false);
  return (
    <>
      <button onClick={() => setIsPlaying(!isPlaying)}>
        {isPlaying ? 'æš‚åœ' : 'æ’­æ”¾'}
      </button>
      <VideoPlayer
        isPlaying={isPlaying}
        src="https://interactive-examples.mdn.mozilla.net/media/cc0-videos/flower.mp4"
      />
    </>
  );
}
```

è¿™æ®µä»£ç ä¹‹æ‰€ä»¥ä¸æ­£ç¡®ï¼Œæ˜¯å› ä¸ºå®ƒè¯•å›¾åœ¨æ¸²æŸ“æœŸé—´å¯¹ DOM èŠ‚ç‚¹è¿›è¡Œæ“ä½œã€‚åœ¨ React ä¸­ï¼Œ[JSX çš„æ¸²æŸ“å¿…é¡»æ˜¯çº¯ç²¹æ“ä½œ](https://zh-hans.react.dev/learn/keeping-components-pure)ï¼Œä¸åº”è¯¥åŒ…å«ä»»ä½•åƒä¿®æ”¹ DOM çš„å‰¯ä½œç”¨ã€‚

è€Œä¸”ï¼Œå½“ç¬¬ä¸€æ¬¡è°ƒç”¨ `VideoPlayer` æ—¶ï¼Œå¯¹åº”çš„ DOM èŠ‚ç‚¹ç”šè‡³è¿˜ä¸å­˜åœ¨ï¼å¦‚æœè¿ DOM èŠ‚ç‚¹éƒ½æ²¡æœ‰ï¼Œé‚£ä¹ˆå¦‚ä½•è°ƒç”¨ `play()` æˆ– `pause()` æ–¹æ³•å‘¢ï¼åœ¨è¿”å› JSX ä¹‹å‰ï¼ŒReact ä¸çŸ¥é“è¦åˆ›å»ºä»€ä¹ˆ DOMã€‚

è§£å†³åŠæ³•æ˜¯ **ä½¿ç”¨ useEffect åŒ…è£¹å‰¯ä½œç”¨ï¼ŒæŠŠå®ƒåˆ†ç¦»åˆ°æ¸²æŸ“é€»è¾‘çš„è®¡ç®—è¿‡ç¨‹ä¹‹å¤–**ï¼š

```jsx
import { useEffect, useRef } from 'react';

function VideoPlayer({ src, isPlaying }) {
  const ref = useRef(null);

  useEffect(() => {
    if (isPlaying) {
      ref.current.play();
    } else {
      ref.current.pause();
    }
  });

  return <video ref={ref} src={src} loop playsInline />;
}
```

å½“ `VideoPlayer` ç»„ä»¶æ¸²æŸ“æ—¶ï¼ˆæ— è®ºæ˜¯å¦ä¸ºé¦–æ¬¡æ¸²æŸ“ï¼‰ï¼Œéƒ½ä¼šå‘ç”Ÿä»¥ä¸‹äº‹æƒ…ã€‚é¦–å…ˆï¼ŒReact ä¼šåˆ·æ–°å±å¹•ï¼Œç¡®ä¿ `<video>` å…ƒç´ å·²ç»æ­£ç¡®åœ°å‡ºç°åœ¨ DOM ä¸­ï¼›ç„¶åï¼ŒReact å°†è¿è¡Œ Effectï¼›æœ€åï¼ŒEffect å°†æ ¹æ® `isPlaying` çš„å€¼è°ƒç”¨ `play()` æˆ– `pause()`ã€‚

> é™·é˜±ï¼š
>
> > 
>
> ä¸€èˆ¬æ¥è¯´ï¼ŒEffect ä¼šåœ¨  **æ¯æ¬¡** æ¸²æŸ“åæ‰§è¡Œï¼Œ**è€Œä»¥ä¸‹ä»£ç ä¼šé™·å…¥æ­»å¾ªç¯ä¸­**ï¼š
>
> ```js
> const [count, setCount] = useState(0);
>
> useEffect(() => {
>
>   setCount(count + 1);
>
> });
> ```
>
> æ¯æ¬¡æ¸²æŸ“ç»“æŸéƒ½ä¼šæ‰§è¡Œ Effectï¼›è€Œæ›´æ–° state ä¼šè§¦å‘é‡æ–°æ¸²æŸ“ã€‚ä½†æ˜¯æ–°ä¸€è½®æ¸²æŸ“æ—¶åˆä¼šå†æ¬¡æ‰§è¡Œ Effectï¼Œç„¶å Effect å†æ¬¡æ›´æ–° stateâ€¦â€¦å¦‚æ­¤å‘¨è€Œå¤å§‹ï¼Œä»è€Œé™·å…¥æ­»å¾ªç¯ã€‚
>
> Effect é€šå¸¸åº”è¯¥ä½¿ç»„ä»¶ä¸ **å¤–éƒ¨** ç³»ç»Ÿä¿æŒåŒæ­¥ã€‚å¦‚æœæ²¡æœ‰å¤–éƒ¨ç³»ç»Ÿï¼Œä½ åªæƒ³æ ¹æ®å…¶ä»–çŠ¶æ€è°ƒæ•´ä¸€äº›çŠ¶æ€ï¼Œé‚£ä¹ˆ [ä½ ä¹Ÿè®¸ä¸éœ€è¦ Effect](https://zh-hans.react.dev/learn/you-might-not-need-an-effect)ã€‚



#### æŒ‡å®šEffectä¾èµ–

ä¸€èˆ¬æ¥è¯´ï¼ŒEffect ä¼šåœ¨ **æ¯æ¬¡** æ¸²æŸ“æ—¶æ‰§è¡Œã€‚**ä½†æ›´å¤šæ—¶å€™ï¼Œå¹¶ä¸éœ€è¦æ¯æ¬¡æ¸²æŸ“çš„æ—¶å€™éƒ½æ‰§è¡Œ Effect**ã€‚

- æœ‰æ—¶è¿™ä¼šæ‹–æ…¢è¿è¡Œé€Ÿåº¦ã€‚å› ä¸ºä¸å¤–éƒ¨ç³»ç»Ÿçš„åŒæ­¥æ“ä½œæ€»æ˜¯æœ‰ä¸€å®šæ—¶è€—ï¼Œåœ¨éå¿…è¦æ—¶å¯èƒ½å¸Œæœ›è·³è¿‡å®ƒã€‚ä¾‹å¦‚ï¼Œæ²¡æœ‰äººä¼šå¸Œæœ›æ¯æ¬¡ç”¨é”®ç›˜æ‰“å­—æ—¶éƒ½é‡æ–°è¿æ¥èŠå¤©æœåŠ¡å™¨ã€‚
- æœ‰æ—¶è¿™ä¼šå¯¼è‡´ç¨‹åºé€»è¾‘é”™è¯¯ã€‚ä¾‹å¦‚ï¼Œç»„ä»¶çš„æ·¡å…¥åŠ¨ç”»åªéœ€è¦åœ¨ç¬¬ä¸€è½®æ¸²æŸ“å‡ºç°æ—¶æ’­æ”¾ä¸€æ¬¡ï¼Œè€Œä¸æ˜¯æ¯æ¬¡è§¦å‘æ–°ä¸€è½®æ¸²æŸ“åéƒ½æ’­æ”¾ã€‚

ä¾‹å¦‚ä¸Šé¢çš„æ’­æ”¾å™¨ä¾‹å­ï¼Œæˆ‘ä»¬å¹¶ä¸éœ€è¦åœ¨æ¯æ¬¡æ¸²æŸ“éƒ½æ‰§è¡ŒEffect

å‡è®¾é¡µé¢ä¸­è¿˜å­˜åœ¨ä¸€ä¸ªinputçš„stateï¼Œé‚£ä¹ˆè¿™æ ·ä¼šå¯¼è‡´æˆ‘ä»¬åœ¨è¾“å…¥ä¸€ä¸ªå­—ç¬¦å°±ä¼šæ‰§è¡Œä¸€æ¬¡Effect

å› æ­¤ï¼Œæˆ‘ä»¬éœ€è¦æŒ‡å®šåœ¨ä»€ä¹ˆstateå¯¼è‡´æ¸²æŸ“æ—¶æ‰æ‰§è¡ŒEffect

```jsx
  useEffect(() => {
    if (isPlaying) { // isPlaying åœ¨æ­¤å¤„ä½¿ç”¨â€¦â€¦
      // ...
    } else {
      // ...
    }
  }, [isPlaying]); // â€¦â€¦æ‰€ä»¥å®ƒå¿…é¡»åœ¨æ­¤å¤„å£°æ˜ï¼
```

ä¾èµ–æ•°ç»„å¯ä»¥åŒ…å«å¤šä¸ªä¾èµ–é¡¹ã€‚**å½“æŒ‡å®šçš„æ‰€æœ‰ä¾èµ–é¡¹åœ¨ä¸Šä¸€æ¬¡æ¸²æŸ“æœŸé—´çš„å€¼ä¸å½“å‰å€¼å®Œå…¨ç›¸åŒæ—¶ï¼ŒReact ä¼šè·³è¿‡é‡æ–°è¿è¡Œè¯¥ Effect**ã€‚React ä½¿ç”¨ [`Object.is`](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Object/is) æ¯”è¾ƒä¾èµ–é¡¹çš„å€¼ã€‚

> ==æ³¨æ„ï¼š==
>
> æ²¡æœ‰ä¾èµ–æ•°ç»„ä½œä¸ºç¬¬äºŒä¸ªå‚æ•°ï¼Œä¸ä¾èµ–æ•°ç»„ä½ç©ºæ•°ç»„ `[]` çš„è¡Œä¸ºæ˜¯ä¸ä¸€è‡´çš„ï¼š
>
> ```jsx
> useEffect(() => {
>   // è¿™é‡Œçš„ä»£ç ä¼šåœ¨æ¯æ¬¡æ¸²æŸ“åæ‰§è¡Œ
> });
>
> useEffect(() => {
>   // è¿™é‡Œçš„ä»£ç åªä¼šåœ¨ç»„ä»¶æŒ‚è½½åæ‰§è¡Œ
> }, []);
>
> useEffect(() => {
>   //è¿™é‡Œçš„ä»£ç åªä¼šåœ¨æ¯æ¬¡æ¸²æŸ“åï¼Œå¹¶ä¸” a æˆ– b çš„å€¼ä¸ä¸Šæ¬¡æ¸²æŸ“ä¸ä¸€è‡´æ—¶æ‰§è¡Œ
> }, [a, b]);
> ```
>
> 



> ä¸ºä»€ä¹ˆä¾èµ–æ•°ç»„ä¸­å¯ä»¥çœç•¥refï¼Ÿ
>
> ä¸‹é¢çš„ Effect åŒæ—¶ä½¿ç”¨äº† `ref` ä¸ `isPlaying` propï¼Œä½†æ˜¯åªæœ‰ `isPlaying` è¢«å£°æ˜ä¸ºäº†ä¾èµ–é¡¹ï¼š
>
> ```js
> function VideoPlayer({ src, isPlaying }) {
>
>   const ref = useRef(null);
>
>   useEffect(() => {
>
>     if (isPlaying) {
>
>       ref.current.play();
>
>     } else {
>
>       ref.current.pause();
>
>     }
>
>   }, [isPlaying]);
> ```
>
> è¿™æ˜¯å› ä¸º `ref` å…·æœ‰ **ç¨³å®š** çš„æ ‡è¯†ï¼šReact ä¿è¯ [æ¯è½®æ¸²æŸ“ä¸­è°ƒç”¨ `useRef` æ‰€äº§ç”Ÿçš„å¼•ç”¨å¯¹è±¡æ—¶ï¼Œè·å–åˆ°çš„å¯¹è±¡å¼•ç”¨æ€»æ˜¯ç›¸åŒçš„](https://zh-hans.react.dev/reference/react/useRef#returns)ï¼Œ**å³è·å–åˆ°çš„å¯¹è±¡å¼•ç”¨æ°¸è¿œä¸ä¼šæ”¹å˜ï¼Œæ‰€ä»¥å®ƒä¸ä¼šå¯¼è‡´é‡æ–°è¿è¡Œ Effec**tã€‚å› æ­¤ï¼Œä¾èµ–æ•°ç»„ä¸­æ˜¯å¦åŒ…å«å®ƒå¹¶ä¸é‡è¦ã€‚å½“ç„¶ä¹Ÿå¯ä»¥åŒ…æ‹¬å®ƒï¼Œè¿™æ ·ä¹Ÿå¯ä»¥ï¼š
>
> ```js
> function VideoPlayer({ src, isPlaying }) {
>
>   const ref = useRef(null);
>
>   useEffect(() => {
>
>     if (isPlaying) {
>
>       ref.current.play();
>
>     } else {
>
>       ref.current.pause();
>
>     }
>
>   }, [isPlaying, ref]);
> ```
>
> `useState` è¿”å›çš„ [`set` å‡½æ•°](https://zh-hans.react.dev/reference/react/useState#setstate) ä¹Ÿæœ‰ç¨³å®šçš„æ ‡è¯†ç¬¦ï¼Œæ‰€ä»¥ä¹Ÿå¯ä»¥æŠŠå®ƒä»ä¾èµ–æ•°ç»„ä¸­å¿½ç•¥æ‰ã€‚å¦‚æœåœ¨å¿½ç•¥æŸä¸ªä¾èµ–é¡¹æ—¶ linter ä¸ä¼šæŠ¥é”™ï¼Œé‚£ä¹ˆè¿™ä¹ˆåšå°±æ˜¯å®‰å…¨çš„ã€‚
>
> ä½†æ˜¯ï¼Œä»…åœ¨ linter å¯ä»¥â€œçœ‹åˆ°â€å¯¹è±¡ç¨³å®šæ—¶ï¼Œå¿½ç•¥ç¨³å®šä¾èµ–é¡¹çš„è§„åˆ™æ‰ä¼šèµ·ä½œç”¨ã€‚ä¾‹å¦‚ï¼Œå¦‚æœ `ref` æ˜¯ä»çˆ¶ç»„ä»¶ä¼ é€’çš„ï¼Œåˆ™å¿…é¡»åœ¨ä¾èµ–é¡¹æ•°ç»„ä¸­æŒ‡å®šå®ƒã€‚è¿™æ ·åšæ˜¯åˆé€‚çš„ï¼Œå› ä¸ºæ— æ³•ç¡®å®šçˆ¶ç»„ä»¶æ˜¯å¦å§‹ç»ˆæ˜¯ä¼ é€’ç›¸åŒçš„ refï¼Œæˆ–è€…å¯èƒ½æ˜¯æœ‰æ¡ä»¶åœ°ä¼ é€’å‡ ä¸ª ref ä¹‹ä¸€ã€‚å› æ­¤ï¼Œä½ çš„ Effect å°†å–å†³äºä¼ é€’çš„æ˜¯å“ªä¸ª refã€‚





#### æŒ‰éœ€æ·»åŠ cleanå‡½æ•°

è€ƒè™‘ä¸€ä¸ªä¸åŒçš„ä¾‹å­ã€‚ä½ æ­£åœ¨ç¼–å†™ä¸€ä¸ª `ChatRoom` ç»„ä»¶ï¼Œè¯¥ç»„ä»¶å‡ºç°æ—¶éœ€è¦è¿æ¥åˆ°èŠå¤©æœåŠ¡å™¨ã€‚ç°åœ¨ä¸ºä½ æä¾›äº† `createConnection()` APIï¼Œè¯¥ API è¿”å›ä¸€ä¸ªåŒ…å« `connect()` ä¸ `disconnection()` æ–¹æ³•çš„å¯¹è±¡ã€‚è€ƒè™‘å½“ç»„ä»¶å±•ç¤ºç»™ç”¨æˆ·æ—¶ï¼Œåº”è¯¥å¦‚ä½•ä¿æŒè¿æ¥ï¼Ÿ

ä»ç¼–å†™ Effect é€»è¾‘å¼€å§‹ï¼š

```js
useEffect(() => {

  const connection = createConnection();

  connection.connect();

});
```

æ¯æ¬¡é‡æ–°æ¸²æŸ“åè¿æ¥åˆ°èŠå¤©å®¤ä¼šå¾ˆæ…¢ï¼Œå› æ­¤å¯ä»¥æ·»åŠ ä¾èµ–æ•°ç»„ï¼š

```js
useEffect(() => {

  const connection = createConnection();

  connection.connect();

}, []);
```

**åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼ŒEffect ä¸­çš„ä»£ç æ²¡æœ‰ä½¿ç”¨ä»»ä½• props æˆ– stateï¼Œæ­¤æ—¶æŒ‡å®šä¾èµ–æ•°ç»„ä¸ºç©ºæ•°ç»„ []ã€‚è¿™å‘Šè¯‰ React ä»…åœ¨ç»„ä»¶â€œæŒ‚è½½â€æ—¶è¿è¡Œæ­¤ä»£ç ï¼Œå³é¦–æ¬¡å‡ºç°åœ¨å±å¹•ä¸Šè¿™ä¸€é˜¶æ®µ**ã€‚

![71731533390](Reacté«˜çº§.assets/1717315333903.png)

å®é™…è¿è¡Œä¼šå‘ç°ï¼Œå®é™…è¿æ¥ä¼šè¿›è¡Œä¸¤æ¬¡ï¼Œè¿™æ˜¯ç”±äºReactçš„ä¸¥æ ¼æ¨¡å¼çš„åŸå› ï¼Œå› æ­¤æˆ‘ä»¬ä¹Ÿèƒ½å¤ŸçŸ¥é“è¿™æ®µä»£ç æ˜¯å­˜åœ¨é—®é¢˜çš„ï¼š

æƒ³è±¡ `ChatRoom` ç»„ä»¶æ˜¯ä¸€ä¸ªå¤§è§„æ¨¡çš„ App ä¸­è®¸å¤šç•Œé¢ä¸­çš„ä¸€éƒ¨åˆ†ã€‚ç”¨æˆ·åˆ‡æ¢åˆ°å«æœ‰ `ChatRoom` ç»„ä»¶çš„é¡µé¢ä¸Šæ—¶ï¼Œè¯¥ç»„ä»¶è¢«æŒ‚è½½ï¼Œå¹¶è°ƒç”¨ `connection.connect()` æ–¹æ³•è¿æ¥æœåŠ¡å™¨ã€‚ç„¶åæƒ³è±¡ç”¨æˆ·æ­¤æ—¶çªç„¶å¯¼èˆªåˆ°å¦ä¸€ä¸ªé¡µé¢ï¼Œæ¯”å¦‚åˆ‡æ¢åˆ°â€œè®¾ç½®â€é¡µé¢ã€‚è¿™æ—¶ï¼Œ`ChatRoom` ç»„ä»¶å°±è¢«å¸è½½äº†ã€‚æ¥ä¸‹æ¥ï¼Œç”¨æˆ·åœ¨â€œè®¾ç½®â€é¡µé¢å¿™å®Œåï¼Œå•å‡»â€œè¿”å›â€ï¼Œå›åˆ°ä¸Šä¸€ä¸ªé¡µé¢ï¼Œå¹¶å†æ¬¡æŒ‚è½½ `ChatRoom`ã€‚è¿™å°†å»ºç«‹ç¬¬äºŒæ¬¡è¿æ¥ï¼Œä½†æ˜¯ï¼Œç¬¬ä¸€æ¬¡æ—¶åˆ›å»ºçš„è¿æ¥ä»æœªè¢«é”€æ¯ï¼å½“ç”¨æˆ·åœ¨åº”ç”¨ç¨‹åºä¸­ä¸æ–­åˆ‡æ¢ç•Œé¢å†è¿”å›æ—¶ï¼Œä¸æœåŠ¡å™¨çš„è¿æ¥ä¼šä¸æ–­å †ç§¯ã€‚

ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå¯ä»¥åœ¨ Effect ä¸­è¿”å›ä¸€ä¸ª **æ¸…ç†ï¼ˆcleanupï¼‰** å‡½æ•°ã€‚

```js
  useEffect(() => {

    const connection = createConnection();

    connection.connect();

    return () => {

      connection.disconnect();

    };

  }, []);
```

**æ¯æ¬¡é‡æ–°æ‰§è¡Œ Effect ä¹‹å‰ï¼ŒReact éƒ½ä¼šè°ƒç”¨æ¸…ç†å‡½æ•°ï¼›ç»„ä»¶è¢«å¸è½½æ—¶ï¼Œä¹Ÿä¼šè°ƒç”¨æ¸…ç†å‡½æ•°**ã€‚è®©æˆ‘ä»¬çœ‹çœ‹æ‰§è¡Œæ¸…ç†å‡½æ•°ä¼šåšäº›ä»€ä¹ˆï¼š

![71731543265](Reacté«˜çº§.assets/1717315432654.png)

æ­¤æ—¶çš„è¿è¡Œç»“æœæ‰æ˜¯æ­£ç¡®çš„

**åœ¨ç”Ÿäº§ç¯å¢ƒä¸‹ï¼Œ"âœ… è¿æ¥ä¸­â€¦â€¦" åªä¼šè¢«æ‰“å°ä¸€æ¬¡**ã€‚ä¹Ÿå°±æ˜¯è¯´ä»…åœ¨å¼€å‘ç¯å¢ƒä¸‹æ‰ä¼šé‡å¤æŒ‚è½½ç»„ä»¶ï¼Œä»¥å¸®åŠ©ä½ æ‰¾åˆ°éœ€è¦æ¸…ç†çš„ Effectã€‚ä½ å¯ä»¥é€‰æ‹©å…³é—­ [ä¸¥æ ¼æ¨¡å¼](https://zh-hans.react.dev/reference/react/StrictMode) æ¥å…³é—­å¼€å‘ç¯å¢ƒä¸‹ç‰¹æœ‰çš„è¡Œä¸ºï¼Œä½†æˆ‘ä»¬å»ºè®®ä¿ç•™å®ƒã€‚è¿™å¯ä»¥å¸®åŠ©å‘ç°è®¸å¤šä¸Šé¢è¿™æ ·çš„é”™è¯¯ã€‚





### æ§åˆ¶éReactç»„ä»¶

æœ‰æ—¶éœ€è¦æ·»åŠ ä¸æ˜¯ä½¿ç”¨ React ç¼–å†™çš„ UI å°éƒ¨ä»¶ã€‚ä¾‹å¦‚ï¼Œå‡è®¾ä½ è¦å‘é¡µé¢æ·»åŠ åœ°å›¾ç»„ä»¶ï¼Œå¹¶ä¸”å®ƒæœ‰ä¸€ä¸ª `setZoomLevel()` æ–¹æ³•ï¼Œä½ å¸Œæœ›è°ƒæ•´ç¼©æ”¾çº§åˆ«ï¼ˆzoom levelï¼‰å¹¶ä¸ React ä»£ç ä¸­çš„ `zoomLevel` state å˜é‡ä¿æŒåŒæ­¥ã€‚Effect çœ‹èµ·æ¥åº”è¯¥ä¸ä¸‹é¢ç±»ä¼¼ï¼š

```js
useEffect(() => {

  const map = mapRef.current;

  map.setZoomLevel(zoomLevel);

}, [zoomLevel]);
```

è¯·æ³¨æ„ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ä¸éœ€è¦æ¸…ç†ã€‚åœ¨å¼€å‘ç¯å¢ƒä¸­ï¼ŒReact ä¼šè°ƒç”¨ Effect ä¸¤æ¬¡ï¼Œä½†è¿™ä¸¤æ¬¡æŒ‚è½½æ—¶ä¾èµ–é¡¹ `zoomLevel` éƒ½æ˜¯ç›¸åŒçš„ï¼Œæ‰€ä»¥ä¼šè·³è¿‡æ‰§è¡Œç¬¬äºŒæ¬¡æŒ‚è½½æ—¶çš„ Effectã€‚å¼€å‘ç¯å¢ƒä¸­å®ƒå¯èƒ½ä¼šç¨å¾®æ…¢ä¸€äº›ï¼Œä½†è¿™é—®é¢˜ä¸å¤§ï¼Œå› ä¸ºå®ƒåœ¨ç”Ÿäº§ä¸­ä¸ä¼šè¿›è¡Œä¸å¿…è¦çš„é‡å¤æŒ‚è½½ã€‚

æŸäº› API å¯èƒ½ä¸å…è®¸è¿ç»­è°ƒç”¨ä¸¤æ¬¡ã€‚ä¾‹å¦‚ï¼Œå†…ç½®çš„ [``](https://developer.mozilla.org/zh-CN/docs/Web/API/HTMLDialogElement) å…ƒç´ çš„ [`showModal`](https://developer.mozilla.org/zh-CN/docs/Web/API/HTMLDialogElement/showModal) æ–¹æ³•åœ¨è¿ç»­è°ƒç”¨ä¸¤æ¬¡æ—¶ä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œæ­¤æ—¶å®ç°æ¸…ç†å‡½æ•°å¹¶ä½¿å…¶å…³é—­å¯¹è¯æ¡†ï¼š

```js
useEffect(() => {

  const dialog = dialogRef.current;

  dialog.showModal();

  return () => dialog.close();

}, []);
```

åœ¨å¼€å‘ç¯å¢ƒä¸­ï¼ŒEffect å°†è°ƒç”¨ `showModal()`ï¼Œç„¶åç«‹å³è°ƒç”¨ `close()`ï¼Œç„¶åå†æ¬¡è°ƒç”¨ `showModal()`ã€‚è¿™ä¸è°ƒç”¨åªä¸€æ¬¡ `showModal()` çš„æ•ˆæœç›¸åŒã€‚ä¹Ÿæ­£å¦‚åœ¨ç”Ÿäº§ç¯å¢ƒä¸­çœ‹åˆ°çš„é‚£æ ·ã€‚



### è®¢é˜…äº‹ä»¶

å¦‚æœ Effect è®¢é˜…äº†æŸäº›äº‹ä»¶ï¼Œæ¸…ç†å‡½æ•°åº”è¯¥é€€è®¢è¿™äº›äº‹ä»¶ï¼š

```js
useEffect(() => {

  function handleScroll(e) {

    console.log(window.scrollX, window.scrollY);

  }

  window.addEventListener('scroll', handleScroll);

  return () => window.removeEventListener('scroll', handleScroll);

}, []);
```

åœ¨å¼€å‘ç¯å¢ƒä¸­ï¼ŒEffect ä¼šè°ƒç”¨ `addEventListener()`ï¼Œç„¶åç«‹å³è°ƒç”¨ `removeEventListener()`ï¼Œç„¶åå†è°ƒç”¨ç›¸åŒçš„ `addEventListener()`ï¼Œè¿™ä¸åªè®¢é˜…ä¸€æ¬¡äº‹ä»¶çš„ Effect ç­‰æ•ˆï¼›è¿™ä¹Ÿä¸ç”¨æˆ·åœ¨ç”Ÿäº§ç¯å¢ƒä¸­åªè°ƒç”¨ä¸€æ¬¡ `addEventListener()` å…·æœ‰ç›¸åŒçš„æ„ŸçŸ¥æ•ˆæœã€‚



### è§¦å‘åŠ¨ç”»

å¦‚æœ Effect å¯¹æŸäº›å†…å®¹åŠ å…¥äº†åŠ¨ç”»ï¼Œæ¸…ç†å‡½æ•°åº”å°†åŠ¨ç”»é‡ç½®ï¼š

```js
useEffect(() => {

  const node = ref.current;

  node.style.opacity = 1; // è§¦å‘åŠ¨ç”»

  return () => {

    node.style.opacity = 0; // é‡ç½®ä¸ºåˆå§‹å€¼

  };

}, []);
```

åœ¨å¼€å‘ç¯å¢ƒä¸­ï¼Œé€æ˜åº¦ç”± `1` å˜ä¸º `0`ï¼Œå†å˜ä¸º `1`ã€‚è¿™ä¸åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œç›´æ¥å°†å…¶è®¾ç½®ä¸º `1` å…·æœ‰ç›¸åŒçš„æ„ŸçŸ¥æ•ˆæœï¼Œå¦‚æœä½ ä½¿ç”¨æ”¯æŒè¿‡æ¸¡çš„ç¬¬ä¸‰æ–¹åŠ¨ç”»åº“ï¼Œä½ çš„æ¸…ç†å‡½æ•°åº”å°†æ—¶é—´è½´é‡ç½®ä¸ºå…¶åˆå§‹çŠ¶æ€ã€‚





### è¯·æ±‚æ•°æ®

å¦‚æœ Effect å°†ä¼šè·å–æ•°æ®ï¼Œæ¸…ç†å‡½æ•°åº”è¯¥è¦ä¹ˆ [ä¸­æ­¢è¯¥æ•°æ®è·å–æ“ä½œ](https://developer.mozilla.org/zh-CN/docs/Web/API/AbortController)ï¼Œè¦ä¹ˆå¿½ç•¥å…¶ç»“æœï¼š

```js
useEffect(() => {

  let ignore = false;

  async function startFetching() {

    const json = await fetchTodos(userId);

    if (!ignore) {

      setTodos(json);

    }

  }

  startFetching();

  return () => {

    ignore = true;

  };

}, [userId]);
```

æˆ‘ä»¬æ— æ³•æ’¤æ¶ˆå·²ç»å‘ç”Ÿçš„ç½‘ç»œè¯·æ±‚ï¼Œä½†æ˜¯æ¸…ç†å‡½æ•°åº”å½“ç¡®ä¿è·å–æ•°æ®çš„è¿‡ç¨‹ä»¥åŠè·å–åˆ°çš„ç»“æœä¸ä¼šç»§ç»­å½±å“ç¨‹åºè¿è¡Œã€‚å¦‚æœ `userId` ä» `'Alice'` å˜ä¸º `'Bob'`ï¼Œé‚£ä¹ˆè¯·ç¡®ä¿ `'Alice'` å“åº”æ•°æ®è¢«å¿½ç•¥ï¼Œå³ä½¿å®ƒåœ¨ `'Bob'` ä¹‹ååˆ°è¾¾ã€‚

**åœ¨å¼€å‘ç¯å¢ƒä¸­ï¼Œæµè§ˆå™¨è°ƒè¯•å·¥å…·çš„â€œç½‘ç»œâ€é€‰é¡¹å¡ä¸­ä¼šå‡ºç°ä¸¤ä¸ª fetch è¯·æ±‚**ã€‚è¿™æ˜¯æ­£å¸¸çš„ã€‚ä½¿ç”¨ä¸Šè¿°æ–¹æ³•ï¼Œç¬¬ä¸€ä¸ª Effect å°†ç«‹å³è¢«æ¸…ç†ï¼Œè€Œ `ignore` å°†è¢«è®¾ç½®ä¸º `true`ã€‚å› æ­¤ï¼Œå³ä½¿æœ‰é¢å¤–çš„è¯·æ±‚ï¼Œç”±äºæœ‰ `if (!ignore)` åˆ¤æ–­æ£€æŸ¥ï¼Œä¹Ÿä¸ä¼šå½±å“ç¨‹åºçŠ¶æ€ã€‚



### å‘é€åˆ†ææŠ¥å‘Š

è€ƒè™‘åœ¨è®¿é—®é¡µé¢æ—¶å‘é€æ—¥å¿—åˆ†æï¼š

```js
useEffect(() => {

  logVisit(url); // å‘é€ POST è¯·æ±‚

}, [url]);
```

åœ¨å¼€å‘ç¯å¢ƒä¸­ï¼Œ`logVisit` ä¼šä¸ºæ¯ä¸ª URL å‘é€ä¸¤æ¬¡è¯·æ±‚ï¼Œæ‰€ä»¥ä½ å¯èƒ½ä¼šæƒ³å°è¯•è§£å†³è¿™ä¸ªé—®é¢˜ã€‚**ä¸è¿‡æˆ‘ä»¬å»ºè®®ä¸å¿…ä¿®æ”¹æ­¤å¤„ä»£ç **ï¼Œä¸å‰é¢çš„ç¤ºä¾‹ä¸€æ ·ï¼Œä»ç”¨æˆ·çš„è§’åº¦æ¥çœ‹ï¼Œè¿è¡Œä¸€æ¬¡å’Œè¿è¡Œä¸¤æ¬¡ä¹‹é—´ä¸ä¼š **æ„ŸçŸ¥** åˆ°è¡Œä¸ºå·®å¼‚ã€‚ä»å®é™…çš„è§’åº¦æ¥çœ‹ï¼Œ`logVisit` ä¸åº”è¯¥åœ¨å¼€å‘ç¯å¢ƒä¸­åšä»»ä½•å½±å“ç”Ÿäº§äº‹æƒ…ã€‚ç”±äºæ¯æ¬¡ä¿å­˜ä»£ç æ–‡ä»¶æ—¶éƒ½ä¼šé‡æ–°æŒ‚è½½ç»„ä»¶ï¼Œå› æ­¤åœ¨å¼€å‘ç¯å¢ƒä¸­ä¼šé¢å¤–è®°å½•è®¿é—®æ¬¡æ•°ã€‚

**åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œä¸ä¼šäº§ç”Ÿæœ‰é‡å¤çš„è®¿é—®æ—¥å¿—**ã€‚

ä¸ºäº†è°ƒè¯•å‘é€çš„åˆ†æäº‹ä»¶ï¼Œå¯ä»¥å°†åº”ç”¨éƒ¨ç½²åˆ°ä¸€ä¸ªè¿è¡Œåœ¨ç”Ÿäº§æ¨¡å¼ä¸‹çš„æš‚å­˜ç¯å¢ƒï¼Œæˆ–è€…æš‚æ—¶å–æ¶ˆ [ä¸¥æ ¼æ¨¡å¼](https://zh-hans.react.dev/reference/react/StrictMode) åŠå…¶ä»…åœ¨å¼€å‘ç¯å¢ƒä¸­é‡æ–°åŠ è½½æ£€æŸ¥ï¼›è¿˜å¯ä»¥ä»è·¯ç”±å˜æ›´äº‹ä»¶å¤„ç†ç¨‹åºä¸­å‘é€åˆ†ææ•°æ®ï¼Œè€Œä¸æ˜¯ä» Effect ä¸­å‘é€ã€‚ä¸ºäº†æ›´ç²¾ç¡®çš„åˆ†æï¼Œå¯ä»¥ä½¿ç”¨ [Intersection Observer](https://developer.mozilla.org/zh-CN/docs/Web/API/Intersection_Observer_API) æ¥è·Ÿè¸ªå“ªäº›ç»„ä»¶ä½äºè§†å£ä¸­ä»¥åŠå®ƒä»¬ä¿æŒå¯è§çš„æ—¶é—´ã€‚



### åˆå§‹åŒ–åº”ç”¨æ— éœ€Effectçš„æƒ…å½¢

æŸäº›é€»è¾‘åº”è¯¥åªåœ¨åº”ç”¨ç¨‹åºå¯åŠ¨æ—¶è¿è¡Œä¸€æ¬¡ã€‚æ¯”å¦‚ï¼ŒéªŒè¯ç™»é™†çŠ¶æ€å’ŒåŠ è½½æœ¬åœ°ç¨‹åºæ•°æ®ã€‚ä½ å¯ä»¥å°†å…¶æ”¾åœ¨ç»„ä»¶ä¹‹å¤–ï¼š

```js
if (typeof window !== 'undefined') { // æ£€æŸ¥æ˜¯å¦åœ¨æµè§ˆå™¨ä¸­è¿è¡Œ

  checkAuthToken();

  loadDataFromLocalStorage();

}



function App() {

  // â€¦â€¦

}
```

è¿™ä¿è¯äº†è¿™ç§é€»è¾‘åœ¨æµè§ˆå™¨åŠ è½½é¡µé¢ååªè¿è¡Œä¸€æ¬¡ã€‚



### ä¸è¦åœ¨Effectä¸­æ‰§è¡Œè´­ä¹°å•†å“ä¸€ç±»æ“ä½œ

æœ‰æ—¶ï¼Œå³ä½¿ç¼–å†™äº†ä¸€ä¸ªæ¸…ç†å‡½æ•°ï¼Œä¹Ÿä¸èƒ½é¿å…æ‰§è¡Œä¸¤æ¬¡ Effectã€‚ä¾‹å¦‚ï¼ŒEffect åŒ…å«ä¼šå‘é€ POST è¯·æ±‚ä»¥æ‰§è¡Œè´­ä¹°æ“ä½œï¼š

```js
useEffect(() => {

  // ğŸ”´ é”™è¯¯ï¼šæ­¤å¤„çš„ Effect ä¼šåœ¨å¼€å‘ç¯å¢ƒä¸­æ‰§è¡Œä¸¤æ¬¡ï¼Œè¿™åœ¨ä»£ç ä¸­æ˜¯æœ‰é—®é¢˜çš„ã€‚

  fetch('/api/buy', { method: 'POST' });

}, []);
```

ä¸€æ–¹é¢ï¼Œå¼€å‘ç¯å¢ƒä¸‹ï¼ŒEffect ä¼šæ‰§è¡Œä¸¤æ¬¡ï¼Œè¿™æ„å‘³ç€è´­ä¹°æ“ä½œæ‰§è¡Œäº†ä¸¤æ¬¡ï¼Œä½†æ˜¯è¿™å¹¶éæ˜¯é¢„æœŸçš„ç»“æœï¼Œæ‰€ä»¥ä¸åº”è¯¥æŠŠè¿™ä¸ªä¸šåŠ¡é€»è¾‘æ”¾åœ¨ Effect ä¸­ã€‚å¦ä¸€æ–¹é¢ï¼Œå¦‚æœç”¨æˆ·è½¬åˆ°å¦ä¸€ä¸ªé¡µé¢ï¼Œç„¶åæŒ‰â€œåé€€â€æŒ‰é’®å›åˆ°äº†è¿™ä¸ªç•Œé¢ï¼Œè¯¥æ€ä¹ˆåŠï¼ŸEffect ä¼šéšç€ç»„ä»¶å†æ¬¡æŒ‚è½½è€Œå†æ¬¡æ‰§è¡Œã€‚æ‰€ä»¥ï¼Œå½“ç”¨æˆ·é‡æ–°è®¿é—®æŸä¸ªé¡µé¢æ—¶ï¼Œä¸åº”å½“æ‰§è¡Œè´­ä¹°æ“ä½œï¼›å½“åªæœ‰ç”¨æˆ·ç‚¹å‡»â€œè´­ä¹°â€æŒ‰é’®æ—¶ï¼Œæ‰æ‰§è¡Œè´­ä¹°æ“ä½œã€‚

å› æ­¤ï¼Œâ€œè´­ä¹°â€çš„æ“ä½œä¸åº”ç”±ç»„ä»¶çš„æŒ‚è½½ã€æ¸²æŸ“å¼•èµ·çš„ï¼›å®ƒæ˜¯ç”±ç‰¹å®šçš„äº¤äº’ä½œç”¨å¼•èµ·çš„ï¼Œå®ƒåº”è¯¥åªåœ¨ç”¨æˆ·æŒ‰ä¸‹æŒ‰é’®æ—¶è¿è¡Œã€‚å› æ­¤ï¼Œ**å®ƒä¸åº”è¯¥å†™åœ¨ Effect ä¸­ï¼Œåº”å½“æŠŠ /api/buy è¯·æ±‚æ“ä½œç§»åŠ¨åˆ°è´­ä¹°æŒ‰é’®äº‹ä»¶å¤„ç†ç¨‹åºä¸­**ï¼š

```js
  function handleClick() {

    // âœ… è´­ä¹°å•†å“åº”å½“åœ¨äº‹ä»¶ä¸­æ‰§è¡Œï¼Œå› ä¸ºè¿™æ˜¯ç”±ç‰¹å®šçš„æ“ä½œå¼•èµ·çš„ã€‚

    fetch('/api/buy', { method: 'POST' });

  }
```

**è¿™ä¸ªä¾‹å­è¯´æ˜å¦‚æœé‡æ–°æŒ‚è½½ç ´åäº†åº”ç”¨ç¨‹åºçš„é€»è¾‘ï¼Œåˆ™é€šå¸¸å«æœ‰æœªè¢«å‘ç°çš„é”™è¯¯**ã€‚ä»ç”¨æˆ·çš„è§’åº¦æ¥çœ‹ï¼Œè®¿é—®ä¸€ä¸ªé¡µé¢ä¸åº”è¯¥ä¸è®¿é—®å®ƒã€ç‚¹å‡»é“¾æ¥ç„¶åæŒ‰ä¸‹è¿”å›é”®å†æ¬¡æŸ¥çœ‹é¡µé¢æœ‰ä»€ä¹ˆä¸åŒã€‚React é€šè¿‡åœ¨å¼€å‘ç¯å¢ƒä¸­é‡å¤æŒ‚è½½ç»„ä»¶ä»¥éªŒè¯ç»„ä»¶æ˜¯å¦éµå®ˆæ­¤åŸåˆ™ã€‚



> ==æ¯ä¸€è½®æ¸²æŸ“éƒ½æœ‰è‡ªå·±çš„Effect==
>
> ä½ å¯ä»¥å°† `useEffect` è®¤ä¸ºå…¶å°†ä¸€æ®µè¡Œä¸ºâ€œé™„åŠ â€åˆ°æ¸²æŸ“è¾“å‡ºã€‚è€ƒè™‘è¿™ç§æƒ…å†µï¼š
>
> ```js
> export default function ChatRoom({ roomId }) {
>
>   useEffect(() => {
>
>     const connection = createConnection(roomId);
>
>     connection.connect();
>
>     return () => connection.disconnect();
>
>   }, [roomId]);
>
>
>
>   return <h1>æ¬¢è¿æ¥åˆ° {roomId}ï¼</h1>;
>
> }
> ```
>
> è®©æˆ‘ä»¬çœ‹çœ‹å½“ç”¨æˆ·åœ¨åº”ç”¨ç¨‹åºä¸­åˆ‡æ¢é¡µé¢æ—¶åˆ°åº•å‘ç”Ÿäº†ä»€ä¹ˆã€‚
>
> - åˆå§‹æ¸²æŸ“ 
>
> ç”¨æˆ·è®¿é—® `<ChatRoom roomId="general" />`ï¼Œåœ¨è¿™é‡Œè®©æˆ‘ä»¬ [å‡è®¾](https://zh-hans.react.dev/learn/state-as-a-snapshot#rendering-takes-a-snapshot-in-time) `roomId` çš„å€¼ä¸º `'general'` ï¼š
>
> ```js
>   // é¦–æ¬¡æ¸²æŸ“æ—¶çš„ JSXï¼ˆroomId ä¸º "general"ï¼‰
>
>   return <h1>æ¬¢è¿æ¥åˆ° generalï¼</h1>;
> ```
>
> **Effect ä¹Ÿæ˜¯æ¸²æŸ“è¾“å‡ºçš„ä¸€éƒ¨åˆ†**ã€‚é¦–æ¬¡æ¸²æŸ“çš„ Effect å˜ä¸ºï¼š
>
> ```js
>   //é¦–å…ˆæ¸²æŸ“æ—¶çš„ Effectï¼ˆroomId ä¸º "general"ï¼‰
>
>   () => {
>
>     const connection = createConnection('general');
>
>     connection.connect();
>
>     return () => connection.disconnect();
>
>   },
>
>   // é¦–æ¬¡æ¸²æŸ“æ—¶çš„ä¾èµ–é¡¹ï¼ˆroomId ä¸º "general"ï¼‰
>
>   ['general']
> ```
>
> React å°†ä¼šæ‰§è¡Œç”¨äºè¿æ¥åˆ° `'general'` èŠå¤©å®¤çš„ Effectã€‚
>
> - ä¾èµ–é¡¹ç›¸åŒæ—¶çš„é‡æ–°æ¸²æŸ“ 
>
> è®©æˆ‘ä»¬æ¢è®¨ä¸‹ `<ChatRoom roomId="general" />` çš„é‡å¤æ¸²æŸ“ã€‚JSX çš„è¾“å‡ºç»“æœä»ç„¶ç›¸åŒï¼š
>
> ```js
>   // ç¬¬äºŒæ¬¡æ¸²æŸ“æ—¶çš„ JSXï¼ˆroomId ä¸º "general"ï¼‰
>
>   return <h1>Welcome to general!</h1>;
> ```
>
> React çœ‹åˆ°æ¸²æŸ“è¾“å‡ºæ²¡æœ‰æ”¹å˜ï¼Œæ‰€ä»¥å®ƒä¸ä¼šæ›´æ–° DOM ã€‚
>
> ç¬¬äºŒæ¬¡æ¸²æŸ“çš„ Effect å¦‚ä¸‹æ‰€ç¤ºï¼š
>
> ```js
>   // ç¬¬äºŒæ¬¡æ¸²æŸ“æ—¶çš„ Effectï¼ˆroomId ä¸º "general"ï¼‰
>
>   () => {
>
>     const connection = createConnection('general');
>
>     connection.connect();
>
>     return () => connection.disconnect();
>
>   },
>
>   // ç¬¬äºŒæ¬¡æ¸²æŸ“æ—¶çš„ä¾èµ–é¡¹ï¼ˆroomId ä¸º "general"ï¼‰
>
>   ['general']
> ```
>
> React å°†ç¬¬äºŒæ¬¡æ¸²æŸ“æ—¶çš„ `['general']` ä¸ç¬¬ä¸€æ¬¡æ¸²æŸ“æ—¶çš„ `['general']` è¿›è¡Œæ¯”è¾ƒã€‚**å› ä¸ºæ‰€æœ‰çš„ä¾èµ–é¡¹éƒ½æ˜¯ç›¸åŒçš„ï¼ŒReact ä¼šå¿½ç•¥ç¬¬äºŒæ¬¡æ¸²æŸ“æ—¶çš„ Effect**ã€‚æ‰€ä»¥æ­¤æ—¶ Effect ä¸ä¼šè¢«è°ƒç”¨ã€‚
>
> - ä¾èµ–é¡¹ä¸åŒæ—¶çš„é‡æ–°æ¸²æŸ“ 
>
> æ¥ä¸‹æ¥ï¼Œç”¨æˆ·å¼€å§‹è®¿é—® `<ChatRoom roomId="travel" />`ã€‚æ³¨æ„è¿™é‡Œ `roomId` çš„å±æ€§å€¼æ”¹ä¸ºäº† `'travel'`ï¼Œè¿”å›çš„æ˜¯ä¸åŒçš„ JSX è¾“å‡ºç»“æœï¼š
>
> ```js
>   // ç¬¬ä¸‰æ¬¡æ¸²æŸ“æ—¶çš„ JSXï¼ˆroomId ä¸º "travel"ï¼‰
>
>   return <h1>æ¬¢è¿æ¥åˆ° travelï¼</h1>;
> ```
>
> è¿™æ—¶çš„ React ä¼šæ›´æ–° DOM ï¼Œå°† `"æ¬¢è¿æ¥åˆ° general"` æ›´æ–°ä¸º `"æ¬¢è¿æ¥åˆ° travel"`ã€‚
>
> ç¬¬ä¸‰æ¬¡æ¸²æŸ“çš„ Effect å¦‚ä¸‹æ‰€ç¤ºï¼š
>
> ```js
>   // ç¬¬ä¸‰æ¬¡æ¸²æŸ“æ—¶çš„ Effectï¼ˆroomId ä¸º "travel"ï¼‰
>
>   () => {
>
>     const connection = createConnection('travel');
>
>     connection.connect();
>
>     return () => connection.disconnect();
>
>   },
>
>   // ç¬¬ä¸‰æ¬¡æ¸²æŸ“æ—¶çš„ä¾èµ–é¡¹ï¼ˆroomId ä¸º "travel"ï¼‰
>
>   ['travel']
> ```
>
> React å°†ç¬¬ä¸‰æ¬¡æ¸²æŸ“æ—¶çš„ `['travel']` ä¸ç¬¬äºŒæ¬¡æ¸²æŸ“æ—¶çš„ `['general']` ç›¸äº’æ¯”è¾ƒã€‚ä¼šå‘ç°ä¾èµ–é¡¹ä¸åŒï¼š`Object.is('travel', 'general')` ä¸º `false`ï¼šæ‰€ä»¥è¿™æ¬¡çš„ Effect ä¸èƒ½è·³è¿‡ã€‚
>
> **åœ¨ React æ‰§è¡Œç¬¬ä¸‰æ¬¡æ¸²æŸ“çš„ Effect ä¹‹å‰ï¼Œå®ƒéœ€è¦æ¸…ç†æœ€è¿‘æ¸²æŸ“çš„ Effect**ã€‚ç¬¬äºŒæ¬¡æ¸²æŸ“çš„ Effect è¢«è·³è¿‡äº†ã€‚æ‰€ä»¥ React éœ€è¦æ¸…ç†ç¬¬ä¸€æ¬¡æ¸²æŸ“æ—¶çš„ Effectã€‚å¦‚æœä½ å›çœ‹ç¬¬ä¸€æ¬¡æ¸²æŸ“çš„ Effectï¼Œä½ å¯ä»¥çœ‹åˆ°ç¬¬ä¸€æ¬¡æ¸²æŸ“æ—¶çš„æ¸…ç†å‡½æ•°éœ€è¦æ‰§è¡Œçš„å†…å®¹ï¼Œæ˜¯åœ¨ `createConnection('general')` æ‰€åˆ›å»ºçš„è¿æ¥ä¸Šè°ƒç”¨ `disconnect()`ã€‚ä¹Ÿå°±æ˜¯ä» `'general'` èŠå¤©å®¤æ–­å¼€è¿æ¥ã€‚
>
> ä¹‹åï¼ŒReact æ‰§è¡Œç¬¬ä¸‰æ¬¡æ¸²æŸ“çš„ Effectã€‚å®ƒè¿æ¥åˆ° `'travel'` èŠå¤©å®¤ã€‚
>
> * ç»„ä»¶å¸è½½ 
>
> æœ€åï¼Œå‡è®¾ç”¨æˆ·ç¦»å¼€äº†å½“å‰é¡µé¢ï¼Œ`ChatRoom` ç»„ä»¶**å°†è¢«å¸è½½æ—¶ï¼ŒReact ä¼šæ‰§è¡Œæœ€è¿‘çš„ Effect çš„æ¸…ç†å‡½æ•°**ï¼Œä¹Ÿå°±æ˜¯ç¬¬ä¸‰æ¬¡æ¸²æŸ“æ—¶ Effect çš„æ¸…ç†å‡½æ•°ã€‚ç¬¬ä¸‰æ¬¡æ¸²æŸ“åå†æ¸…ç†æ—¶ï¼Œæ¸…ç†å‡½æ•°ç ´åäº† `createConnection('travel')` æ–¹æ³•åˆ›å»ºçš„è¿æ¥ã€‚å› æ­¤ï¼Œè¯¥åº”ç”¨ç¨‹åºä¸ `travel` æˆ¿é—´æ–­å¼€äº†è¿æ¥ã€‚





## ä½¿ç”¨è‡ªå®šä¹‰Hookå¤ç”¨é€»è¾‘

React æœ‰ä¸€äº›å†…ç½® Hookï¼Œä¾‹å¦‚ `useState`ï¼Œ`useContext` å’Œ `useEffect`ã€‚æœ‰æ—¶ä½ éœ€è¦ä¸€ä¸ªç”¨é€”æ›´ç‰¹æ®Šçš„ Hookï¼šä¾‹å¦‚è·å–æ•°æ®ï¼Œè®°å½•ç”¨æˆ·æ˜¯å¦åœ¨çº¿æˆ–è€…è¿æ¥èŠå¤©å®¤ã€‚è™½ç„¶ React ä¸­å¯èƒ½æ²¡æœ‰è¿™äº› Hookï¼Œä½†æ˜¯ä½ å¯ä»¥æ ¹æ®åº”ç”¨éœ€æ±‚åˆ›å»ºè‡ªå·±çš„ Hookã€‚

### è‡ªå®šä¹‰ Hookï¼šç»„ä»¶é—´å…±äº«é€»è¾‘

å‡è®¾ä½ æ­£åœ¨å¼€å‘ä¸€æ¬¾é‡åº¦ä¾èµ–ç½‘ç»œçš„åº”ç”¨ï¼ˆå’Œå¤§å¤šæ•°åº”ç”¨ä¸€æ ·ï¼‰ã€‚å½“ç”¨æˆ·ä½¿ç”¨åº”ç”¨æ—¶ç½‘ç»œæ„å¤–æ–­å¼€ï¼Œä½ éœ€è¦æé†’ä»–ã€‚ä½ ä¼šæ€ä¹ˆå¤„ç†å‘¢ï¼Ÿçœ‹ä¸Šå»ç»„ä»¶éœ€è¦ä¸¤ä¸ªä¸œè¥¿ï¼š

1. ä¸€ä¸ªè¿½è¸ªç½‘ç»œæ˜¯å¦åœ¨çº¿çš„ stateã€‚
2. ä¸€ä¸ªè®¢é˜…å…¨å±€ [`online`](https://developer.mozilla.org/zh-CN/docs/Web/API/Window/online_event) å’Œ [`offline`](https://developer.mozilla.org/zh-CN/docs/Web/API/Window/offline_event) äº‹ä»¶å¹¶æ›´æ–°ä¸Šè¿° state çš„ Effectã€‚

è¿™ä¼šè®©ç»„ä»¶ä¸ç½‘ç»œçŠ¶æ€ä¿æŒ [åŒæ­¥](https://zh-hans.react.dev/learn/synchronizing-with-effects)ã€‚ä½ ä¹Ÿè®¸å¯ä»¥åƒè¿™æ ·å¼€å§‹

```jsx
import { useState, useEffect } from 'react';

export default function StatusBar() {
  const [isOnline, setIsOnline] = useState(true);
  useEffect(() => {
    function handleOnline() {
      setIsOnline(true);
    }
    function handleOffline() {
      setIsOnline(false);
    }
    window.addEventListener('online', handleOnline);
    window.addEventListener('offline', handleOffline);
    return () => {
      window.removeEventListener('online', handleOnline);
      window.removeEventListener('offline', handleOffline);
    };
  }, []);

  return <h1>{isOnline ? 'âœ… Online' : 'âŒ Disconnected'}</h1>;
}

```

å‡è®¾ç°åœ¨ä½ æƒ³åœ¨å¦ä¸€ä¸ªä¸åŒçš„ç»„ä»¶é‡Œ **ä¹Ÿ** ä½¿ç”¨åŒæ ·çš„é€»è¾‘ã€‚ä½ å¸Œæœ›å®ç°ä¸€ä¸ªä¿å­˜æŒ‰é’®ï¼Œæ¯å½“ç½‘ç»œæ–­å¼€è¿™ä¸ªæŒ‰é’®å°±ä¼šä¸å¯ç”¨å¹¶ä¸”æ˜¾ç¤ºâ€œReconnectingâ€¦â€è€Œä¸æ˜¯â€œSave progressâ€ã€‚

ä½ å¯ä»¥ä»å¤åˆ¶ç²˜è´´ `isOnline` state å’Œ Effect åˆ° `SaveButton` ç»„ä»¶å¼€å§‹ï¼š

```jsx
import { useState, useEffect } from 'react';

export default function SaveButton() {
  const [isOnline, setIsOnline] = useState(true);
  useEffect(() => {
    function handleOnline() {
      setIsOnline(true);
    }
    function handleOffline() {
      setIsOnline(false);
    }
    window.addEventListener('online', handleOnline);
    window.addEventListener('offline', handleOffline);
    return () => {
      window.removeEventListener('online', handleOnline);
      window.removeEventListener('offline', handleOffline);
    };
  }, []);

  function handleSaveClick() {
    console.log('âœ… Progress saved');
  }

  return (
    <button disabled={!isOnline} onClick={handleSaveClick}>
      {isOnline ? 'Save progress' : 'Reconnecting...'}
    </button>
  );
}

```

è¿™ä¸¤ä¸ªç»„ä»¶éƒ½èƒ½å¾ˆå¥½åœ°å·¥ä½œï¼Œä½†ä¸å¹¸çš„æ˜¯ä»–ä»¬çš„é€»è¾‘é‡å¤äº†ã€‚ä»–ä»¬çœ‹ä¸Šå»æœ‰ä¸åŒçš„ **è§†è§‰å¤–è§‚**ï¼Œä½†ä½ ä¾ç„¶æƒ³å¤ç”¨ä»–ä»¬çš„é€»è¾‘ã€‚



### ä»ç»„ä»¶ä¸­æå–è‡ªå®šä¹‰Hook

å‡è®¾æœ‰ä¸€ä¸ªå†…ç½® Hook `useOnlineStatus`ï¼Œå®ƒä¸ [`useState`](https://zh-hans.react.dev/reference/react/useState) å’Œ [`useEffect`](https://zh-hans.react.dev/reference/react/useEffect) ç›¸ä¼¼ã€‚é‚£ä¹ˆä½ å°±å¯ä»¥ç®€åŒ–è¿™ä¸¤ä¸ªç»„ä»¶å¹¶ç§»é™¤ä»–ä»¬ä¹‹é—´çš„é‡å¤éƒ¨åˆ†ï¼š

```jsx
function StatusBar() {
  const isOnline = useOnlineStatus();
  return <h1>{isOnline ? 'âœ… Online' : 'âŒ Disconnected'}</h1>;
}

function SaveButton() {
  const isOnline = useOnlineStatus();

  function handleSaveClick() {
    console.log('âœ… Progress saved');
  }

  return (
    <button disabled={!isOnline} onClick={handleSaveClick}>
      {isOnline ? 'Save progress' : 'Reconnecting...'}
    </button>
  );
}
```



å°½ç®¡ç›®å‰è¿˜æ²¡æœ‰è¿™æ ·çš„å†…ç½® Hookï¼Œä½†æ˜¯ä½ å¯ä»¥è‡ªå·±å†™ã€‚å£°æ˜ä¸€ä¸ª `useOnlineStatus` å‡½æ•°ï¼Œå¹¶æŠŠç»„ä»¶é‡Œæ—©å‰å†™çš„æ‰€æœ‰é‡å¤ä»£ç ç§»å…¥è¯¥å‡½æ•°ï¼š

```jsx
function useOnlineStatus() {
  const [isOnline, setIsOnline] = useState(true);
  useEffect(() => {
    function handleOnline() {
      setIsOnline(true);
    }
    function handleOffline() {
      setIsOnline(false);
    }
    window.addEventListener('online', handleOnline);
    window.addEventListener('offline', handleOffline);
    return () => {
      window.removeEventListener('online', handleOnline);
      window.removeEventListener('offline', handleOffline);
    };
  }, []);
  return isOnline;
}
```

åœ¨å‡½æ•°ç»“å°¾å¤„è¿”å› `isOnline`ã€‚è¿™å¯ä»¥è®©ç»„ä»¶è¯»å–åˆ°è¯¥å€¼ï¼š

è¿™æ ·åœ¨éœ€è¦ä½¿ç”¨åˆ°è¯¥Hookçš„åœ°æ–¹ç›´æ¥å¯¼å…¥ä½¿ç”¨å³å¯

```jsx
import { useOnlineStatus } from './useOnlineStatus.js';

function StatusBar() {
  const isOnline = useOnlineStatus();
  return <h1>{isOnline ? 'âœ… Online' : 'âŒ Disconnected'}</h1>;
}

function SaveButton() {
  const isOnline = useOnlineStatus();

  function handleSaveClick() {
    console.log('âœ… Progress saved');
  }

  return (
    <button disabled={!isOnline} onClick={handleSaveClick}>
      {isOnline ? 'Save progress' : 'Reconnecting...'}
    </button>
  );
}

export default function App() {
  return (
    <>
      <SaveButton />
      <StatusBar />
    </>
  );
}
```

ç°åœ¨ç»„ä»¶é‡Œæ²¡æœ‰é‚£ä¹ˆå¤šçš„é‡å¤é€»è¾‘äº†ã€‚**æ›´é‡è¦çš„æ˜¯ï¼Œç»„ä»¶å†…éƒ¨çš„ä»£ç æè¿°çš„æ˜¯æƒ³è¦åšä»€ä¹ˆï¼ˆä½¿ç”¨åœ¨çº¿çŠ¶æ€ï¼ï¼‰ï¼Œè€Œä¸æ˜¯æ€ä¹ˆåšï¼ˆé€šè¿‡è®¢é˜…æµè§ˆå™¨äº‹ä»¶å®Œæˆï¼‰**ã€‚

å½“æå–é€»è¾‘åˆ°è‡ªå®šä¹‰ Hook æ—¶ï¼Œä½ å¯ä»¥éšè—å¦‚ä½•å¤„ç†å¤–éƒ¨ç³»ç»Ÿæˆ–è€…æµè§ˆå™¨ API è¿™äº›ä¹±ä¸ƒå…«ç³Ÿçš„ç»†èŠ‚ã€‚ç»„ä»¶å†…éƒ¨çš„ä»£ç è¡¨è¾¾çš„æ˜¯ç›®æ ‡è€Œä¸æ˜¯å…·ä½“å®ç°ã€‚



### Hookçš„åç§°å¿…é¡»æ°¸è¿œä»¥`use`å¼€å¤´

React åº”ç”¨æ˜¯ç”±ç»„ä»¶æ„æˆï¼Œè€Œç»„ä»¶ç”±å†…ç½®æˆ–è‡ªå®šä¹‰ Hook æ„æˆã€‚å¯èƒ½ä½ ç»å¸¸ä½¿ç”¨åˆ«äººå†™çš„è‡ªå®šä¹‰ Hookï¼Œä½†å¶å°”ä¹Ÿè¦è‡ªå·±å†™ï¼

ä½ å¿…é¡»éµå¾ªä»¥ä¸‹è¿™äº›å‘½åå…¬çº¦ï¼š

1. **React ç»„ä»¶åç§°å¿…é¡»ä»¥å¤§å†™å­—æ¯å¼€å¤´**ï¼Œæ¯”å¦‚ `StatusBar` å’Œ `SaveButton`ã€‚React ç»„ä»¶è¿˜éœ€è¦è¿”å›ä¸€äº› React èƒ½å¤Ÿæ˜¾ç¤ºçš„å†…å®¹ï¼Œæ¯”å¦‚ä¸€æ®µ JSXã€‚
2. **Hook çš„åç§°å¿…é¡»ä»¥ use å¼€å¤´ï¼Œç„¶åç´§è·Ÿä¸€ä¸ªå¤§å†™å­—æ¯**ï¼Œå°±åƒå†…ç½®çš„ [`useState`](https://zh-hans.react.dev/reference/react/useState) æˆ–è€…æœ¬æ–‡æ—©å‰çš„è‡ªå®šä¹‰ `useOnlineStatus` ä¸€æ ·ã€‚Hook å¯ä»¥è¿”å›ä»»æ„å€¼ã€‚

è¿™ä¸ªå…¬çº¦ä¿è¯ä½ å§‹ç»ˆèƒ½ä¸€çœ¼è¯†åˆ«å‡ºç»„ä»¶å¹¶ä¸”çŸ¥é“å®ƒçš„ stateï¼ŒEffect ä»¥åŠå…¶ä»–çš„ React ç‰¹æ€§å¯èƒ½â€œéšè—â€åœ¨å“ªé‡Œã€‚ä¾‹å¦‚å¦‚æœä½ åœ¨ç»„ä»¶å†…éƒ¨çœ‹è§ `getColor()` å‡½æ•°è°ƒç”¨ï¼Œå°±å¯ä»¥ç¡®å®šå®ƒé‡Œé¢ä¸å¯èƒ½åŒ…å« React stateï¼Œå› ä¸ºå®ƒçš„åç§°æ²¡æœ‰ä»¥ `use` å¼€å¤´ã€‚ä½†æ˜¯åƒ `useOnlineStatus()` è¿™æ ·çš„å‡½æ•°è°ƒç”¨å°±å¾ˆå¯èƒ½åŒ…å«å¯¹å†…éƒ¨å…¶ä»– Hook çš„è°ƒç”¨ï¼

> tipsï¼š
>
> å¦‚æœä½ ä¸º [React é…ç½®äº†](https://zh-hans.react.dev/learn/editor-setup#linting) ä»£ç æ£€æŸ¥å·¥å…·ï¼Œå®ƒä¼šå¼ºåˆ¶æ‰§è¡Œè¿™ä¸ªå‘½åå…¬çº¦ã€‚ç°åœ¨æ»‘åŠ¨åˆ°ä¸Šé¢çš„ sandboxï¼Œå¹¶å°† `useOnlineStatus` é‡å‘½åä¸º `getOnlineStatus`ã€‚æ³¨æ„æ­¤æ—¶ä»£ç æ£€æŸ¥å·¥å…·å°†ä¸ä¼šå†å…è®¸ä½ åœ¨å…¶å†…éƒ¨è°ƒç”¨ `useState` æˆ–è€… `useEffect`ã€‚åªæœ‰ Hook å’Œç»„ä»¶å¯ä»¥è°ƒç”¨å…¶ä»– Hookï¼

> æ¸²æŸ“æœŸé—´è°ƒç”¨çš„æ‰€æœ‰å‡½æ•°éƒ½åº”è¯¥ä»¥ use å‰ç¼€å¼€å¤´ä¹ˆï¼Ÿ 
>
> ä¸ã€‚æ²¡æœ‰ **è°ƒç”¨** Hook çš„å‡½æ•°ä¸éœ€è¦ **å˜æˆ** Hookã€‚
>
> å¦‚æœä½ åˆ›å»ºçš„å‡½æ•°æ²¡æœ‰è°ƒç”¨ä»»ä½• Hook æ–¹æ³•ï¼Œåœ¨å‘½åæ—¶åº”é¿å…ä½¿ç”¨ `use` å‰ç¼€ï¼ŒæŠŠå®ƒå½“æˆä¸€ä¸ªå¸¸è§„å‡½æ•°å»å‘½åã€‚å¦‚ä¸‹æ¡ˆä¾‹ä¸­çš„ `useSorted` å‡½æ•°å°±æ²¡æœ‰è°ƒç”¨ä»»ä½• Hook æ–¹æ³•ï¼Œæ‰€ä»¥æ›´æ¨èç”¨ `getSorted` æ¥å‘½åï¼š
>
> ```js
> // ğŸ”´ Avoid: æ²¡æœ‰è°ƒç”¨å…¶ä»–Hookçš„Hook
>
> function useSorted(items) {
>
>   return items.slice().sort();
>
> }
>
>
>
> // âœ… Good: æ²¡æœ‰ä½¿ç”¨Hookçš„å¸¸è§„å‡½æ•°
>
> function getSorted(items) {
>
>   return items.slice().sort();
>
> }
> ```
>
> è¿™ä¿è¯ä½ çš„ä»£ç å¯ä»¥åœ¨åŒ…å«æ¡ä»¶è¯­å¥åœ¨å†…çš„ä»»ä½•åœ°æ–¹è°ƒç”¨è¿™ä¸ªå¸¸è§„å‡½æ•°ï¼š
>
> ```js
> function List({ items, shouldSort }) {
>
>   let displayedItems = items;
>
>   if (shouldSort) {
>
>     // âœ… åœ¨æ¡ä»¶åˆ†æ”¯é‡Œè°ƒç”¨getSorted()æ˜¯æ²¡é—®é¢˜çš„ï¼Œå› ä¸ºå®ƒä¸æ˜¯Hook
>
>     displayedItems = getSorted(items);
>
>   }
>
>   // ...
>
> }
> ```
>
> å“ªæ€•å†…éƒ¨åªä½¿ç”¨äº†ä¸€ä¸ª Hookï¼Œä½ ä¹Ÿåº”è¯¥ç»™è¿™ä¸ªå‡½æ•°åŠ  `use` å‰ç¼€ï¼ˆè®©å®ƒæˆä¸ºä¸€ä¸ª Hookï¼‰ï¼š
>
> ```js
> // âœ… Good: ä¸€ä¸ªä½¿ç”¨äº†å…¶ä»–Hookçš„Hook
>
> function useAuth() {
>
>   return useContext(Auth);
>
> }
> ```
>
> æŠ€æœ¯ä¸Š React å¯¹æ­¤å¹¶ä¸å¼ºåˆ¶è¦æ±‚ã€‚åŸåˆ™ä¸Šä½ å¯ä»¥å†™å‡ºä¸è°ƒç”¨å…¶ä»– Hook çš„ Hookã€‚ä½†è¿™å¸¸å¸¸ä¼šéš¾ä»¥ç†è§£ä¸”å—é™ï¼Œæ‰€ä»¥æœ€å¥½é¿å…è¿™ç§æ–¹å¼ã€‚ä½†æ˜¯å®ƒåœ¨æå°‘æ•°åœºæ™¯ä¸‹å¯èƒ½æ˜¯æœ‰ç›Šçš„ã€‚ä¾‹å¦‚å‡½æ•°ç›®å‰ä¹Ÿè®¸å¹¶æ²¡æœ‰ä½¿ç”¨ä»»ä½• Hookï¼Œä½†æ˜¯ä½ è®¡åˆ’æœªæ¥åœ¨è¯¥å‡½æ•°å†…éƒ¨æ·»åŠ ä¸€äº› Hook è°ƒç”¨ã€‚é‚£ä¹ˆä½¿ç”¨ `use` å‰ç¼€å‘½åå°±å¾ˆæœ‰æ„ä¹‰ï¼š
>
> ```js
> // âœ… Good: ä¹‹åå¯èƒ½ä½¿ç”¨å…¶ä»–Hookçš„Hook
>
> function useAuth() {
>
>   // TODO: å½“è®¤è¯åŠŸèƒ½å®ç°ä»¥åï¼Œæ›¿æ¢è¿™ä¸€è¡Œï¼š
>
>   // è¿”å› useContext(Auth)ï¼›
>
>   return TEST_USER;
>
> }
> ```
>
> æ¥ä¸‹æ¥ç»„ä»¶å°±ä¸èƒ½åœ¨æ¡ä»¶è¯­å¥é‡Œè°ƒç”¨è¿™ä¸ªå‡½æ•°ã€‚å½“ä½ åœ¨å†…éƒ¨å®é™…æ·»åŠ äº† Hook è°ƒç”¨æ—¶ï¼Œè¿™ä¸€ç‚¹å°†å˜å¾—å¾ˆé‡è¦ã€‚å¦‚æœä½ ï¼ˆç°åœ¨æˆ–è€…ä¹‹åï¼‰æ²¡æœ‰è®¡åˆ’åœ¨å†…éƒ¨ä½¿ç”¨ Hookï¼Œè¯·ä¸è¦è®©å®ƒå˜æˆ Hookã€‚



### è‡ªå®šä¹‰ Hook å…±äº«çš„æ˜¯çŠ¶æ€é€»è¾‘ï¼Œè€Œä¸æ˜¯çŠ¶æ€æœ¬èº« 

ä¹‹å‰çš„ä¾‹å­é‡Œï¼Œå½“ä½ å¼€å¯æˆ–å…³é—­ç½‘ç»œæ—¶ï¼Œä¸¤ä¸ªç»„ä»¶ä¸€èµ·æ›´æ–°äº†ã€‚ä½†æ˜¯ä¸¤ä¸ªç»„ä»¶å…±äº« state å˜é‡ `isOnline` è¿™ç§æƒ³æ³•æ˜¯é”™çš„ã€‚çœ‹è¿™æ®µä»£ç ï¼š

```js
function StatusBar() {

  const isOnline = useOnlineStatus();

  // ...

}



function SaveButton() {

  const isOnline = useOnlineStatus();

  // ...

}
```

å®ƒçš„å·¥ä½œæ–¹å¼å’Œä½ ä¹‹å‰æå–çš„é‡å¤ä»£ç ä¸€æ¨¡ä¸€æ ·ï¼š

```js
function StatusBar() {

  const [isOnline, setIsOnline] = useState(true);

  useEffect(() => {

    // ...

  }, []);

  // ...

}



function SaveButton() {

  const [isOnline, setIsOnline] = useState(true);

  useEffect(() => {

    // ...

  }, []);

  // ...

}
```

**è¿™æ˜¯å®Œå…¨ç‹¬ç«‹çš„ä¸¤ä¸ª state å˜é‡å’Œ Effect**ï¼åªæ˜¯ç¢°å·§åŒä¸€æ—¶é—´å€¼ä¸€æ ·ï¼Œå› ä¸ºä½ ä½¿ç”¨äº†ç›¸åŒçš„å¤–éƒ¨å€¼åŒæ­¥ä¸¤ä¸ªç»„ä»¶ï¼ˆæ— è®ºç½‘ç»œæ˜¯å¦å¼€å¯ï¼‰ã€‚

ä¾‹å¦‚ä¸€ä¸ªè¡¨å•å­˜åœ¨ä¸¤ä¸ªç›¸åŒçš„input

```jsx
import { useState } from 'react';

export default function Form() {
  const [firstName, setFirstName] = useState('Mary');
  const [lastName, setLastName] = useState('Poppins');

  function handleFirstNameChange(e) {
    setFirstName(e.target.value);
  }

  function handleLastNameChange(e) {
    setLastName(e.target.value);
  }

  return (
    <>
      <label>
        First name:
        <input value={firstName} onChange={handleFirstNameChange} />
      </label>
      <label>
        Last name:
        <input value={lastName} onChange={handleLastNameChange} />
      </label>
      <p><b>Good morning, {firstName} {lastName}.</b></p>
    </>
  );
}

```

æ¯ä¸ªè¡¨å•åŸŸéƒ½æœ‰ä¸€éƒ¨åˆ†é‡å¤çš„é€»è¾‘ï¼š

1. éƒ½æœ‰ä¸€ä¸ª stateï¼ˆ`firstName` å’Œ `lastName`ï¼‰ã€‚
2. éƒ½æœ‰ change äº‹ä»¶çš„å¤„ç†å‡½æ•°ï¼ˆ`handleFirstNameChange` å’Œ `handleLastNameChange`ï¼‰ã€‚
3. éƒ½æœ‰ä¸ºè¾“å…¥æ¡†æŒ‡å®š `value` å’Œ `onChange` å±æ€§çš„ JSXã€‚

ä½ å¯ä»¥æå–é‡å¤çš„é€»è¾‘åˆ°è‡ªå®šä¹‰ Hook `useFormInput`ï¼š

```jsx
import { useState } from 'react';

export function useFormInput(initialValue) {
  const [value, setValue] = useState(initialValue);

  function handleChange(e) {
    setValue(e.target.value);
  }

  const inputProps = {
    value: value,
    onChange: handleChange
  };

  return inputProps;
}
// ä½¿ç”¨è¯¥hook
import { useFormInput } from './useFormInput.js';

export default function Form() {
  const firstNameProps = useFormInput('Mary');
  const lastNameProps = useFormInput('Poppins');

  return (
    <>
      <label>
        First name:
        <input {...firstNameProps} />
      </label>
      <label>
        Last name:
        <input {...lastNameProps} />
      </label>
      <p><b>Good morning, {firstNameProps.value} {lastNameProps.value}.</b></p>
    </>
  );
}

```

**è‡ªå®šä¹‰ Hook å…±äº«çš„åªæ˜¯çŠ¶æ€é€»è¾‘è€Œä¸æ˜¯çŠ¶æ€æœ¬èº«ã€‚å¯¹ Hook çš„æ¯ä¸ªè°ƒç”¨å®Œå…¨ç‹¬ç«‹äºå¯¹åŒä¸€ä¸ª Hook çš„å…¶ä»–è°ƒç”¨**ã€‚è¿™å°±æ˜¯ä¸Šé¢ä¸¤ä¸ª sandbox ç»“æœå®Œå…¨ç›¸åŒçš„åŸå› ã€‚å¦‚æœæ„¿æ„ï¼Œä½ å¯ä»¥åˆ’ä¸Šå»è¿›è¡Œæ¯”è¾ƒã€‚æå–è‡ªå®šä¹‰ Hook å‰åç»„ä»¶çš„è¡Œä¸ºæ˜¯ä¸€è‡´çš„ã€‚

å½“ä½ éœ€è¦åœ¨å¤šä¸ªç»„ä»¶ä¹‹é—´å…±äº« state æœ¬èº«æ—¶ï¼Œéœ€è¦ [å°†å˜é‡æå‡å¹¶ä¼ é€’ä¸‹å»](https://react.docschina.org/learn/sharing-state-between-components)ã€‚



### åœ¨Hookä¹‹é—´ä¼ é€’å“åº”å€¼

æ¯å½“ç»„ä»¶é‡æ–°æ¸²æŸ“ï¼Œè‡ªå®šä¹‰ Hook ä¸­çš„ä»£ç å°±ä¼šé‡æ–°è¿è¡Œã€‚è¿™å°±æ˜¯ç»„ä»¶å’Œè‡ªå®šä¹‰ Hook éƒ½ [éœ€è¦æ˜¯çº¯å‡½æ•°](https://react.docschina.org/learn/keeping-components-pure) çš„åŸå› ã€‚æˆ‘ä»¬åº”è¯¥æŠŠè‡ªå®šä¹‰ Hook çš„ä»£ç çœ‹ä½œç»„ä»¶ä¸»ä½“çš„ä¸€éƒ¨åˆ†ã€‚

ç”±äºè‡ªå®šä¹‰ Hook ä¼šéšç€ç»„ä»¶ä¸€èµ·é‡æ–°æ¸²æŸ“ï¼Œæ‰€ä»¥ç»„ä»¶å¯ä»¥ä¸€ç›´æ¥æ”¶åˆ°æœ€æ–°çš„ props å’Œ state

ä¾‹å¦‚ï¼Œç”±å¦‚ä¸‹è¿™æ ·çš„Hook

```jsx
export function useChatRoom({ serverUrl, roomId }) {
  useEffect(() => {
    const options = {
      serverUrl: serverUrl,
      roomId: roomId
    };
    const connection = createConnection(options);
    connection.connect();
    connection.on('message', (msg) => {
      showNotification('New message: ' + msg);
    });
    return () => connection.disconnect();
  }, [roomId, serverUrl]);
}
```

ä½¿ç”¨è¯¥Hook

```jsx
export default function ChatRoom({ roomId }) {
  const [serverUrl, setServerUrl] = useState('https://localhost:1234');

  useChatRoom({
    roomId: roomId,
    serverUrl: serverUrl
  });

  return (
    <>
      <label>
        Server URL:
        <input value={serverUrl} onChange={e => setServerUrl(e.target.value)} />
      </label>
      <h1>Welcome to the {roomId} room!</h1>
    </>
  );
}
```

æ³¨æ„é€»è¾‘ **ä»ç„¶å“åº”** props å’Œ state çš„å˜åŒ–

æ¯æ¬¡ `ChatRoom` ç»„ä»¶é‡æ–°æ¸²æŸ“ï¼Œå®ƒå°±ä¼šä¼ æœ€æ–°çš„ `roomId` å’Œ `serverUrl` åˆ°ä½ çš„ Hook



### æŠŠäº‹ä»¶å¤„ç†å‡½æ•°ä¼ é€’åˆ°è‡ªå®šä¹‰Hookä¸­ï¼ˆå®éªŒæ€§ï¼‰

çœ‹ä¸‹é¢è¿™ä¸ªä¾‹å­æˆ‘ä»¬å¯ä»¥ç†è§£`useEffectEvent`çš„ä½œç”¨ï¼š

```jsx
/// app.js
import { useCounter } from './useCounter.js';
import { useInterval } from './useInterval.js';

export default function Counter() {
  const count = useCounter(1000);

  useInterval(() => {
    const randomColor = `hsla(${Math.random() * 360}, 100%, 50%, 0.2)`;
    document.body.style.backgroundColor = randomColor;
  }, 2000);

  return <h1>Seconds passed: {count}</h1>;
}

// useCounter.js
import { useState } from 'react';
import { useInterval } from './useInterval.js';

export function useCounter(delay) {
  const [count, setCount] = useState(0);
  useInterval(() => {
    setCount(c => c + 1);
  }, delay);
  return count;
}

// useInterval.js
import { useEffect } from 'react';
import { experimental_useEffectEvent as useEffectEvent } from 'react';

export function useInterval(onTick, delay) {
  useEffect(() => {
    console.log('âœ… Setting up an interval with delay ', delay)
    const id = setInterval(onTick, delay);
    return () => {
      console.log('âŒ Clearing an interval with delay ', delay)
      clearInterval(id);
    };
  }, [onTick, delay]);
}
```

å¦‚ä¸Šæˆ‘ä»¬è‡ªå®šä¹‰äº†ä¸¤ä¸ªHookï¼Œä¸€ä¸ªç”¨äºè®¾ç½®ä¸€ä¸ªå®šæ—¶å™¨ï¼Œä¸€ä¸ªç”¨äºæ¯ç§’é€’å¢countå˜é‡ä¸”ä½¿ç”¨äº†å®šæ—¶å™¨Hookï¼Œåœ¨é¡¶å±‚ç»„ä»¶appä¸­ä¹Ÿä½¿ç”¨äº†å®šæ—¶å™¨Hookç”¨äºå®šæ—¶è®¾ç½®èƒŒæ™¯é¢œè‰²

å€¼å¾—æ³¨æ„çš„æ˜¯ï¼š`useInterval`Hookä¸­çš„useEffectä¾èµ–ä¼ å…¥çš„ä¸€ä¸ªå›è°ƒå‡½æ•°

è§‚å¯Ÿæ‰“å°å†…å®¹ï¼Œæˆ‘ä»¬ä¸éš¾å‘ç°ï¼Œæ¯è¿‡ä¸€ç§’ï¼Œå°±ä¼šå¯¼è‡´useEffectçš„åŒæ­¥è¡Œä¸ºï¼Œè¿™æ˜¯å› ä¸ºåœ¨useCounterä¸­ä½¿ç”¨useIntervalä¼ å…¥çš„å›è°ƒå‡½æ•°æ›´æ–°äº†stateå˜é‡å¯¼è‡´äº†é¡µé¢é‡æ–°æ¸²æŸ“è¿›è€Œå¯¼è‡´useEffectåŒæ­¥è¡Œä¸ºçš„å‘ç”Ÿ

å› æ­¤æˆ‘ä»¬éœ€è¦ä» Effect çš„ä¾èµ–é¡¹ä¸­åˆ æ‰ `onTick`ã€‚æ¯æ¬¡ç»„ä»¶é‡æ–°æ¸²æŸ“æ—¶ï¼ŒEffect å°†ä¸ä¼šé‡æ–°åŒæ­¥

å¹¶ä¸”ä½¿ç”¨åˆ°è¿™ä¸ªå®éªŒæ€§çš„é’©å­`useEffectEvent`

æœ€ç»ˆä»£ç ï¼š

```js
import { useEffect } from 'react';
import { experimental_useEffectEvent as useEffectEvent } from 'react';

export function useInterval(callback, delay) {
  const onTick = useEffectEvent(callback);
  useEffect(() => {
    const id = setInterval(onTick, delay);
    return () => clearInterval(id);
  }, [delay]);
}

```









### ä»€ä¹ˆæ—¶å€™ä½¿ç”¨è‡ªå®šä¹‰Hook

ä½ æ²¡å¿…è¦å¯¹æ¯æ®µé‡å¤çš„ä»£ç éƒ½æå–è‡ªå®šä¹‰ Hookã€‚ä¸€äº›é‡å¤æ˜¯å¥½çš„ã€‚ä¾‹å¦‚åƒæ—©å‰æå–çš„åŒ…è£¹å•ä¸ª `useState` è°ƒç”¨çš„ `useFormInput` Hook å°±æ˜¯æ²¡æœ‰å¿…è¦çš„ã€‚

ä½†æ˜¯æ¯å½“ä½ å†™ Effect æ—¶ï¼Œè€ƒè™‘ä¸€ä¸‹æŠŠå®ƒåŒ…è£¹åœ¨è‡ªå®šä¹‰ Hook æ˜¯å¦æ›´æ¸…æ™°ã€‚[ä½ ä¸åº”è¯¥ç»å¸¸ä½¿ç”¨ Effect](https://react.docschina.org/learn/you-might-not-need-an-effect)ï¼Œæ‰€ä»¥å¦‚æœä½ æ­£åœ¨å†™ Effect å°±æ„å‘³ç€ä½ éœ€è¦â€œèµ°å‡º Reactâ€å’ŒæŸäº›å¤–éƒ¨ç³»ç»ŸåŒæ­¥ï¼Œæˆ–è€…éœ€è¦åšä¸€äº› React ä¸­æ²¡æœ‰å¯¹åº”å†…ç½® API çš„äº‹ã€‚æŠŠ Effect åŒ…è£¹è¿›è‡ªå®šä¹‰ Hook å¯ä»¥å‡†ç¡®è¡¨è¾¾ä½ çš„ç›®æ ‡ä»¥åŠæ•°æ®åœ¨é‡Œé¢æ˜¯å¦‚ä½•æµåŠ¨çš„ã€‚

ä¾‹å¦‚ï¼Œå‡è®¾ `ShippingForm` ç»„ä»¶å±•ç¤ºä¸¤ä¸ªä¸‹æ‹‰èœå•ï¼šä¸€ä¸ªæ˜¾ç¤ºåŸå¸‚åˆ—è¡¨ï¼Œå¦ä¸€ä¸ªæ˜¾ç¤ºé€‰ä¸­åŸå¸‚çš„åŒºåŸŸåˆ—è¡¨ã€‚ä½ å¯èƒ½ä¸€å¼€å§‹ä¼šåƒè¿™æ ·å†™ä»£ç å»åˆ†åˆ«è¯·æ±‚ä¸¤ä¸ªåˆ—è¡¨æ•°æ®

```jsx
function ShippingForm({ country }) {
  const [cities, setCities] = useState(null);
  // è¿™ä¸ª Effect æ‹‰å–ä¸€ä¸ªå›½å®¶çš„åŸå¸‚æ•°æ®
  useEffect(() => {
    let ignore = false;
    fetch(`/api/cities?country=${country}`)
      .then(response => response.json())
      .then(json => {
        if (!ignore) {
          setCities(json);
        }
      });
    return () => {
      ignore = true;
    };
  }, [country]);

  const [city, setCity] = useState(null);
  const [areas, setAreas] = useState(null);
  // è¿™ä¸ª Effect æ‹‰å–é€‰ä¸­åŸå¸‚çš„åŒºåŸŸåˆ—è¡¨
  useEffect(() => {
    if (city) {
      let ignore = false;
      fetch(`/api/areas?city=${city}`)
        .then(response => response.json())
        .then(json => {
          if (!ignore) {
            setAreas(json);
          }
        });
      return () => {
        ignore = true;
      };
    }
  }, [city]);
```

å°½ç®¡è¿™éƒ¨åˆ†ä»£ç æ˜¯é‡å¤çš„ï¼Œä½†æ˜¯ [æŠŠè¿™äº› Effect å„è‡ªåˆ†å¼€æ˜¯æ­£ç¡®çš„](https://react.docschina.org/learn/removing-effect-dependencies#is-your-effect-doing-several-unrelated-things)ã€‚ä»–ä»¬åŒæ­¥ä¸¤ä»¶ä¸åŒçš„äº‹æƒ…ï¼Œæ‰€ä»¥ä¸åº”è¯¥æŠŠä»–ä»¬åˆå¹¶åˆ°åŒä¸€ä¸ª Effectã€‚è€Œæ˜¯æå–å…¶ä¸­çš„é€šç”¨é€»è¾‘åˆ°ä½ è‡ªå·±çš„ `useData` Hook æ¥ç®€åŒ–ä¸Šé¢çš„ `ShippingForm` ç»„ä»¶ï¼š

```jsx
function useData(url) {
  const [data, setData] = useState(null);
  useEffect(() => {
    if (url) {
      let ignore = false;
      fetch(url)
        .then(response => response.json())
        .then(json => {
          if (!ignore) {
            setData(json);
          }
        });
      return () => {
        ignore = true;
      };
    }
  }, [url]);
  return data;
}
```

ç°åœ¨ä½ å¯ä»¥åœ¨ `ShippingForm` ç»„ä»¶ä¸­è°ƒç”¨ `useData` æ›¿æ¢ä¸¤ä¸ª Effectï¼š

```jsx
function ShippingForm({ country }) {

  const cities = useData(`/api/cities?country=${country}`);

  const [city, setCity] = useState(null);

  const areas = useData(city ? `/api/areas?city=${city}` : null);

  // ...
    
```

æå–è‡ªå®šä¹‰ Hook è®©æ•°æ®æµæ¸…æ™°ã€‚è¾“å…¥ `url`ï¼Œå°±ä¼šè¾“å‡º `data`ã€‚é€šè¿‡æŠŠ Effect â€œéšè—â€åœ¨ `useData` å†…éƒ¨ï¼Œä½ ä¹Ÿå¯ä»¥é˜²æ­¢ä¸€äº›æ­£åœ¨å¤„ç† `ShippingForm` ç»„ä»¶çš„äººå‘é‡Œé¢æ·»åŠ  [ä¸å¿…è¦çš„ä¾èµ–](https://react.docschina.org/learn/removing-effect-dependencies)ã€‚éšç€æ—¶é—´çš„æ¨ç§»ï¼Œåº”ç”¨ä¸­å¤§éƒ¨åˆ† Effect éƒ½ä¼šå­˜åœ¨äºè‡ªå®šä¹‰ Hook å†…éƒ¨ã€‚

**å¥½çš„è‡ªå®šä¹‰ Hook é€šè¿‡é™åˆ¶åŠŸèƒ½ä½¿ä»£ç è°ƒç”¨æ›´å…·å£°æ˜æ€§**ã€‚ä¾‹å¦‚ `useChatRoom(options)` åªèƒ½è¿æ¥èŠå¤©å®¤ï¼Œè€Œ `useImpressionLog(eventName, extraData)` åªèƒ½å‘åˆ†æç³»ç»Ÿå‘é€å±•ç¤ºæ—¥å¿—ã€‚å¦‚æœä½ çš„è‡ªå®šä¹‰ Hook API æ²¡æœ‰çº¦æŸç”¨ä¾‹ä¸”éå¸¸æŠ½è±¡ï¼Œé‚£ä¹ˆåœ¨é•¿æœŸçš„è¿è¡Œä¸­ï¼Œå®ƒå¼•å…¥çš„é—®é¢˜å¯èƒ½æ¯”è§£å†³çš„é—®é¢˜æ›´å¤šã€‚



### è‡ªå®šä¹‰ Hook å¸®åŠ©ä½ è¿ç§»åˆ°æ›´å¥½çš„æ¨¡å¼ 

Effect æ˜¯ä¸€ä¸ª [è„±å›´æœºåˆ¶](https://react.docschina.org/learn/escape-hatches)ï¼šå½“éœ€è¦â€œèµ°å‡º Reactâ€ä¸”ç”¨ä¾‹æ²¡æœ‰æ›´å¥½çš„å†…ç½®è§£å†³æ–¹æ¡ˆæ—¶ä½ å¯ä»¥ä½¿ç”¨ä»–ä»¬ã€‚éšç€æ—¶é—´çš„æ¨ç§»ï¼ŒReact å›¢é˜Ÿçš„ç›®æ ‡æ˜¯é€šè¿‡ç»™æ›´å…·ä½“çš„é—®é¢˜æä¾›æ›´å…·ä½“çš„è§£å†³æ–¹æ¡ˆæ¥æœ€å°åŒ–åº”ç”¨ä¸­çš„ Effect æ•°é‡ã€‚æŠŠä½ çš„ Effect åŒ…è£¹è¿›è‡ªå®šä¹‰ Hookï¼Œå½“è¿™äº›è§£å†³æ–¹æ¡ˆå¯ç”¨æ—¶å‡çº§ä»£ç ä¼šæ›´åŠ å®¹æ˜“ã€‚

åœ¨å‰é¢çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬å»ºç«‹äº†ä¸€ä¸ªå…³äºç½‘ç»œçŠ¶æ€çš„Hookï¼Œä½†å¹¶ä¸æ˜¯æœ€å¥½çš„è§£å†³æ–¹æ¡ˆï¼Œå› ä¸ºå­˜åœ¨è¾¹ç•Œç”¨ä¾‹ï¼šä¾‹å¦‚å½“ç»„ä»¶åŠ è½½æ—¶`isOnline`å·²ç»ä¸ºtrueä½†æ˜¯å¦‚æœåœ¨ç›‘å¬å™¨æ³¨å†Œä¹‹å‰ç½‘ç»œå·²ç»ç¦»çº¿ï¼Œé‚£ä¹ˆè¿™å°±æ˜¯é”™è¯¯çš„ï¼Œå¯ä»¥ä½¿ç”¨æµè§ˆå™¨ [`navigator.onLine`](https://developer.mozilla.org/en-US/docs/Web/API/Navigator/onLine) API æ¥æ£€æŸ¥

å¹¸è¿çš„æ˜¯ï¼ŒReact 18 åŒ…å«äº†ä¸€ä¸ªå«åš [`useSyncExternalStore`](https://react.docschina.org/reference/react/useSyncExternalStore) çš„ä¸“ç”¨ APIï¼Œå®ƒå¯ä»¥è§£å†³ä½ æ‰€æœ‰è¿™äº›é—®é¢˜ã€‚è¿™é‡Œå±•ç¤ºäº†å¦‚ä½•åˆ©ç”¨è¿™ä¸ªæ–° API æ¥é‡å†™ä½ çš„ `useOnlineStatus` Hookï¼š

```jsx
import { useSyncExternalStore } from 'react';

function subscribe(callback) {
  window.addEventListener('online', callback);
  window.addEventListener('offline', callback);
  return () => {
    window.removeEventListener('online', callback);
    window.removeEventListener('offline', callback);
  };
}

export function useOnlineStatus() {
  return useSyncExternalStore(
    subscribe,
    () => navigator.onLine, // å¦‚ä½•åœ¨å®¢æˆ·ç«¯è·å–å€¼
    () => true // å¦‚ä½•åœ¨æœåŠ¡ç«¯è·å–å€¼
  );
}

```

è€Œè¿™é‡Œæˆ‘ä»¬éœ€è¦å­¦ä¹ åˆ°çš„é‡ç‚¹åœ¨äºï¼š**ä½ ä¸éœ€è¦ä¿®æ”¹ä»»ä½•ç»„ä»¶** å°±èƒ½å®Œæˆè¿™æ¬¡æ”¹è¿›

è¿™æ˜¯æŠŠ Effect åŒ…è£¹è¿›è‡ªå®šä¹‰ Hook æœ‰ç›Šçš„å¦ä¸€ä¸ªåŸå› ï¼š

1. ä½ è®©è¿›å‡º Effect çš„æ•°æ®æµéå¸¸æ¸…æ™°ã€‚
2. ä½ è®©ç»„ä»¶ä¸“æ³¨äºç›®æ ‡ï¼Œè€Œä¸æ˜¯ Effect çš„å‡†ç¡®å®ç°ã€‚
3. å½“ React å¢åŠ æ–°ç‰¹æ€§æ—¶ï¼Œä½ å¯ä»¥åœ¨ä¸ä¿®æ”¹ä»»ä½•ç»„ä»¶çš„æƒ…å†µä¸‹ç§»é™¤è¿™äº› Effectã€‚

å’Œ [è®¾è®¡ç³»ç»Ÿ](https://uxdesign.cc/everything-you-need-to-know-about-design-systems-54b109851969) ç›¸ä¼¼ï¼Œä½ å¯èƒ½ä¼šå‘ç°ä»åº”ç”¨çš„ç»„ä»¶ä¸­æå–é€šç”¨é€»è¾‘åˆ°è‡ªå®šä¹‰ Hook æ˜¯éå¸¸æœ‰å¸®åŠ©çš„ã€‚è¿™ä¼šè®©ä½ çš„ç»„ä»¶ä»£ç ä¸“æ³¨äºç›®æ ‡ï¼Œå¹¶ä¸”é¿å…ç»å¸¸å†™åŸå§‹ Effectã€‚è®¸å¤šå¾ˆæ£’çš„è‡ªå®šä¹‰ Hook æ˜¯ç”± React ç¤¾åŒºç»´æŠ¤çš„ã€‚